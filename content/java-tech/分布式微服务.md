## åˆ†å¸ƒå¼&å¾®æœåŠ¡

### **æœåŠ¡æ²»ç†ï¼šä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡æ³¨å†Œä¸Žå‘çŽ°ï¼Ÿ**

æœåŠ¡æ³¨å†Œä¸Žå‘çŽ°æ˜¯åˆ†å¸ƒå¼ä»¥åŠå¾®æœåŠ¡ç³»ç»Ÿçš„åŸºçŸ³ï¼Œæžæ‡‚å®ƒçš„ä½œç”¨å’ŒåŸºæœ¬åŽŸç†å¯¹äºŽæˆ‘ä»¬æ¥è¯´éžå¸¸é‡è¦ï¼

#### ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡æ³¨å†Œä¸Žå‘çŽ°ï¼Ÿ

å¾®æœåŠ¡æž¶æž„ä¸‹ï¼Œä¸€ä¸ªç³»ç»Ÿé€šå¸¸ç”±å¤šä¸ªå¾®æœåŠ¡ç»„æˆï¼ˆæ¯”å¦‚ç”µå•†ç³»ç»Ÿå¯èƒ½åˆ†ä¸ºç”¨æˆ·æœåŠ¡ã€å•†å“æœåŠ¡ã€è®¢å•æœåŠ¡ç­‰æœåŠ¡ï¼‰ï¼Œä¸€ä¸ªç”¨æˆ·è¯·æ±‚å¯èƒ½ä¼šéœ€è¦å¤šä¸ªæœåŠ¡å‚ä¸Žï¼Œè¿™äº›æœåŠ¡ä¹‹é—´äº’ç›¸é…åˆä»¥ç»´æŒç³»ç»Ÿçš„æ­£å¸¸è¿è¡Œã€‚

åœ¨æ²¡æœ‰æœåŠ¡æ³¨å†Œä¸Žå‘çŽ°æœºåˆ¶ä¹‹å‰ï¼Œæ¯ä¸ªæœåŠ¡ä¼šå°†å…¶ä¾èµ–çš„å…¶ä»–æœåŠ¡çš„åœ°å€ä¿¡æ¯å†™æ­»åœ¨é…ç½®æ–‡ä»¶é‡Œï¼ˆå‚è€ƒå•ä½“æž¶æž„ï¼‰ã€‚å‡è®¾æˆ‘ä»¬ç³»ç»Ÿä¸­çš„è®¢å•æœåŠ¡è®¿é—®é‡çªç„¶å˜å¤§ï¼Œæˆ‘ä»¬éœ€è¦å¯¹è®¢å•æœåŠ¡è¿›è¡Œæ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯å¤šéƒ¨ç½²ä¸€äº›è®¢å•æœåŠ¡æ¥åˆ†æ‹…å¤„ç†è¯·æ±‚çš„åŽ‹åŠ›ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ›´æ–°æ‰€æœ‰ä¾èµ–è®¢å•æœåŠ¡çš„æœåŠ¡èŠ‚ç‚¹çš„åœ°å€é…ç½®ä¿¡æ¯ã€‚åŒç†ï¼Œå‡è®¾æŸä¸ªè®¢å•æœåŠ¡èŠ‚ç‚¹çªç„¶å®•æœºï¼Œæˆ‘ä»¬åˆè¦æ‰‹åŠ¨æ›´æ–°å¯¹åº”çš„æœåŠ¡èŠ‚ç‚¹ä¿¡æ¯ã€‚æ›´æ–°å®Œæˆä¹‹åŽï¼Œè¿˜è¦æ‰‹åŠ¨é‡å¯è¿™äº›æœåŠ¡ï¼Œæ•´ä¸ªè¿‡ç¨‹éžå¸¸éº»çƒ¦ä¸”å®¹æ˜“å‡ºé”™ã€‚

æœ‰äº†æœåŠ¡æ³¨å†Œä¸Žå‘çŽ°æœºåˆ¶ä¹‹åŽï¼Œå°±ä¸éœ€è¦è¿™ä¹ˆéº»çƒ¦äº†ï¼Œç”±æ³¨å†Œä¸­å¿ƒè´Ÿè´£ç»´æŠ¤å¯ç”¨æœåŠ¡çš„åˆ—è¡¨ï¼Œé€šè¿‡æ³¨å†Œä¸­å¿ƒåŠ¨æ€èŽ·å–å¯ç”¨æœåŠ¡çš„åœ°å€ä¿¡æ¯ã€‚å¦‚æžœæœåŠ¡ä¿¡æ¯å‘ç”Ÿå˜æ›´ï¼Œæ³¨å†Œä¸­å¿ƒä¼šå°†å˜æ›´æŽ¨é€ç»™ç›¸å…³è”çš„æœåŠ¡ï¼Œæ›´æ–°æœåŠ¡åœ°å€ä¿¡æ¯ï¼Œæ— éœ€æ‰‹åŠ¨æ›´æ–°ï¼Œä¹Ÿä¸éœ€è¦é‡å¯æœåŠ¡ï¼Œè¿™äº›å¯¹å¼€å‘è€…æ¥è¯´å®Œå…¨æ˜¯æ— æ„Ÿçš„ã€‚

æœåŠ¡æ³¨å†Œä¸Žå‘çŽ°å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®žçŽ°æœåŠ¡çš„ä¼˜é›…ä¸Šä¸‹çº¿ï¼Œä»Žè€Œå®žçŽ°æœåŠ¡çš„å¼¹æ€§æ‰©ç¼©å®¹ã€‚

é™¤æ­¤ä¹‹å¤–ï¼ŒæœåŠ¡æ³¨å†Œä¸Žå‘çŽ°æœºåˆ¶è¿˜æœ‰ä¸€ä¸ªéžå¸¸é‡è¦çš„åŠŸèƒ½ï¼š**ä¸å¯ç”¨æœåŠ¡å‰”é™¤** ã€‚ç®€å•æ¥è¯´ï¼Œæ³¨å†Œä¸­å¿ƒä¼šé€šè¿‡ **å¿ƒè·³æœºåˆ¶**
æ¥æ£€æµ‹æœåŠ¡æ˜¯å¦å¯ç”¨ï¼Œå¦‚æžœæœåŠ¡ä¸å¯ç”¨çš„è¯ï¼Œæ³¨å†Œä¸­å¿ƒä¼šä¸»åŠ¨å‰”é™¤è¯¥æœåŠ¡å¹¶å°†å˜æ›´æŽ¨é€ç»™ç›¸å…³è”çš„æœåŠ¡ï¼Œæ›´æ–°æœåŠ¡åœ°å€ä¿¡æ¯ã€‚

æœ€åŽï¼Œæˆ‘ä»¬å†æ¥æ€»ç»“è¡¥å……ä¸€ä¸‹ï¼Œä¸€ä¸ªå®Œå¤‡çš„æœåŠ¡æ³¨å†Œä¸Žå‘çŽ°åº”è¯¥å…·å¤‡çš„åŠŸèƒ½ï¼š

- æœåŠ¡æ³¨å†Œä»¥åŠæœåŠ¡æŸ¥è¯¢ï¼ˆæœ€åŸºæœ¬çš„ï¼‰
- æœåŠ¡çŠ¶æ€å˜æ›´é€šçŸ¥ã€æœåŠ¡å¥åº·æ£€æŸ¥ã€ä¸å¯ç”¨æœåŠ¡å‰”é™¤
- æœåŠ¡æƒé‡é…ç½®ï¼ˆæƒé‡è¶Šé«˜è¢«è®¿é—®çš„é¢‘çŽ‡è¶Šé«˜ï¼‰

#### æœåŠ¡æ³¨å†Œä¸Žå‘çŽ°çš„åŸºæœ¬æµç¨‹æ˜¯æ€Žæ ·çš„ï¼Ÿ

> è¿™ä¸ªé—®é¢˜ç­‰ä»·äºŽé—®æœåŠ¡æ³¨å†Œä¸Žå‘çŽ°çš„åŽŸç†ã€‚

æ¯ä¸ªæœåŠ¡èŠ‚ç‚¹åœ¨å¯åŠ¨è¿è¡Œçš„æ—¶å€™ï¼Œä¼šå‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡ï¼Œä¹Ÿå°±æ˜¯å°†è‡ªå·±çš„åœ°å€ä¿¡æ¯ï¼ˆipã€ç«¯å£ä»¥åŠæœåŠ¡åå­—ç­‰ä¿¡æ¯çš„ç»„åˆï¼‰ä¸ŠæŠ¥ç»™æ³¨å†Œä¸­å¿ƒï¼Œæ³¨å†Œä¸­å¿ƒè´Ÿè´£å°†åœ°å€ä¿¡æ¯ä¿å­˜èµ·æ¥ï¼Œè¿™å°±æ˜¯
**æœåŠ¡æ³¨å†Œ**ã€‚

![service-registration.png](é¢è¯•æŒ‡åŒ—.assets/1666275736996-6a3442bd-e8d5-4e4c-9878-1df1c1ef7f08.png)

ä¸€ä¸ªæœåŠ¡èŠ‚ç‚¹å¦‚æžœè¦è°ƒç”¨å¦å¤–ä¸€ä¸ª**æœåŠ¡èŠ‚ç‚¹**ï¼Œä¼šç›´æŽ¥æ‹¿ç€æœåŠ¡çš„ä¿¡æ¯æ‰¾æ³¨å†Œä¸­å¿ƒè¦å¯¹æ–¹çš„åœ°å€ä¿¡æ¯ï¼Œè¿™å°±æ˜¯ æœåŠ¡å‘çŽ°
ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒæœåŠ¡èŠ‚ç‚¹æ‹¿åˆ°åœ°å€ä¿¡æ¯ä¹‹åŽï¼Œè¿˜ä¼šåœ¨æœ¬åœ°ç¼“å­˜ä¸€ä»½ï¼Œä¿è¯åœ¨æ³¨å†Œä¸­å¿ƒå®•æœºæ—¶ä»ç„¶å¯ä»¥æ­£å¸¸è°ƒç”¨æœåŠ¡ã€‚

![service-discovery.png](é¢è¯•æŒ‡åŒ—.assets/1666275749034-48b29e36-6fe9-4915-a0bd-774b79ded766.png)

å¦‚æžœæœåŠ¡ä¿¡æ¯å‘ç”Ÿå˜æ›´ï¼Œæ³¨å†Œä¸­å¿ƒä¼šå°†å˜æ›´æŽ¨é€ç»™ç›¸å…³è”çš„æœåŠ¡ï¼Œæ›´æ–°æœåŠ¡åœ°å€ä¿¡æ¯ã€‚

ä¸ºäº†ä¿è¯æœåŠ¡åœ°å€åˆ—è¡¨ä¸­éƒ½æ˜¯å¯ç”¨æœåŠ¡çš„åœ°å€ä¿¡æ¯ï¼Œæ³¨å†Œä¸­å¿ƒé€šå¸¸ä¼šé€šè¿‡ **å¿ƒè·³æœºåˆ¶**
æ¥æ£€æµ‹æœåŠ¡æ˜¯å¦å¯ç”¨ï¼Œå¦‚æžœæœåŠ¡ä¸å¯ç”¨çš„è¯ï¼Œæ³¨å†Œä¸­å¿ƒä¼šä¸»åŠ¨å‰”é™¤è¯¥æœåŠ¡å¹¶å°†å˜æ›´æŽ¨é€ç»™ç›¸å…³è”çš„æœåŠ¡ï¼Œæ›´æ–°æœåŠ¡åœ°å€ä¿¡æ¯ã€‚

æœ€åŽï¼Œå†æ¥ä¸€å¼ å›¾ç®€å•æ€»ç»“ä¸€ä¸‹æœåŠ¡æ³¨å†Œä¸Žå‘çŽ°ï¼ˆä¸€ä¸ªæœåŠ¡æ—¢å¯èƒ½æ˜¯æœåŠ¡æä¾›è€…ä¹Ÿå¯èƒ½æ˜¯æœåŠ¡æ¶ˆè´¹è€…ï¼‰ã€‚

![service-registration-and-discovery.png](é¢è¯•æŒ‡åŒ—.assets/1666275758824-30812e9e-4bf6-46c7-a17f-9f2e2ea9c175.png)

#### å¸¸è§çš„æ³¨å†Œä¸­å¿ƒæœ‰å“ªäº›ï¼Ÿ

>
æˆ‘è¿™é‡Œè·Ÿå¤šçš„æ˜¯ä»Žé¢è¯•è§’åº¦æ¥è¯´ï¼Œå„ç±»æ³¨å†Œä¸­å¿ƒçš„è¯¦ç»†å¯¹æ¯”ï¼Œå¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š[5 ç§æ³¨å†Œä¸­å¿ƒå¦‚ä½•é€‰åž‹ï¼Ÿä»ŽåŽŸç†ç»™ä½ è§£è¯»ï¼ - æ¥¼ä»” - 2022](https://mp.weixin.qq.com/s?__biz=Mzg3OTU5NzQ1Mw==&mid=2247486918&idx=1&sn=5651cd0b4b9c8e68bcfa55c00c0950d6&chksm=cf034f24f874c632511684057337a744c54702543ec3690aa06dbf4bbaf980b2828f52276c9b&scene=21#wechat_redirect)
ï¼Œéžå¸¸è¯¦ç»†ã€‚

æ¯”è¾ƒå¸¸ç”¨çš„æ³¨å†Œä¸­å¿ƒæœ‰ ZooKeeperã€Eurekaã€Nacosï¼Œè¿™ä¸‰ä¸ªéƒ½æ˜¯ä½¿ç”¨ Java è¯­è¨€å¼€å‘ï¼Œç›¸å¯¹æ¥è¯´ï¼Œæ›´é€‚åˆ Java æŠ€æœ¯æ ˆä¸€äº›ã€‚å…¶ä»–çš„è¿˜æœ‰åƒ
ETCDã€Consulï¼Œè¿™é‡Œå°±ä¸åšä»‹ç»äº†ã€‚

é¦–å…ˆï¼Œå’±ä»¬æ¥çœ‹ ZooKeeperï¼Œå¤§éƒ¨åˆ†åŒå­¦åº”è¯¥å¯¹å®ƒä¸é™Œç”Ÿã€‚ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´ï¼ŒZooKeeper è®¾è®¡ä¹‹åˆå¹¶ä¸æ˜¯æœªæ¥åšæ³¨å†Œä¸­å¿ƒçš„ï¼Œåªæ˜¯å‰å‡ å¹´å›½å†…ä½¿ç”¨
Dubbo çš„åœºæ™¯ä¸‹æ¯”è¾ƒå–œæ¬¢ä½¿ç”¨å®ƒæ¥åšæ³¨å†Œä¸­å¿ƒã€‚

å¯¹äºŽ CAP ç†è®ºæ¥è¯´ï¼Œ**ZooKeeper ä¿è¯çš„æ˜¯ CP**ã€‚ ä»»ä½•æ—¶åˆ»å¯¹ ZooKeeper çš„è¯»è¯·æ±‚éƒ½èƒ½å¾—åˆ°ä¸€è‡´æ€§çš„ç»“æžœï¼Œä½†æ˜¯ï¼Œ ZooKeeper
ä¸ä¿è¯æ¯æ¬¡è¯·æ±‚çš„å¯ç”¨æ€§æ¯”å¦‚åœ¨ Leader é€‰ä¸¾è¿‡ç¨‹ä¸­æˆ–è€…åŠæ•°ä»¥ä¸Šçš„æœºå™¨ä¸å¯ç”¨çš„æ—¶å€™æœåŠ¡å°±æ˜¯ä¸å¯ç”¨çš„ã€‚

**é’ˆå¯¹æ³¨å†Œä¸­å¿ƒè¿™ä¸ªåœºæ™¯æ¥è¯´ï¼Œé‡è¦çš„æ˜¯å¯ç”¨æ€§ï¼ŒAP ä¼šæ›´åˆé€‚ä¸€äº›**ã€‚ ZooKeeper æ›´é€‚åˆåšåˆ†å¸ƒå¼åè°ƒæœï¼Œæ³¨å†Œä¸­å¿ƒå°±äº¤ç»™ä¸“ä¸šçš„æ¥åšå§ï¼

å…¶æ¬¡ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ Eurekaï¼Œä¸€æ¬¾éžå¸¸å€¼å¾—ç ”ç©¶çš„æ³¨å†Œä¸­å¿ƒã€‚Eureka æ˜¯ Netflix å…¬å¸å¼€æºçš„ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒï¼Œé…å¥—çš„è¿˜æœ‰
Feignã€Ribbonã€Zuulã€Hystrix ç­‰çŸ¥åçš„å¾®æœåŠ¡ç³»ç»Ÿæž„å»ºæ‰€å¿…é¡»çš„ç»„ä»¶ã€‚

å¯¹äºŽ CAP ç†è®ºæ¥è¯´ï¼Œ**Eureka ä¿è¯çš„æ˜¯ AP**ã€‚ Eureka é›†ç¾¤åªè¦æœ‰ä¸€å° Eureka
æ­£å¸¸æœåŠ¡ï¼Œæ•´ä¸ªæ³¨å†Œä¸­å¿ƒå°±æ˜¯å¯ç”¨çš„ï¼Œåªæ˜¯æŸ¥è¯¢åˆ°çš„æ•°æ®å¯èƒ½æ˜¯è¿‡æœŸçš„ï¼ˆé›†ç¾¤ä¸­çš„å„ä¸ªèŠ‚ç‚¹å¼‚æ­¥æ–¹å¼åŒæ­¥æ•°æ®ï¼Œä¸ä¿è¯å¼ºä¸€è‡´æ€§ï¼‰ã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fguide-blog-images.oss-cn-shenzhen.aliyuncs.com%2Fgithub%2Fjavaguide%2FSpringCloudNetflix.png)

ä¸è¿‡ï¼Œå¯æƒœçš„æ˜¯ï¼ŒSpring Cloud 2020.0.0 ç‰ˆæœ¬ç§»é™¤äº† Netflix é™¤ Eureka å¤–çš„æ‰€æœ‰ç»„ä»¶ã€‚

**é‚£ä¸ºä»€ä¹ˆ Spring Cloud è¿™ä¹ˆæ€¥ç€ç§»é™¤ Netflix çš„ç»„ä»¶å‘¢ï¼Ÿ** ä¸»è¦æ˜¯å› ä¸ºåœ¨ 2018 å¹´çš„æ—¶å€™ï¼ŒNetflix å®£å¸ƒå…¶å¼€æºçš„æ ¸å¿ƒç»„ä»¶
Hystrixã€Ribbonã€Zuulã€Eureka ç­‰è¿›å…¥ç»´æŠ¤çŠ¶æ€ï¼Œä¸å†è¿›è¡Œæ–°ç‰¹æ€§å¼€å‘ï¼Œåªä¿® BUGã€‚äºŽæ˜¯ï¼ŒSpring å®˜æ–¹ä¸å¾—ä¸è€ƒè™‘ç§»é™¤ Netflix çš„ç»„ä»¶ã€‚

æˆ‘è¿™é‡Œä¹Ÿä¸æŽ¨èä½¿ç”¨ Eureka ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œé˜¿é‡Œå¼€æºçš„ Nacos æˆ–è®¸æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚

æœ€åŽï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ Nacosï¼Œä¸€æ¬¾å³å¯ä»¥ç”¨æ¥åšæ³¨å†Œä¸­å¿ƒï¼Œåˆå¯ä»¥ç”¨æ¥åšé…ç½®ä¸­å¿ƒçš„ä¼˜ç§€é¡¹ç›®ã€‚

Nacos å±žå®žæ˜¯åŽèµ·ä¹‹ç§€ï¼Œå€Ÿé‰´å¸æ”¶äº†å…¶ä»–æ³¨å†Œä¸­å¿ƒçš„æœ‰ç‚¹ï¼Œä¸Ž Spring Boot ã€Dubboã€Spring Cloudã€Kubernetes æ— ç¼å¯¹æŽ¥ï¼Œå…¼å®¹æ€§å¾ˆå¥½ã€‚å¹¶ä¸”ï¼Œ
**Nacos ä¸ä»…æ”¯æŒ CP ä¹Ÿæ”¯æŒ AP**ã€‚

Nacos æ€§èƒ½å¼ºæ‚ï¼ˆæ¯” Eureka èƒ½æ”¯æŒæ›´å¤šçš„æœåŠ¡å®žä¾‹ï¼‰ï¼Œæ˜“ç”¨æ€§è¾ƒå¼ºï¼ˆæ–‡æ¡£ä¸°å¯Œã€æ•°æ®æ¨¡åž‹ç®€å•ä¸”è‡ªå¸¦åŽå°ç®¡ç†ç•Œé¢ï¼‰ï¼Œæ”¯æŒ 99.9% é«˜å¯ç”¨ã€‚

å¯¹äºŽ Java æŠ€æœ¯æ ˆæ¥è¯´ï¼Œä¸ªäººæ˜¯æ¯”è¾ƒæŽ¨èä½¿ç”¨ Nacos æ¥åšæ³¨å†Œä¸­å¿ƒã€‚

### **æœåŠ¡æ²»ç†ï¼šåˆ†å¸ƒå¼ä¸‹å¦‚ä½•è¿›è¡Œé…ç½®ç®¡ç†ï¼Ÿ**

#### ä¸ºä»€ä¹ˆè¦ç”¨é…ç½®ä¸­å¿ƒï¼Ÿ

å¾®æœåŠ¡ä¸‹ï¼Œä¸šåŠ¡çš„å‘å±•ä¸€èˆ¬ä¼šå¯¼è‡´æœåŠ¡æ•°é‡çš„å¢žåŠ ï¼Œè¿›è€Œå¯¼è‡´ç¨‹åºé…ç½®ï¼ˆæœåŠ¡åœ°å€ã€æ•°æ®åº“å‚æ•°ç­‰ç­‰ï¼‰å¢žå¤šã€‚ä¼ ç»Ÿçš„é…ç½®æ–‡ä»¶çš„æ–¹å¼å·²ç»æ— æ³•æ»¡è¶³å½“å‰éœ€æ±‚ï¼Œä¸»è¦æœ‰ä¸‹é¢å‡ ç‚¹åŽŸå› ï¼š

- å®‰å…¨æ€§å¾—ä¸åˆ°ä¿éšœï¼šé…ç½®æ”¾åœ¨ä»£ç åº“ä¸­å®¹æ˜“æ³„éœ²ã€‚
- æ—¶æ•ˆæ€§ä¸è¡Œï¼šä¿®æ”¹é…ç½®éœ€è¦é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆã€‚
- ä¸æ”¯æŒæƒé™æŽ§åˆ¶ ï¼šæ²¡æœ‰å¯¹é…ç½®çš„ä¿®æ”¹ã€å‘å¸ƒç­‰æ“ä½œè¿›è¡Œä¸¥æ ¼çš„æƒé™æŽ§åˆ¶ã€‚
- ä¸æ”¯æŒé…ç½®é›†ä¸­ç®¡ç† ï¼š é…ç½®æ–‡ä»¶è¿‡äºŽåˆ†æ•£ï¼Œä¸æ–¹ä¾¿ç®¡ç†ã€‚
- ......

å¦å¤–ï¼Œé…ç½®ä¸­å¿ƒé€šå¸¸ä¼šè‡ªå¸¦ç‰ˆæœ¬è·Ÿè¸ªï¼Œä¼šè®°å½•é…ç½®çš„ä¿®æ”¹è®°å½•ï¼Œè®°å½•çš„å†…å®¹åŒ…æ‹¬ä¿®æ”¹äººã€ä¿®æ”¹æ—¶é—´ã€ä¿®æ”¹å†…å®¹ç­‰ç­‰ã€‚

è™½ç„¶é€šè¿‡ Git ç‰ˆæœ¬ç®¡ç†æˆ‘ä»¬ä¹Ÿèƒ½è¿½æº¯é…ç½®çš„ä¿®æ”¹è®°å½•ï¼Œä½†æ˜¯é…ç½®ä¸­å¿ƒæä¾›çš„é…ç½®ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½æ›´å…¨é¢ã€‚å¹¶ä¸”ï¼Œé…ç½®ä¸­å¿ƒé€šå¸¸ä¼šåœ¨é…ç½®ç‰ˆæœ¬ç®¡ç†çš„åŸºç¡€ä¸Šæ”¯æŒé…ç½®ä¸€é”®å›žæ»šã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fcdn.jsdelivr.net%2Fgh%2Fapolloconfig%2Fapollo%40master%2Fdoc%2Fimages%2Fgray-release%2Fview-release-history.png)

ä¸€äº›åŠŸèƒ½æ›´å…¨é¢çš„é…ç½®ä¸­å¿ƒæ¯”å¦‚`Apollo`ç”šè‡³è¿˜æ”¯æŒç°åº¦å‘å¸ƒã€‚

#### å¸¸è§çš„é…ç½®ä¸­å¿ƒæœ‰å“ªäº›ï¼Ÿ

[Spring Cloud Config](https://cloud.spring.io/spring-cloud-config/reference/html/)ã€[Nacos](https://github.com/alibaba/nacos) ã€[Apollo](https://github.com/apolloconfig/apollo)
ã€K8s ConfigMap ã€[Disconf](https://github.com/knightliao/disconf) ã€[Qconf](https://github.com/Qihoo360/QConf) éƒ½å¯ä»¥ç”¨æ¥åšé…ç½®ä¸­å¿ƒã€‚

Disconf å’Œ Qconf å·²ç»æ²¡æœ‰ç»´æŠ¤ï¼Œç”Ÿæ€ä¹Ÿå¹¶ä¸æ´»è·ƒï¼Œå¹¶ä¸å»ºè®®ä½¿ç”¨ï¼Œåœ¨åšé…ç½®ä¸­å¿ƒæŠ€æœ¯é€‰åž‹çš„æ—¶å€™å¯ä»¥è·³è¿‡ã€‚

å¦‚æžœä½ çš„æŠ€æœ¯é€‰åž‹æ˜¯ Kubernetes çš„è¯ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ K8s ConfigMap æ¥ä½œä¸ºé…ç½®ä¸­å¿ƒã€‚

Apollo å’Œ Nacos æˆ‘ä¸ªäººæ›´å–œæ¬¢ï¼Œä¸¤è€…éƒ½æ˜¯å›½å†…å…¬å¸å¼€æºçš„çŸ¥åé¡¹ç›®ï¼Œé¡¹ç›®ç¤¾åŒºéƒ½æ¯”è¾ƒæ´»è·ƒä¸”éƒ½è¿˜åœ¨ç»´æŠ¤ä¸­ã€‚Nacos æ˜¯é˜¿é‡Œå¼€æºçš„ï¼ŒApollo
æ˜¯æºç¨‹å¼€æºçš„ã€‚Nacos ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œå¹¶ä¸”è¿˜å¯ä»¥ç›´æŽ¥ç”¨æ¥åšæœåŠ¡å‘çŽ°åŠç®¡ç†ã€‚Apollo åªèƒ½ç”¨æ¥åšé…ç½®ç®¡ç†ï¼Œä½¿ç”¨ç›¸å¯¹å¤æ‚ä¸€äº›ã€‚

å¦‚æžœä½ çš„é¡¹ç›®ä»…ä»…éœ€è¦é…ç½®ä¸­å¿ƒçš„è¯ï¼Œå»ºè®®ä½¿ç”¨ Apollo ã€‚å¦‚æžœä½ çš„é¡¹ç›®éœ€è¦é…ç½®ä¸­å¿ƒçš„åŒæ—¶è¿˜éœ€è¦æœåŠ¡å‘çŽ°åŠç®¡ç†çš„è¯ï¼Œé‚£å°±æ›´å»ºè®®ä½¿ç”¨
Nacosã€‚

Spring Cloud Config å±žäºŽ Spring Cloud ç”Ÿæ€ç»„ä»¶ï¼Œå¯ä»¥å’Œ Spring Cloud ä½“ç³»æ— ç¼æ•´åˆã€‚ç”±äºŽåŸºäºŽ Git å­˜å‚¨é…ç½®ï¼Œå› æ­¤ Spring Cloud
Config çš„æ•´ä½“è®¾è®¡å¾ˆç®€å•ã€‚

#### Apollo vs Nacos vs Spring Cloud Config

| åŠŸèƒ½ç‚¹    | Apollo            | Nacos                      | Spring Cloud Config |
|--------|-------------------|----------------------------|---------------------|
| é…ç½®ç•Œé¢   | æ”¯æŒ                | æ”¯æŒ                         | æ— ï¼ˆéœ€è¦é€šè¿‡ Git æ“ä½œï¼‰      |
| é…ç½®å®žæ—¶ç”Ÿæ•ˆ | æ”¯æŒ(HTTP é•¿è½®è¯¢ 1s å†…) | æ”¯æŒ(HTTP é•¿è½®è¯¢ 1s å†…)          | é‡å¯ç”Ÿæ•ˆï¼Œæˆ–æ‰‹åŠ¨ refresh ç”Ÿæ•ˆ |
| ç‰ˆæœ¬ç®¡ç†   | æ”¯æŒ                | æ”¯æŒ                         | æ”¯æŒï¼ˆä¾èµ– Gitï¼‰          |
| æƒé™ç®¡ç†   | æ”¯æŒ                | æ”¯æŒ                         | æ”¯æŒï¼ˆä¾èµ– Gitï¼‰          |
| ç°åº¦å‘å¸ƒ   | æ”¯æŒ                | æ”¯æŒï¼ˆNacos 1.1.0 ç‰ˆæœ¬å¼€å§‹æ”¯æŒç°åº¦é…ç½®ï¼‰ | ä¸æ”¯æŒ                 |
| é…ç½®å›žæ»š   | æ”¯æŒ                | æ”¯æŒ                         | æ”¯æŒï¼ˆä¾èµ– Gitï¼‰          |
| å‘Šè­¦é€šçŸ¥   | æ”¯æŒ                | æ”¯æŒ                         | ä¸æ”¯æŒ                 |
| å¤šè¯­è¨€    | ä¸»æµè¯­è¨€ï¼ŒOpen API     | ä¸»æµè¯­è¨€ï¼ŒOpen API              | åªæ”¯æŒ Spring åº”ç”¨       |
| å¤šçŽ¯å¢ƒ    | æ”¯æŒ                | æ”¯æŒ                         | ä¸æ”¯æŒ                 |
| ç›‘å¬æŸ¥è¯¢   | æ”¯æŒ                | æ”¯æŒ                         | æ”¯æŒ                  |

Apollo å’Œ Nacos æä¾›äº†æ›´å¤šå¼€ç®±å³ç”¨çš„åŠŸèƒ½ï¼Œæ›´é€‚åˆç”¨æ¥ä½œä¸ºé…ç½®ä¸­å¿ƒã€‚

Nacos ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œå¹¶ä¸”è¿˜å¯ä»¥ç›´æŽ¥ç”¨æ¥åšæœåŠ¡å‘çŽ°åŠç®¡ç†ã€‚Apollo åªèƒ½ç”¨æ¥åšé…ç½®ç®¡ç†ï¼Œä½¿ç”¨ç›¸å¯¹å¤æ‚ä¸€äº›ã€‚

Apollo åœ¨é…ç½®ç®¡ç†æ–¹é¢åšçš„æ›´åŠ å…¨é¢ï¼Œå°±æ¯”å¦‚è¯´è™½ç„¶ Nacos åœ¨ 1.1.0 ç‰ˆæœ¬å¼€å§‹æ”¯æŒç°åº¦é…ç½®ï¼Œä½† Nacos çš„ç°åº¦é…ç½®åŠŸèƒ½å®žçŽ°çš„æ¯”è¾ƒç®€å•ï¼ŒApollo
å®žçŽ°çš„ç°åº¦é…ç½®åŠŸèƒ½å°±ç›¸å¯¹æ›´å®Œå–„ä¸€äº›ã€‚ä¸è¿‡ï¼ŒNacos æä¾›çš„é…ç½®ä¸­å¿ƒåŠŸèƒ½å·²ç»å¯ä»¥æ»¡è¶³ç»å¤§éƒ¨åˆ†é¡¹ç›®çš„éœ€æ±‚äº†ã€‚

#### ä¸€ä¸ªå®Œå¤‡é…ç½®ä¸­å¿ƒéœ€è¦å…·å¤‡å“ªäº›åŠŸèƒ½ï¼Ÿ

å¦‚æžœæˆ‘ä»¬éœ€è¦è‡ªå·±è®¾è®¡ä¸€ä¸ªé…ç½®ä¸­å¿ƒçš„è¯ï¼Œéœ€è¦è€ƒè™‘å“ªäº›ä¸œè¥¿å‘¢ï¼Ÿ

ç®€å•è¯´è¯´æˆ‘çš„çœ‹æ³•ï¼š

- **æƒé™æŽ§åˆ¶** ï¼šé…ç½®çš„ä¿®æ”¹ã€å‘å¸ƒç­‰æ“ä½œéœ€è¦ä¸¥æ ¼çš„æƒé™æŽ§åˆ¶ã€‚
- **æ—¥å¿—è®°å½•** ï¼š é…ç½®çš„ä¿®æ”¹ã€å‘å¸ƒç­‰æ“éœ€è¦è®°å½•å®Œæ•´çš„æ—¥å¿—ï¼Œä¾¿äºŽåŽæœŸæŽ’æŸ¥é—®é¢˜ã€‚
- **é…ç½®æŽ¨é€** ï¼š æŽ¨é€æ¨¡å¼é€šå¸¸ç”±ä¸¤ç§ï¼š
    - æŽ¨ ï¼šå®žæ—¶æ€§å˜æ›´ï¼Œé…ç½®æ›´æ–°åŽæŽ¨é€ç»™åº”ç”¨ã€‚éœ€è¦åº”ç”¨å’Œé…ç½®ä¸­å¿ƒä¿æŒé•¿è¿žæŽ¥ï¼Œå¤æ‚åº¦é«˜ã€‚
    - æ‹‰ ï¼šå®žæ—¶æ€§è¾ƒå·®ï¼Œåº”ç”¨éš”ä¸€æ®µæ—¶é—´æ‰‹åŠ¨æ‹‰å–é…ç½®ã€‚
    - æŽ¨æ‹‰ç»“åˆ
- **ç°åº¦å‘å¸ƒ** ï¼šæ”¯æŒé…ç½®åªæŽ¨ç»™éƒ¨åˆ†åº”ç”¨ã€‚
- **æ˜“æ“ä½œ** ï¼š æä¾› Web ç•Œé¢æ–¹ä¾¿é…ç½®ä¿®æ”¹å’Œå‘å¸ƒã€‚
- **ç‰ˆæœ¬è·Ÿè¸ª** ï¼šæ‰€æœ‰çš„é…ç½®å‘å¸ƒéƒ½æœ‰ç‰ˆæœ¬æ¦‚å¿µï¼Œä»Žè€Œå¯ä»¥æ–¹ä¾¿çš„æ”¯æŒé…ç½®çš„å›žæ»šã€‚
- **æ”¯æŒé…ç½®å›žæ»š** ï¼š æˆ‘ä»¬ä¸€é”®å›žæ»šé…ç½®åˆ°æŒ‡å®šçš„ä½ç½®ï¼Œè¿™ä¸ªéœ€è¦å’Œç‰ˆæœ¬è·Ÿè¸ªç»“åˆä½¿ç”¨ã€‚
- ......

#### **ä»¥ Apollo ä¸ºä¾‹ä»‹ç»é…ç½®ä¸­å¿ƒçš„è®¾è®¡**

##### Apollo ä»‹ç»

æ ¹æ® Apollo å®˜æ–¹ä»‹ç»ï¼š

> [Apollo](https://github.com/ctripcorp/apollo)
> ï¼ˆé˜¿æ³¢ç½—ï¼‰æ˜¯æºç¨‹æ¡†æž¶éƒ¨é—¨ç ”å‘çš„åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼Œèƒ½å¤Ÿé›†ä¸­åŒ–ç®¡ç†åº”ç”¨ä¸åŒçŽ¯å¢ƒã€ä¸åŒé›†ç¾¤çš„é…ç½®ï¼Œé…ç½®ä¿®æ”¹åŽèƒ½å¤Ÿå®žæ—¶æŽ¨é€åˆ°åº”ç”¨ç«¯ï¼Œå¹¶ä¸”å…·å¤‡è§„èŒƒçš„æƒé™ã€æµç¨‹æ²»ç†ç­‰ç‰¹æ€§ï¼Œé€‚ç”¨äºŽå¾®æœåŠ¡é…ç½®ç®¡ç†åœºæ™¯ã€‚
>
> æœåŠ¡ç«¯åŸºäºŽ Spring Boot å’Œ Spring Cloud å¼€å‘ï¼Œæ‰“åŒ…åŽå¯ä»¥ç›´æŽ¥è¿è¡Œï¼Œä¸éœ€è¦é¢å¤–å®‰è£… Tomcat ç­‰åº”ç”¨å®¹å™¨ã€‚
>
> Java å®¢æˆ·ç«¯ä¸ä¾èµ–ä»»ä½•æ¡†æž¶ï¼Œèƒ½å¤Ÿè¿è¡ŒäºŽæ‰€æœ‰ Java è¿è¡Œæ—¶çŽ¯å¢ƒï¼ŒåŒæ—¶å¯¹ Spring/Spring Boot çŽ¯å¢ƒä¹Ÿæœ‰è¾ƒå¥½çš„æ”¯æŒã€‚

Apollo ç‰¹æ€§ï¼š

- **é…ç½®ä¿®æ”¹å®žæ—¶ç”Ÿæ•ˆï¼ˆçƒ­å‘å¸ƒï¼‰** ï¼ˆ1s å³å¯æŽ¥æ”¶åˆ°æœ€æ–°é…ç½®ï¼‰
- **ç°åº¦å‘å¸ƒ** ï¼ˆé…ç½®åªæŽ¨ç»™éƒ¨åˆ†åº”ç”¨ï¼‰
- **éƒ¨ç½²ç®€å•** ï¼ˆåªä¾èµ– MySQLï¼‰
- **è·¨è¯­è¨€** ï¼ˆæä¾›äº† HTTP æŽ¥å£ï¼Œä¸é™åˆ¶ç¼–ç¨‹è¯­è¨€ï¼‰
- ......

å…³äºŽå¦‚ä½•ä½¿ç”¨ Apollo å¯ä»¥æŸ¥çœ‹ [Apollo å®˜æ–¹ä½¿ç”¨æŒ‡å—](https://www.apolloconfig.com/#/zh/usage/apollo-user-guide)ã€‚

ç›¸å…³é˜…è¯»ï¼š

- [Apollo åœ¨æœ‰èµžçš„å®žè·µ](https://mp.weixin.qq.com/s/Ge14UeY9Gm2Hrk--E47eJQ)
- [åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒé€‰åž‹ï¼Œä¸ºä»€ä¹ˆé€‰æ‹© Apolloï¼Ÿâ€”å¾®è§‚æŠ€æœ¯-2021-04-23](https://mp.weixin.qq.com/s?__biz=Mzg2NzYyNjQzNg==&mid=2247484920&idx=1&sn=76d91ce217bf508aa2ee7156e1ba0994&source=41#wechat_redirect)

##### Apollo æž¶æž„è§£æž

å®˜æ–¹ç»™å‡ºçš„ Apollo åŸºç¡€æ¨¡åž‹éžå¸¸ç®€å•ï¼š

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2Fa75ccb863e4a401d947c87bb14af7dc3.png)

1. ç”¨æˆ·é€šè¿‡ Apollo é…ç½®ä¸­å¿ƒä¿®æ”¹/å‘å¸ƒé…ç½®ï¼Œ

2. Apollo é…ç½®ä¸­å¿ƒé€šçŸ¥åº”ç”¨é…ç½®å·²ç»æ›´æ”¹

3. åº”ç”¨è®¿é—® Apollo é…ç½®ä¸­å¿ƒèŽ·å–æœ€æ–°çš„é…ç½®

å®˜æ–¹ç»™å‡ºçš„æž¶æž„å›¾å¦‚ä¸‹ï¼š

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2F79c7445f9dbc45adb45699d40ef50f44.png)

- **Client ç«¯ï¼ˆå®¢æˆ·ç«¯ï¼Œç”¨äºŽåº”ç”¨èŽ·å–é…ç½®ï¼‰æµç¨‹** ï¼šClient é€šè¿‡åŸŸåèµ° slbï¼ˆè½¯ä»¶è´Ÿè½½å‡è¡¡ï¼‰è®¿é—® Meta Serverï¼ŒMeta Server è®¿é—®
  Eureka æœåŠ¡æ³¨å†Œä¸­å¿ƒèŽ·å– Config Service æœåŠ¡åˆ—è¡¨ï¼ˆIP+Portï¼‰ã€‚æœ‰äº† IP+Portï¼Œæˆ‘ä»¬å°±èƒ½è®¿é—® Config Service æš´éœ²çš„æœåŠ¡æ¯”å¦‚é€šè¿‡
  GET è¯·æ±‚èŽ·å–é…ç½®çš„æŽ¥å£ï¼ˆ`/configs/{appId}/{clusterName}/{namespace:.+}`ï¼‰å³å¯èŽ·å–é…ç½®ã€‚
- **Portal ç«¯ï¼ˆUI ç•Œé¢ï¼Œç”¨äºŽå¯è§†åŒ–é…ç½®ç®¡ç†ï¼‰æµç¨‹** ï¼šPortal ç«¯é€šè¿‡åŸŸåèµ° slbï¼ˆè½¯ä»¶è´Ÿè½½å‡è¡¡ï¼‰è®¿é—® Meta Serverï¼ŒMeta Server è®¿é—®
  Eureka æœåŠ¡æ³¨å†Œä¸­å¿ƒèŽ·å– Admin Service æœåŠ¡åˆ—è¡¨ï¼ˆIP+Portï¼‰ã€‚æœ‰äº† IP+Portï¼Œæˆ‘ä»¬å°±èƒ½è®¿é—® Admin Service æš´éœ²çš„æœåŠ¡æ¯”å¦‚é€šè¿‡
  POST è¯·æ±‚è®¿é—®å‘å¸ƒé…ç½®çš„æŽ¥å£ï¼ˆ`/apps/{appId}/envs/{env}/clusters/{clusterName}/namespaces/{namespaceName}/releases`
  ï¼‰å³å¯å‘å¸ƒé…ç½®ã€‚

å¦å¤–ï¼Œæ¨æ³¢è€å¸ˆçš„[å¾®æœåŠ¡æž¶æž„~æºç¨‹ Apollo é…ç½®ä¸­å¿ƒæž¶æž„å‰–æž](https://mp.weixin.qq.com/s/-hUaQPzfsl9Lm3IqQW3VDQ)è¿™ç¯‡æ–‡ç« å¯¹
Apollo çš„æž¶æž„åšäº†ç®€åŒ–ï¼Œå€¼å¾—ä¸€çœ‹ã€‚

æˆ‘ä¼šä»Žä¸Šåˆ°ä¸‹ä¾æ¬¡ä»‹ç»æž¶æž„å›¾ä¸­æ¶‰åŠåˆ°çš„æ‰€æœ‰è§’è‰²çš„ä½œç”¨ã€‚

###### Client

Apollo å®˜æ–¹æä¾›çš„å®¢æˆ·ç«¯ï¼Œç›®å‰æœ‰ Java å’Œ.Net ç‰ˆæœ¬ã€‚éž Java å’Œ.Net åº”ç”¨å¯ä»¥é€šè¿‡è°ƒç”¨ HTTP æŽ¥å£æ¥ä½¿ç”¨ Apolloã€‚

Client çš„ä½œç”¨ä¸»è¦å°±æ˜¯æä¾›ä¸€äº›å¼€ç®±å³ç”¨çš„æ–¹æ³•æ–¹ä¾¿åº”ç”¨èŽ·å–ä»¥åŠå®žæ—¶æ›´æ–°é…ç½®ã€‚

æ¯”å¦‚ä½ é€šè¿‡ä¸‹é¢çš„å‡ è¡Œä»£ç å°±èƒ½èŽ·å–åˆ° someKey å¯¹åº”çš„å®žæ—¶æœ€æ–°çš„é…ç½®å€¼ï¼š

```java
Config config = ConfigService.getAppConfig();
String someKey = "someKeyFromDefaultNamespace";
String someDefaultValue = "someDefaultValueForTheKey";
String value = config.getProperty(someKey, someDefaultValue);
```

å†æ¯”å¦‚ä½ é€šè¿‡ä¸‹é¢çš„ä»£ç å°±èƒ½ç›‘å¬é…ç½®å˜åŒ–ï¼š

```java
Config config = ConfigService.getAppConfig();
config.addChangeListener(new ConfigChangeListener() {
    @Override
    public void onChange(ConfigChangeEvent changeEvent) {
       //......
    }
});
```

###### Portal

Portal å®žé™…å°±æ˜¯ä¸€ä¸ªå¸®åŠ©æˆ‘ä»¬ä¿®æ”¹å’Œå‘å¸ƒé…ç½®çš„ UI ç•Œé¢ã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2Fe63ef8dc739548e8b504632b151ba4c7.png)

###### ï¼ˆSoftwareï¼‰ Load Balancer

ä¸ºäº†å®žçŽ° MetaServer çš„é«˜å¯ç”¨ï¼ŒMetaServer é€šå¸¸ä»¥é›†ç¾¤çš„å½¢å¼éƒ¨ç½²ã€‚

Client/Portal ç›´æŽ¥è®¿é—® ï¼ˆSoftwareï¼‰ Load Balancer ï¼Œç„¶åŽï¼Œå†ç”±å…¶è¿›è¡Œè´Ÿè½½å‡è¡¡å’Œæµé‡è½¬å‘ã€‚

###### Meta Server

ä¸ºäº†å®žçŽ°è·¨è¯­è¨€ä½¿ç”¨ï¼Œé€šå¸¸çš„åšæ³•å°±æ˜¯æš´éœ² HTTP æŽ¥å£ã€‚ä¸ºæ­¤ï¼ŒApollo å¼•å…¥äº† MetaServerã€‚

Meta Server å…¶å®žå°±æ˜¯ Eureka çš„ Proxyï¼Œä½œç”¨å°±æ˜¯å°† Eureka çš„æœåŠ¡å‘çŽ°æŽ¥å£ä»¥ HTTP æŽ¥å£çš„å½¢å¼æš´éœ²å‡ºæ¥ã€‚ è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬é€šè¿‡ HTTP
è¯·æ±‚å°±å¯ä»¥è®¿é—®åˆ° Config Service å’Œ AdminServiceã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯å»ºè®®åŸºäºŽ Meta Server æœºåˆ¶æ¥å®žçŽ° Config Service çš„æœåŠ¡å‘çŽ°ï¼Œè¿™æ ·å¯ä»¥å®žçŽ° Config Service çš„é«˜å¯ç”¨ã€‚ä¸è¿‡ï¼Œ
ä½ ä¹Ÿå¯ä»¥é€‰æ‹©è·³è¿‡ MetaServerï¼Œç›´æŽ¥æŒ‡å®š Config Service åœ°å€ï¼ˆapollo-client 0.11.0 åŠä»¥ä¸Šç‰ˆæœ¬ï¼‰ã€‚

###### Config Service

ä¸»è¦ç”¨äºŽ Client å¯¹é…ç½®çš„èŽ·å–ä»¥åŠå®žæ—¶æ›´æ–°ã€‚

###### Admin Service

ä¸»è¦ç”¨äºŽ Portal å¯¹é…ç½®çš„æ›´æ–°ã€‚

#### å‚è€ƒ

- Nacos 1.2.0 æƒé™æŽ§åˆ¶ä»‹ç»å’Œä½¿ç”¨ï¼šhttps://nacos.io/zh-cn/blog/nacos 1.2.0 guide.html
- Nacos 1.1.0 å‘å¸ƒï¼Œæ”¯æŒç°åº¦é…ç½®å’Œåœ°å€æœåŠ¡å™¨æ¨¡å¼ï¼šhttps://nacos.io/zh-cn/blog/nacos 1.1.0.html
- Apollo å¸¸è§é—®é¢˜è§£ç­”ï¼šhttps://www.apolloconfig.com/#/zh/faq/faq
- å¾®æœåŠ¡é…ç½®ä¸­å¿ƒé€‰åž‹æ¯”è¾ƒï¼šhttps://www.itshangxp.com/spring-cloud/spring-cloud-config-center/

### **æœåŠ¡æ²»ç†ï¼šåˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ**

**ç½‘ä¸Šå·²ç»æœ‰å¾ˆå¤šå…³äºŽåˆ†å¸ƒå¼äº‹åŠ¡çš„æ–‡ç« äº†ï¼Œä¸ºå•¥è¿˜è¦å†™ä¸€ç¯‡ï¼Ÿ**

1. ç¬¬ä¸€æ˜¯æˆ‘è§‰å¾—å¤§éƒ¨åˆ†æ–‡ç« ç†è§£èµ·æ¥æŒºéš¾çš„ï¼Œä¸å¤ªé€‚åˆä¸€äº›ç»éªŒä¸å¤šçš„å°ä¼™ä¼´ã€‚è¿™ç¯‡æ–‡ç« æˆ‘çš„ç›®æ ‡å°±æ˜¯è®©å³ä½¿æ˜¯æ²¡å•¥å·¥ä½œç»éªŒçš„å°ä¼™ä¼´ä»¬éƒ½èƒ½çœŸæ­£çœ‹æ‡‚åˆ†å¸ƒå¼äº‹åŠ¡ã€‚

2. ç¬¬äºŒæ˜¯æˆ‘è§‰å¾—å¤§éƒ¨åˆ†æ–‡ç« ä»‹ç»çš„ä¸å¤Ÿè¯¦ç»†ï¼Œå¾ˆå¯¹åˆ†å¸ƒå¼äº‹åŠ¡ç›¸å…³æ¯”è¾ƒé‡è¦çš„æ¦‚å¿µéƒ½æ²¡æœ‰æåˆ°ã€‚

å¼€å§‹èŠåˆ†å¸ƒå¼äº‹åŠ¡ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å›žé¡¾ä¸€ä¸‹äº‹åŠ¡ç›¸å…³çš„æ¦‚å¿µã€‚

#### äº‹åŠ¡

æˆ‘ä»¬è®¾æƒ³ä¸€ä¸ªåœºæ™¯ï¼Œè¿™ä¸ªåœºæ™¯ä¸­æˆ‘ä»¬éœ€è¦æ’å…¥å¤šæ¡ç›¸å…³è”çš„æ•°æ®åˆ°æ•°æ®åº“ï¼Œä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯èƒ½ä¼šé‡åˆ°ä¸‹é¢è¿™äº›é—®é¢˜ï¼š

- æ•°æ®åº“ä¸­é€”çªç„¶å› ä¸ºæŸäº›åŽŸå› æŒ‚æŽ‰äº†ã€‚
- å®¢æˆ·ç«¯çªç„¶å› ä¸ºç½‘ç»œåŽŸå› è¿žæŽ¥ä¸ä¸Šæ•°æ®åº“äº†ã€‚
- å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶å†™å…¥æ•°æ®åº“ï¼Œè¦†ç›–äº†å½¼æ­¤çš„æ›´æ”¹ã€‚
- ......

ä¸Šé¢çš„ä»»ä½•ä¸€ä¸ªé—®é¢˜éƒ½å¯èƒ½ä¼šå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œç³»ç»Ÿå¿…é¡»èƒ½å¤Ÿå¤„ç†è¿™äº›é—®é¢˜ã€‚äº‹åŠ¡å°±æ˜¯æˆ‘ä»¬æŠ½è±¡å‡ºæ¥ç®€åŒ–è¿™äº›é—®é¢˜çš„é¦–é€‰æœºåˆ¶ã€‚äº‹åŠ¡çš„æ¦‚å¿µèµ·æºäºŽæ•°æ®åº“ï¼Œç›®å‰ï¼Œå·²ç»æˆä¸ºä¸€ä¸ªæ¯”è¾ƒå¹¿æ³›çš„æ¦‚å¿µã€‚

**ä½•ä¸ºäº‹åŠ¡ï¼Ÿ** ä¸€è¨€è”½ä¹‹ï¼Œ**äº‹åŠ¡æ˜¯é€»è¾‘ä¸Šçš„ä¸€ç»„æ“ä½œï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ**ã€‚

äº‹åŠ¡æœ€ç»å…¸ä¹Ÿç»å¸¸è¢«æ‹¿å‡ºæ¥è¯´ä¾‹å­å°±æ˜¯è½¬è´¦äº†ã€‚å‡å¦‚å°æ˜Žè¦ç»™å°çº¢è½¬è´¦ 1000 å…ƒï¼Œè¿™ä¸ªè½¬è´¦ä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªå…³é”®æ“ä½œï¼Œè¿™ä¸¤ä¸ªæ“ä½œå¿…é¡»éƒ½æˆåŠŸæˆ–è€…éƒ½å¤±è´¥ã€‚

1. å°†å°æ˜Žçš„ä½™é¢å‡å°‘ 1000 å…ƒ
2. å°†å°çº¢çš„ä½™é¢å¢žåŠ  1000 å…ƒã€‚

äº‹åŠ¡ä¼šæŠŠè¿™ä¸¤ä¸ªæ“ä½œå°±å¯ä»¥çœ‹æˆé€»è¾‘ä¸Šçš„ä¸€ä¸ªæ•´ä½“ï¼Œè¿™ä¸ªæ•´ä½“åŒ…å«çš„æ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½è¦å¤±è´¥ã€‚è¿™æ ·å°±ä¸ä¼šå‡ºçŽ°å°æ˜Žä½™é¢å‡å°‘è€Œå°çº¢çš„ä½™é¢å´å¹¶æ²¡æœ‰å¢žåŠ çš„æƒ…å†µã€‚

![image-20230214132043857](é¢è¯•æŒ‡åŒ—.assets/image-20230214132043857.png)

#### æ•°æ®åº“äº‹åŠ¡

å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨è°ˆè®ºäº‹åŠ¡çš„æ—¶å€™ï¼Œå¦‚æžœæ²¡æœ‰ç‰¹æŒ‡**åˆ†å¸ƒå¼äº‹åŠ¡**ï¼Œå¾€å¾€æŒ‡çš„å°±æ˜¯**æ•°æ®åº“äº‹åŠ¡**ã€‚

æ•°æ®åº“äº‹åŠ¡åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­æŽ¥è§¦çš„æœ€å¤šäº†ã€‚å¦‚æžœä½ çš„é¡¹ç›®å±žäºŽå•ä½“æž¶æž„çš„è¯ï¼Œä½ æŽ¥è§¦åˆ°çš„å¾€å¾€å°±æ˜¯æ•°æ®åº“äº‹åŠ¡äº†ã€‚

**é‚£æ•°æ®åº“äº‹åŠ¡æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ**

ç®€å•æ¥è¯´ï¼Œæ•°æ®åº“äº‹åŠ¡å¯ä»¥ä¿è¯å¤šä¸ªå¯¹æ•°æ®åº“çš„æ“ä½œï¼ˆä¹Ÿå°±æ˜¯ SQL è¯­å¥ï¼‰æž„æˆä¸€ä¸ªé€»è¾‘ä¸Šçš„æ•´ä½“ã€‚æž„æˆè¿™ä¸ªé€»è¾‘ä¸Šçš„æ•´ä½“çš„è¿™äº›æ•°æ®åº“æ“ä½œéµå¾ªï¼š
**è¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸ,è¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œ ã€‚**

```sql
# å¼€å¯ä¸€ä¸ªäº‹åŠ¡
START TRANSACTION;
# å¤šæ¡ SQL è¯­å¥
SQL1,SQL2...
## æäº¤äº‹åŠ¡
COMMIT;
```

![æ•°æ®åº“äº‹åŠ¡ç¤ºæ„å›¾.png](é¢è¯•æŒ‡åŒ—.assets/1666839474634-c00929d5-49c2-4d89-8aeb-2c9eebd75712.png)

å¦å¤–ï¼Œå…³ç³»åž‹æ•°æ®åº“ï¼ˆä¾‹å¦‚ï¼š`MySQL`ã€`SQL Server`ã€`Oracle` ç­‰ï¼‰äº‹åŠ¡éƒ½æœ‰ **ACID** ç‰¹æ€§ï¼š

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fguide-blog-images.oss-cn-shenzhen.aliyuncs.com%2Fgithub%2Fjavaguide%2Fmysql%2FACID-167635307295839.png)

1. **åŽŸå­æ€§**ï¼ˆAtomicityï¼‰ ï¼š äº‹åŠ¡æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œä¸å…è®¸åˆ†å‰²ã€‚äº‹åŠ¡çš„åŽŸå­æ€§ç¡®ä¿åŠ¨ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå®Œå…¨ä¸èµ·ä½œç”¨ï¼›
2. **ä¸€è‡´æ€§**ï¼ˆConsistencyï¼‰ï¼š æ‰§è¡Œäº‹åŠ¡å‰åŽï¼Œæ•°æ®ä¿æŒä¸€è‡´ï¼Œä¾‹å¦‚è½¬è´¦ä¸šåŠ¡ä¸­ï¼Œæ— è®ºäº‹åŠ¡æ˜¯å¦æˆåŠŸï¼Œè½¬è´¦è€…å’Œæ”¶æ¬¾äººçš„æ€»é¢åº”è¯¥æ˜¯ä¸å˜çš„ï¼›
3. **éš”ç¦»æ€§**ï¼ˆIsolationï¼‰ï¼š å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œä¸€ä¸ªç”¨æˆ·çš„äº‹åŠ¡ä¸è¢«å…¶ä»–äº‹åŠ¡æ‰€å¹²æ‰°ï¼Œå„å¹¶å‘äº‹åŠ¡ä¹‹é—´æ•°æ®åº“æ˜¯ç‹¬ç«‹çš„ï¼›
4. **æŒä¹…æ€§**ï¼ˆDurabililyï¼‰ï¼š ä¸€ä¸ªäº‹åŠ¡è¢«æäº¤ä¹‹åŽã€‚å®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜æ˜¯æŒä¹…çš„ï¼Œå³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚

ðŸŒˆ è¿™é‡Œè¦é¢å¤–è¡¥å……ä¸€ç‚¹ï¼š**åªæœ‰ä¿è¯äº†äº‹åŠ¡çš„æŒä¹…æ€§ã€åŽŸå­æ€§ã€éš”ç¦»æ€§ä¹‹åŽï¼Œä¸€è‡´æ€§æ‰èƒ½å¾—åˆ°ä¿éšœã€‚ä¹Ÿå°±æ˜¯è¯´ Aã€Iã€D æ˜¯æ‰‹æ®µï¼ŒC æ˜¯ç›®çš„ï¼**
æƒ³å¿…å¤§å®¶ä¹Ÿå’Œæˆ‘ä¸€æ ·ï¼Œè¢« ACID è¿™ä¸ªæ¦‚å¿µè¢«è¯¯å¯¼äº†å¾ˆä¹…!
æˆ‘ä¹Ÿæ˜¯çœ‹å‘¨å¿—æ˜Žè€å¸ˆçš„å…¬å¼€è¯¾[ã€Šå‘¨å¿—æ˜Žçš„è½¯ä»¶æž¶æž„è¯¾ã€‹](https://time.geekbang.org/opencourse/intro/100064201)æ‰æžæ¸…æ¥šçš„ï¼ˆå¤šçœ‹å¥½ä¹¦ï¼ï¼ï¼ï¼‰ã€‚

![image-20230214132224195](é¢è¯•æŒ‡åŒ—.assets/image-20230214132224195.png)

å¦å¤–ï¼ŒDDIA
ä¹Ÿå°±æ˜¯ [ã€ŠDesigning Data-Intensive Applicationï¼ˆæ•°æ®å¯†é›†åž‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ï¼‰ã€‹](https://book.douban.com/subject/30329536/)
çš„ä½œè€…åœ¨ä»–çš„è¿™æœ¬ä¹¦ä¸­å¦‚æ˜¯è¯´ï¼š

> Atomicity, isolation, and durability are properties of the database, whereas consisâ€ tency (in the ACID sense) is a
> property of the application. The application may rely on the databaseâ€™s atomicity and isolation properties in order to
> achieve consistency, but itâ€™s not up to the database alone.
>
> ç¿»è¯‘è¿‡æ¥çš„æ„æ€æ˜¯ï¼šåŽŸå­æ€§ï¼Œéš”ç¦»æ€§å’ŒæŒä¹…æ€§æ˜¯æ•°æ®åº“çš„å±žæ€§ï¼Œè€Œä¸€è‡´æ€§ï¼ˆåœ¨ ACID
> æ„ä¹‰ä¸Šï¼‰æ˜¯åº”ç”¨ç¨‹åºçš„å±žæ€§ã€‚åº”ç”¨å¯èƒ½ä¾èµ–æ•°æ®åº“çš„åŽŸå­æ€§å’Œéš”ç¦»å±žæ€§æ¥å®žçŽ°ä¸€è‡´æ€§ï¼Œä½†è¿™å¹¶ä¸ä»…å–å†³äºŽæ•°æ®åº“ã€‚å› æ­¤ï¼Œå­—æ¯ C ä¸å±žäºŽ
> ACID ã€‚

ã€ŠDesigning Data-Intensive Applicationï¼ˆæ•°æ®å¯†é›†åž‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ï¼‰ã€‹è¿™æœ¬ä¹¦å¼ºæŽ¨ä¸€æ³¢ï¼Œå€¼å¾—è¯»å¾ˆå¤šéï¼è±†ç“£æœ‰æŽ¥è¿‘ 90%
çš„äººçœ‹äº†è¿™æœ¬ä¹¦ä¹‹åŽç»™äº†äº”æ˜Ÿå¥½è¯„ã€‚å¦å¤–ï¼Œä¸­æ–‡ç¿»è¯‘ç‰ˆæœ¬å·²ç»åœ¨ Github å¼€æºï¼Œåœ°å€ï¼šhttps://github.com/Vonng/ddia ã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2F20210526162552353.png)

**æ•°æ®äº‹åŠ¡çš„å®žçŽ°åŽŸç†å‘¢ï¼Ÿ**

æˆ‘ä»¬è¿™é‡Œä»¥ MySQL çš„ InnoDB å¼•æ“Žä¸ºä¾‹æ¥ç®€å•è¯´ä¸€ä¸‹ã€‚

MySQL InnoDB å¼•æ“Žä½¿ç”¨ **redo log(é‡åšæ—¥å¿—)** ä¿è¯äº‹åŠ¡çš„**æŒä¹…æ€§**ï¼Œä½¿ç”¨ **undo log(å›žæ»šæ—¥å¿—)** æ¥ä¿è¯äº‹åŠ¡çš„**åŽŸå­æ€§**
ã€‚MySQL InnoDB å¼•æ“Žé€šè¿‡ **é”æœºåˆ¶**ã€**MVCC** ç­‰æ‰‹æ®µæ¥ä¿è¯äº‹åŠ¡çš„éš”ç¦»æ€§ï¼ˆ é»˜è®¤æ”¯æŒçš„éš”ç¦»çº§åˆ«æ˜¯ **REPEATABLE-READ** ï¼‰ã€‚

#### åˆ†å¸ƒå¼äº‹åŠ¡

å¾®æœåŠ¡æž¶æž„ä¸‹ï¼Œä¸€ä¸ªç³»ç»Ÿè¢«æ‹†åˆ†ä¸ºå¤šä¸ªå°çš„å¾®æœåŠ¡ã€‚æ¯ä¸ªå¾®æœåŠ¡éƒ½å¯èƒ½å­˜åœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œå¹¶ä¸”æ¯ä¸ªå¾®æœåŠ¡å¯èƒ½éƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„æ•°æ®åº“ä¾›è‡ªå·±ä½¿ç”¨ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€ç»„æ“ä½œå¯èƒ½ä¼šæ¶‰åŠåˆ°å¤šä¸ªå¾®æœåŠ¡ä»¥åŠå¤šä¸ªæ•°æ®åº“ã€‚ä¸¾ä¸ªä¾‹å­ï¼šç”µå•†ç³»ç»Ÿä¸­ï¼Œä½ åˆ›å»ºä¸€ä¸ªè®¢å•å¾€å¾€ä¼šæ¶‰åŠåˆ°è®¢å•æœåŠ¡ï¼ˆè®¢å•æ•°åŠ ä¸€ï¼‰ã€åº“å­˜æœåŠ¡ï¼ˆåº“å­˜å‡ä¸€ï¼‰ç­‰ç­‰æœåŠ¡ï¼Œè¿™äº›æœåŠ¡ä¼šæœ‰ä¾›è‡ªå·±å•ç‹¬ä½¿ç”¨çš„æ•°æ®åº“ã€‚

![img](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fguide-blog-images.oss-cn-shenzhen.aliyuncs.com%2Fgithub%2Fjavaguide%2Fdistributed-system%2Fdistributed-transaction%2Fdistributed-transaction-with-two-services.png&sign=49a53a4f4598f7373bae90515fd1a2c4a4ed0e44184a8ad6a20aada34ca560fb)

**é‚£ä¹ˆå¦‚ä½•ä¿è¯è¿™ä¸€ç»„æ“ä½œè¦ä¹ˆéƒ½æ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œå¤±è´¥å‘¢ï¼Ÿ**

è¿™ä¸ªæ—¶å€™å•å•ä¾é æ•°æ®åº“äº‹åŠ¡å°±ä¸è¡Œäº†ï¼æˆ‘ä»¬å°±éœ€è¦å¼•å…¥ **åˆ†å¸ƒå¼äº‹åŠ¡** è¿™ä¸ªæ¦‚å¿µäº†ï¼

å®žé™…ä¸Šï¼Œåªè¦è·¨æ•°æ®åº“çš„åœºæ™¯éƒ½éœ€è¦ç”¨åˆ°å¼•å…¥åˆ†å¸ƒå¼äº‹åŠ¡ã€‚æ¯”å¦‚è¯´å•ä¸ªæ•°æ®åº“çš„æ€§èƒ½è¾¾åˆ°ç“¶é¢ˆæˆ–è€…æ•°æ®é‡å¤ªå¤§çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œ
åˆ†åº“ã€‚åˆ†åº“ä¹‹åŽï¼ŒåŒä¸€ä¸ªæ•°æ®åº“ä¸­çš„è¡¨åˆ†å¸ƒåœ¨äº†ä¸åŒçš„æ•°æ®åº“ä¸­ï¼Œå¦‚æžœå•ä¸ªæ“ä½œæ¶‰åŠåˆ°å¤šä¸ªæ•°æ®åº“ï¼Œé‚£ä¹ˆæ•°æ®åº“è‡ªå¸¦çš„äº‹åŠ¡å°±æ— æ³•æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚äº†ã€‚

ä¸€è¨€è”½ä¹‹ï¼Œ**åˆ†å¸ƒå¼äº‹åŠ¡çš„ç»ˆæžç›®æ ‡å°±æ˜¯ä¿è¯ç³»ç»Ÿä¸­å¤šä¸ªç›¸å…³è”çš„æ•°æ®åº“ä¸­çš„æ•°æ®çš„ä¸€è‡´æ€§ï¼**

é‚£æ—¢ç„¶åˆ†å¸ƒå¼äº‹åŠ¡ä¹Ÿå±žäºŽäº‹åŠ¡ï¼Œç†è®ºä¸Šå°±åº”è¯¥å‡†å®ˆäº‹ç‰©çš„ ACID å››å¤§ç‰¹æ€§ã€‚ä½†æ˜¯ï¼Œè€ƒè™‘åˆ°æ€§èƒ½ã€å¯ç”¨æ€§ç­‰å„æ–¹é¢å› ç´ ï¼Œæˆ‘ä»¬å¾€å¾€æ˜¯æ— æ³•å®Œå…¨æ»¡è¶³
ACID çš„ï¼Œåªèƒ½é€‰æ‹©ä¸€ä¸ªæ¯”è¾ƒæŠ˜ä¸­çš„æ–¹æ¡ˆã€‚

é’ˆå¯¹åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œåˆè¯žç”Ÿäº†ä¸€äº›æ–°çš„ç†è®ºã€‚

#### **åˆ†å¸ƒå¼äº‹åŠ¡åŸºç¡€ç†è®º**

##### CAP ç†è®ºå’Œ BASE ç†è®º

CAP ç†è®ºå’Œ BASE ç†è®ºæ˜¯åˆ†å¸ƒå¼é¢†åŸŸéžå¸¸éžå¸¸é‡è¦çš„ä¸¤ä¸ªç†è®ºã€‚ä¸å¤¸å¼ åœ°è¯´ï¼Œåªè¦é—®åˆ°åˆ†å¸ƒå¼ç›¸å…³çš„å†…å®¹ï¼Œé¢è¯•å®˜å‡ ä¹Žæ˜¯å¿…å®šä¼šé—®è¿™ä¸¤ä¸ªåˆ†å¸ƒå¼ç›¸å…³çš„ç†è®ºã€‚

ä¸è®ºæ˜¯ä½ é¢è¯•ä¹Ÿå¥½ï¼Œå·¥ä½œä¹Ÿç½¢ï¼Œéƒ½éžå¸¸æœ‰å¿…è¦å°†è¿™ä¸¤ä¸ªç†è®ºæžæ‡‚ï¼Œå¹¶ä¸”èƒ½å¤Ÿç”¨è‡ªå·±çš„ç†è§£ç»™åˆ«äººè®²å‡ºæ¥ã€‚

æˆ‘è¿™é‡Œå°±ä¸å¤šæè¿™ä¸¤ä¸ªç†è®ºäº†ï¼Œä¸äº†è§£çš„å°ä¼™ä¼´ï¼Œå¯ä»¥çœ‹æˆ‘å‰æ®µæ—¶é—´å†™è¿‡çš„ä¸€ç¯‡ç›¸å…³çš„æ–‡ç« ï¼š[ã€ŠCAP å’Œ BASE ç†è®ºäº†è§£ä¹ˆï¼Ÿå¯ä»¥ç»“åˆå®žé™…æ¡ˆä¾‹è¯´ä¸‹ä¸ï¼Ÿã€‹](https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247495298&idx=1&sn=965be0f54ab44bda818656db1f21a39f&chksm=cea1a149f9d6285f1169413ab7663ca2a9c1a8440a5ae5816566eb66b20e4d86f5db1002f66c&token=657875872&lang=zh_CN#rd) ã€‚

##### ä¸€è‡´æ€§çš„ 3 ç§çº§åˆ«

æˆ‘ä»¬å¯ä»¥æŠŠå¯¹äºŽç³»ç»Ÿä¸€è‡´æ€§çš„è¦æ±‚åˆ†ä¸ºä¸‹é¢ 3 ç§çº§åˆ«ï¼š

- **å¼ºä¸€è‡´æ€§** ï¼šç³»ç»Ÿå†™å…¥äº†ä»€ä¹ˆï¼Œè¯»å‡ºæ¥çš„å°±æ˜¯ä»€ä¹ˆã€‚
- **å¼±ä¸€è‡´æ€§** ï¼šä¸ä¸€å®šå¯ä»¥è¯»å–åˆ°æœ€æ–°å†™å…¥çš„å€¼ï¼Œä¹Ÿä¸ä¿è¯å¤šå°‘æ—¶é—´ä¹‹åŽè¯»å–åˆ°çš„æ•°æ®æ˜¯æœ€æ–°çš„ï¼Œåªæ˜¯ä¼šå°½é‡ä¿è¯æŸä¸ªæ—¶åˆ»è¾¾åˆ°æ•°æ®ä¸€è‡´çš„çŠ¶æ€ã€‚
- **æœ€ç»ˆä¸€è‡´æ€§** ï¼šå¼±ä¸€è‡´æ€§çš„å‡çº§ç‰ˆã€‚ç³»ç»Ÿä¼šä¿è¯åœ¨ä¸€å®šæ—¶é—´å†…è¾¾åˆ°æ•°æ®ä¸€è‡´çš„çŠ¶æ€ï¼Œ

é™¤äº†ä¸Šé¢è¿™ 3
ä¸ªæ¯”è¾ƒå¸¸è§çš„ä¸€è‡´æ€§çº§åˆ«ä¹‹å¤–ï¼Œè¿˜æœ‰è¯»å†™ä¸€è‡´æ€§ã€å› æžœä¸€è‡´æ€§ç­‰ä¸€è‡´æ€§æ¨¡åž‹ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ[ã€ŠOperational Characterization of Weak Memory Consistency Modelsã€‹](https://es.cs.uni-kl.de/publications/datarsg/Senf13.pdf)
è¿™ç¯‡è®ºæ–‡ã€‚å› ä¸ºæ—¥å¸¸å·¥ä½œä¸­è¿™äº›ä¸€è‡´æ€§æ¨¡åž‹å¾ˆå°‘è§ï¼Œæˆ‘è¿™é‡Œå°±ä¸å¤šåšé˜è¿°ï¼ˆå› ä¸ºæˆ‘è‡ªå·±ä¹Ÿä¸æ˜¯ç‰¹åˆ«äº†è§£ ðŸ˜…ï¼‰ã€‚

ä¸šç•Œæ¯”è¾ƒæŽ¨å´‡æ˜¯ **æœ€ç»ˆä¸€è‡´æ€§**ï¼Œä½†æ˜¯æŸäº›å¯¹æ•°æ®ä¸€è‡´è¦æ±‚ååˆ†ä¸¥æ ¼çš„åœºæ™¯æ¯”å¦‚é“¶è¡Œè½¬è´¦è¿˜æ˜¯è¦ä¿è¯å¼ºä¸€è‡´æ€§ã€‚

##### æŸ”æ€§äº‹åŠ¡

äº’è”ç½‘åº”ç”¨æœ€å…³é”®çš„å°±æ˜¯è¦ä¿è¯é«˜å¯ç”¨ï¼Œ è®¡ç®—å¼ç³»ç»Ÿå‡ ç§’é’Ÿä¹‹å†…æ²¡åŠžæ³•ä½¿ç”¨éƒ½æœ‰å¯èƒ½é€ æˆæ•°ç™¾ä¸‡çš„æŸå¤±ã€‚åœ¨æ­¤åœºæ™¯ä¸‹ï¼Œä¸€äº›å¤§ä½¬ä»¬åœ¨ CAP
ç†è®ºå’Œ BASE ç†è®ºçš„åŸºç¡€ä¸Šï¼Œæå‡ºäº† **æŸ”æ€§äº‹åŠ¡** çš„æ¦‚å¿µã€‚ **æŸ”æ€§äº‹åŠ¡è¿½æ±‚çš„æ˜¯æœ€ç»ˆä¸€è‡´æ€§ã€‚**

å®žé™…ä¸Šï¼ŒæŸ”æ€§äº‹åŠ¡å°±æ˜¯ **BASE ç†è®º +ä¸šåŠ¡å®žè·µ**ã€‚ æŸ”æ€§äº‹åŠ¡è¿½æ±‚çš„ç›®æ ‡æ˜¯ï¼šæˆ‘ä»¬æ ¹æ®è‡ªèº«ä¸šåŠ¡ç‰¹æ€§ï¼Œé€šè¿‡é€‚å½“çš„æ–¹å¼æ¥ä¿è¯ç³»ç»Ÿæ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚
åƒ **TCCã€ Sagaã€MQ äº‹åŠ¡ ã€æœ¬åœ°æ¶ˆæ¯è¡¨** å°±å±žäºŽæŸ”æ€§äº‹åŠ¡ã€‚

##### åˆšæ€§äº‹åŠ¡

ä¸ŽæŸ”æ€§äº‹åŠ¡ç›¸å¯¹çš„å°±æ˜¯ **åˆšæ€§äº‹åŠ¡** äº†ã€‚å‰é¢æˆ‘ä»¬è¯´äº†ï¼Œ**æŸ”æ€§äº‹åŠ¡è¿½æ±‚çš„æ˜¯æœ€ç»ˆä¸€è‡´æ€§** ã€‚é‚£ä¹ˆï¼Œä¸Žä¹‹å¯¹åº”ï¼Œåˆšæ€§äº‹åŠ¡è¿½æ±‚çš„å°±æ˜¯ *
*å¼ºä¸€è‡´æ€§**ã€‚åƒ**2PC ã€3PC** å°±å±žäºŽåˆšæ€§äº‹åŠ¡ã€‚

![img](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fguide-blog-images.oss-cn-shenzhen.aliyuncs.com%2Fgithub%2Fjavaguide%2Fdistributed-system%2Fdistributed-transaction%2Fdistributed-transaction-solution-summary.png&sign=1d3e071788d14785e0177c96a4c6387a6ad3dd37625f5b7a5a9c0f3201868067)

#### åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ

åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆæœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼š**2PCã€3PCã€TCCã€æœ¬åœ°æ¶ˆæ¯è¡¨ã€MQ äº‹åŠ¡ï¼ˆKafka å’Œ RocketMQ éƒ½æä¾›äº†äº‹åŠ¡ç›¸å…³åŠŸèƒ½ï¼‰ ã€Saga** ç­‰ç­‰ã€‚

2PCã€3PC å±žäºŽä¸šåŠ¡ä»£ç æ— ä¾µå…¥æ–¹æ¡ˆï¼Œéƒ½æ˜¯åŸºäºŽ XA è§„èŒƒè¡ç”Ÿå‡ºæ¥çš„å®žçŽ°ï¼ŒXA è§„èŒƒæ˜¯ X/Open ç»„ç»‡å®šä¹‰çš„åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ï¼ˆDTPï¼ŒDistributed
Transaction Processingï¼‰æ ‡å‡†ã€‚TCCã€Saga å±žäºŽä¸šåŠ¡ä¾µå…¥æ–¹æ¡ˆï¼ŒMQ äº‹åŠ¡ä¾èµ–äºŽä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„åœºæ™¯ï¼Œæœ¬åœ°æ¶ˆæ¯è¡¨ä¸æ”¯æŒå›žæ»šã€‚

è¿™äº›æ–¹æ¡ˆçš„é€‚ç”¨åœºæ™¯æœ‰æ‰€åŒºåˆ«ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å…·ä½“çš„åœºæ™¯é€‰æ‹©é€‚åˆè‡ªå·±é¡¹ç›®çš„è§£å†³æ–¹æ¡ˆã€‚

å¼€å§‹ä»‹ç» 2PC å’Œ 3PC ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ä»‹ç»ä¸€ä¸‹ 2PC å’Œ 3PC æ¶‰åŠåˆ°çš„ä¸€äº›è§’è‰²ï¼ˆXA è§„èŒƒçš„è§’è‰²ç»„æˆï¼‰ï¼š

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fguide-blog-images.oss-cn-shenzhen.aliyuncs.com%2Fgithub%2Fjavaguide%2Fdistributed-system%2Fdistributed-transaction%2Fxa-specification-roles.png)

- **APï¼ˆApplication Programï¼‰**ï¼šåº”ç”¨ç¨‹åºæœ¬èº«ã€‚
- **RMï¼ˆResource Managerï¼‰** ï¼šèµ„æºç®¡ç†å™¨ï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡çš„å‚ä¸Žè€…ï¼Œç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹å°±æ˜¯æŒ‡æ•°æ®åº“ï¼ˆåŽæ–‡ä¼šä»¥å…³ç³»åž‹æ•°æ®åº“ä¸ºä¾‹ï¼‰ï¼Œä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡å¾€å¾€æ¶‰åŠåˆ°å¤šä¸ª
  RMã€‚
- **TMï¼ˆTransaction Managerï¼‰** ï¼šäº‹åŠ¡ç®¡ç†å™¨ï¼Œè´Ÿè´£ç®¡ç†å…¨å±€äº‹åŠ¡ï¼Œåˆ†é…äº‹åŠ¡å”¯ä¸€æ ‡è¯†ï¼Œç›‘æŽ§äº‹åŠ¡çš„æ‰§è¡Œè¿›åº¦ï¼Œå¹¶è´Ÿè´£äº‹åŠ¡çš„æäº¤ã€å›žæ»šã€å¤±è´¥æ¢å¤ç­‰ã€‚

##### **2PCï¼ˆä¸¤é˜¶æ®µæäº¤åè®®ï¼‰**

![2pc-work-flow.png](é¢è¯•æŒ‡åŒ—.assets/1666839398805-8d026011-316f-497a-9c11-e5a2e4a4b669.png)

2PCï¼ˆTwo-Phase Commitï¼‰è¿™ä¸‰ä¸ªå­—æ¯çš„å«ä¹‰:

- **2** -> æŒ‡ä»£äº‹åŠ¡æäº¤çš„ 2 ä¸ªé˜¶æ®µ
- **P**-> Prepare (å‡†å¤‡é˜¶æ®µ)
- **C** ->Commitï¼ˆæäº¤é˜¶æ®µï¼‰

2PC å°†äº‹åŠ¡çš„æäº¤è¿‡ç¨‹åˆ†ä¸º 2 ä¸ªé˜¶æ®µï¼š**å‡†å¤‡é˜¶æ®µ** å’Œ **æäº¤é˜¶æ®µ** ã€‚

###### å‡†å¤‡é˜¶æ®µ(Prepare)

å‡†å¤‡é˜¶æ®µçš„æ ¸å¿ƒæ˜¯â€œè¯¢é—®â€äº‹åŠ¡å‚ä¸Žè€…æ‰§è¡Œæœ¬åœ°æ•°æ®åº“äº‹åŠ¡æ“ä½œæ˜¯å¦æˆåŠŸã€‚

å‡†å¤‡é˜¶æ®µçš„å·¥ä½œæµç¨‹ï¼š

1. **äº‹åŠ¡åè°ƒè€…/ç®¡ç†è€…ï¼ˆåŽæ–‡ç®€ç§° TMï¼‰** å‘æ‰€æœ‰æ¶‰åŠåˆ°çš„ **äº‹åŠ¡å‚ä¸Žè€…ï¼ˆåŽæ–‡ç®€ç§° RMï¼‰** å‘é€æ¶ˆæ¯è¯¢é—®ï¼šâ€œä½ æ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡æ“ä½œå‘¢ï¼Ÿâ€ï¼Œå¹¶ç­‰å¾…å…¶ç­”å¤ã€‚
2. **RM** æŽ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åŽï¼Œå¼€å§‹æ‰§è¡Œæœ¬åœ°æ•°æ®åº“äº‹åŠ¡é¢„æ“ä½œæ¯”å¦‚å†™ redo log/undo log æ—¥å¿—ï¼Œ**æ­¤æ—¶å¹¶ä¸ä¼šæäº¤äº‹åŠ¡** ã€‚
3. **RM** å¦‚æžœæ‰§è¡Œæœ¬åœ°æ•°æ®åº“äº‹åŠ¡æ“ä½œæˆåŠŸï¼Œé‚£å°±å›žå¤â€œYesâ€è¡¨ç¤ºæˆ‘å·²å°±ç»ªï¼Œå¦åˆ™å°±å›žå¤â€œNoâ€è¡¨ç¤ºæˆ‘æœªå°±ç»ªã€‚

###### æäº¤é˜¶æ®µ(Commit)

æäº¤é˜¶æ®µçš„æ ¸å¿ƒæ˜¯â€œè¯¢é—®â€äº‹åŠ¡å‚ä¸Žè€…æäº¤æœ¬åœ°äº‹åŠ¡æ˜¯å¦æˆåŠŸã€‚

å½“æ‰€æœ‰äº‹åŠ¡å‚ä¸Žè€…éƒ½æ˜¯â€œå°±ç»ªâ€çŠ¶æ€çš„è¯ï¼š

1. **TM** å‘æ‰€æœ‰å‚ä¸Žè€…å‘é€æ¶ˆæ¯ï¼šâ€œä½ ä»¬å¯ä»¥æäº¤äº‹åŠ¡å•¦ï¼â€ï¼ˆ**Commit æ¶ˆæ¯**ï¼‰
2. **RM** æŽ¥æ”¶åˆ° **Commit æ¶ˆæ¯** åŽæ‰§è¡Œ **æäº¤æœ¬åœ°æ•°æ®åº“äº‹åŠ¡** æ“ä½œï¼Œæ‰§è¡Œå®Œæˆä¹‹åŽ **é‡Šæ”¾æ•´ä¸ªäº‹åŠ¡æœŸé—´æ‰€å ç”¨çš„èµ„æº**ã€‚
3. **RM** å›žå¤ï¼šâ€œäº‹åŠ¡å·²ç»æäº¤â€ ï¼ˆ**ACK æ¶ˆæ¯**ï¼‰ã€‚
4. **TM** æ”¶åˆ°æ‰€æœ‰ **äº‹åŠ¡å‚ä¸Žè€…** çš„ **ACK æ¶ˆæ¯** ä¹‹åŽï¼Œæ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡è¿‡ç¨‹æ­£å¼ç»“æŸã€‚

![img](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fguide-blog-images.oss-cn-shenzhen.aliyuncs.com%2Fgithub%2Fjavaguide%2Fdistributed-system%2Fdistributed-transaction%2Fdistributed-transaction-2pc-ready.png&sign=513d60918c71581a01b67490b0c565cbf884db266ad905ec52ce09377eca9b76)

å½“ä»»ä¸€äº‹åŠ¡å‚ä¸Žè€…æ˜¯â€œæœªå°±ç»ªâ€çŠ¶æ€çš„è¯ï¼š

1. **TM** å‘æ‰€æœ‰å‚ä¸Žè€…å‘é€æ¶ˆæ¯ï¼šâ€œä½ ä»¬å¯ä»¥æ‰§è¡Œå›žæ»šæ“ä½œäº†ï¼â€ï¼ˆ**Rollback æ¶ˆæ¯**ï¼‰ã€‚
2. **RM** æŽ¥æ”¶åˆ° **Rollback æ¶ˆæ¯** åŽæ‰§è¡Œ **æœ¬åœ°æ•°æ®åº“äº‹åŠ¡å›žæ»š** æ‰§è¡Œå®Œæˆä¹‹åŽ **é‡Šæ”¾æ•´ä¸ªäº‹åŠ¡æœŸé—´æ‰€å ç”¨çš„èµ„æº**ã€‚
3. **RM** å›žå¤ï¼šâ€œäº‹åŠ¡å·²ç»å›žæ»šâ€ ï¼ˆ**ACK æ¶ˆæ¯**ï¼‰ã€‚
4. **TM** æ”¶åˆ°æ‰€æœ‰ **RM** çš„ **ACK æ¶ˆæ¯** ä¹‹åŽï¼Œä¸­æ–­äº‹åŠ¡ã€‚

![img](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fguide-blog-images.oss-cn-shenzhen.aliyuncs.com%2Fgithub%2Fjavaguide%2Fdistributed-system%2Fdistributed-transaction%2Fdistributed-transaction-2pc-not-ready.png&sign=b05caeeb0d69ef8255689bf378c5bb046108ff3b94f06d91c514d09b2b485f3c)

###### æ€»ç»“

ç®€å•æ€»ç»“ä¸€ä¸‹ **2PC** ä¸¤é˜¶æ®µä¸­æ¯”è¾ƒé‡è¦çš„ä¸€äº›ç‚¹ï¼š

1. **å‡†å¤‡é˜¶æ®µ** çš„ä¸»è¦ç›®çš„æ˜¯æµ‹è¯• **RM** èƒ½å¦æ‰§è¡Œ **æœ¬åœ°æ•°æ®åº“äº‹åŠ¡** æ“ä½œï¼ˆ!!!æ³¨æ„ï¼šè¿™ä¸€æ­¥å¹¶ä¸ä¼šæäº¤äº‹åŠ¡ï¼‰ã€‚
2. **æäº¤é˜¶æ®µ** ä¸­ **TM** ä¼šæ ¹æ® **å‡†å¤‡é˜¶æ®µ** ä¸­ **RM** çš„æ¶ˆæ¯æ¥å†³å®šæ˜¯æ‰§è¡Œäº‹åŠ¡æäº¤è¿˜æ˜¯å›žæ»šæ“ä½œã€‚
3. **æäº¤é˜¶æ®µ** ä¹‹åŽä¸€å®šä¼šç»“æŸå½“å‰çš„åˆ†å¸ƒå¼äº‹åŠ¡

**2PC çš„ä¼˜ç‚¹ï¼š**

- å®žçŽ°èµ·æ¥éžå¸¸ç®€å•ï¼Œå„å¤§ä¸»æµæ•°æ®åº“æ¯”å¦‚ MySQLã€Oracle éƒ½æœ‰è‡ªå·±å®žçŽ°ã€‚
- é’ˆå¯¹çš„æ˜¯æ•°æ®å¼ºä¸€è‡´æ€§ã€‚ä¸è¿‡ï¼Œä»ç„¶å¯èƒ½å­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚

**2PC å­˜åœ¨çš„é—®é¢˜ï¼š**

- **åŒæ­¥é˜»å¡ž** ï¼šäº‹åŠ¡å‚ä¸Žè€…ä¼šåœ¨æ­£å¼æäº¤äº‹åŠ¡ä¹‹å‰ä¼šä¸€ç›´å ç”¨ç›¸å…³çš„èµ„æºã€‚æ¯”å¦‚ç”¨æˆ·å°æ˜Žè½¬è´¦ç»™å°çº¢ï¼Œé‚£å…¶ä»–äº‹åŠ¡ä¹Ÿè¦æ“ä½œç”¨æˆ·å°æ˜Žæˆ–å°çº¢çš„è¯ï¼Œå°±ä¼šé˜»å¡žã€‚
- **æ•°æ®ä¸ä¸€è‡´** ï¼šç”±äºŽç½‘ç»œé—®é¢˜æˆ–è€…TMå®•æœºéƒ½æœ‰å¯èƒ½ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚æ¯”å¦‚åœ¨ç¬¬2é˜¶æ®µï¼ˆæäº¤é˜¶æ®µï¼‰ï¼Œéƒ¨åˆ†ç½‘ç»œå‡ºçŽ°é—®é¢˜å¯¼è‡´éƒ¨åˆ†å‚ä¸Žè€…æ”¶ä¸åˆ°
  Commit/Rollback æ¶ˆæ¯çš„è¯ï¼Œå°±ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚
- **å•ç‚¹é—®é¢˜** ï¼š TMåœ¨å…¶ä¸­ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„è§’è‰²ï¼Œå¦‚æžœTMåœ¨å‡†å¤‡(Prepare)é˜¶æ®µå®Œæˆä¹‹åŽæŒ‚æŽ‰çš„è¯ï¼Œäº‹åŠ¡å‚ä¸Žè€…å°±ä¼šä¸€ç›´å¡åœ¨æäº¤(
  Commit)é˜¶æ®µã€‚

##### **3PCï¼ˆä¸‰é˜¶æ®µæäº¤åè®®ï¼‰**

![3pc-work-flow.png](é¢è¯•æŒ‡åŒ—.assets/1666839392078-2129a477-9728-4d28-8b47-8aa4fd74570c.png)

3PC æ˜¯äººä»¬åœ¨ 2PC çš„åŸºç¡€ä¸Šåšäº†ä¸€äº›ä¼˜åŒ–å¾—åˆ°çš„ã€‚3PC æŠŠ 2PC ä¸­çš„ **å‡†å¤‡é˜¶æ®µ(Prepare)** åšäº†è¿›ä¸€æ­¥ç»†åŒ–ï¼Œåˆ†ä¸º 2 ä¸ªé˜¶æ®µï¼š

- å‡†å¤‡é˜¶æ®µ(CanCommit)
- é¢„æäº¤é˜¶æ®µ(PreCommit)

![img](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fguide-blog-images.oss-cn-shenzhen.aliyuncs.com%2Fgithub%2Fjavaguide%2Fdistributed-system%2Fdistributed-transaction%2Fdistributed-transaction-3pc-ready.png&sign=8368a51b88493f73dbfe67cf0efcb82a02ea4ef098a5ab7873911e1865802e2f)

###### å‡†å¤‡é˜¶æ®µ(CanCommit)

è¿™ä¸€æ­¥ä¸ä¼šæ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œåªæ˜¯å‘ RM å‘é€ **å‡†å¤‡è¯·æ±‚** ï¼Œé¡ºä¾¿è¯¢é—®ä¸€äº›ä¿¡æ¯æ¯”å¦‚äº‹åŠ¡å‚ä¸Žè€…èƒ½å¦æ‰§è¡Œæœ¬åœ°æ•°æ®åº“äº‹åŠ¡æ“ä½œã€‚RM
å›žå¤â€œYesâ€ã€â€œNoâ€æˆ–è€…ç›´æŽ¥è¶…æ—¶ã€‚

å¦‚æžœä»»ä¸€ RM å›žå¤â€œNoâ€æˆ–è€…ç›´æŽ¥è¶…æ—¶çš„è¯ï¼Œå°±ä¸­æ–­äº‹åŠ¡ï¼ˆå‘æ‰€æœ‰å‚ä¸Žè€…å‘é€â€œAbortâ€æ¶ˆæ¯ï¼‰ï¼Œå¦åˆ™è¿›å…¥ **é¢„æäº¤é˜¶æ®µ(PreCommit)** ã€‚

###### é¢„æäº¤é˜¶æ®µ(PreCommit)

TM å‘æ‰€æœ‰æ¶‰åŠåˆ°çš„ RM å‘é€ **é¢„æäº¤è¯·æ±‚** ï¼ŒRM å›žå¤â€œYesâ€ã€â€œNoâ€ï¼ˆæœ€åŽçš„åæ‚”æœºä¼šï¼‰æˆ–è€…ç›´æŽ¥è¶…æ—¶ã€‚

å¦‚æžœä»»ä¸€ RM å›žå¤â€œNoâ€æˆ–è€…ç›´æŽ¥è¶…æ—¶çš„è¯ï¼Œå°±ä¸­æ–­äº‹åŠ¡ï¼ˆå‘æ‰€æœ‰äº‹åŠ¡å‚ä¸Žè€…å‘é€â€œabortâ€æ¶ˆæ¯ï¼‰ï¼Œå¦åˆ™è¿›å…¥ **æ‰§è¡Œäº‹åŠ¡æäº¤é˜¶æ®µï¼ˆDoCommitï¼‰
** ã€‚

å½“æ‰€æœ‰ RM éƒ½è¿”å›žâ€œYesâ€ä¹‹åŽï¼Œ RM æ‰ä¼šæ‰§è¡Œæœ¬åœ°æ•°æ®åº“äº‹åŠ¡é¢„æ“ä½œæ¯”å¦‚å†™ redo log/undo log æ—¥å¿—ã€‚

###### æ‰§è¡Œäº‹åŠ¡æäº¤é˜¶æ®µï¼ˆDoCommitï¼‰

**æ‰§è¡Œäº‹åŠ¡æäº¤ï¼ˆDoCommitï¼‰** é˜¶æ®µå°±å¼€å§‹è¿›è¡ŒçœŸæ­£çš„äº‹åŠ¡æäº¤ã€‚

TM å‘æ‰€æœ‰æ¶‰åŠåˆ°çš„ RM å‘é€ **æ‰§è¡Œäº‹åŠ¡æäº¤è¯·æ±‚** ï¼ŒRM æ”¶åˆ°æ¶ˆæ¯åŽå¼€å§‹æ­£å¼æäº¤äº‹åŠ¡ï¼Œå¹¶åœ¨å®Œæˆäº‹åŠ¡æäº¤åŽé‡Šæ”¾å ç”¨çš„èµ„æºã€‚

å¦‚æžœ TM æ”¶åˆ°æ‰€æœ‰ RM æ­£ç¡®æäº¤äº‹åŠ¡çš„æ¶ˆæ¯çš„è¯ï¼Œè¡¨ç¤ºäº‹åŠ¡æ­£å¸¸å®Œæˆã€‚å¦‚æžœä»»ä¸€ RM æ²¡æœ‰æ­£ç¡®æäº¤äº‹åŠ¡æˆ–è€…è¶…æ—¶çš„è¯ï¼Œå°±ä¸­æ–­äº‹åŠ¡ï¼ŒTM å‘æ‰€æœ‰
RM å‘é€â€œAbortâ€æ¶ˆæ¯ã€‚RM æŽ¥æ”¶åˆ° Abort è¯·æ±‚åŽï¼Œæ‰§è¡Œæœ¬åœ°æ•°æ®åº“äº‹åŠ¡å›žæ»šï¼ŒåŽé¢çš„æ­¥éª¤å°±å’Œ 2PC ä¸­çš„ç±»ä¼¼äº†ã€‚

###### æ€»ç»“

**3PC é™¤äº†å°†2PC ä¸­çš„å‡†å¤‡é˜¶æ®µ(Prepare) åšäº†è¿›ä¸€æ­¥ç»†åŒ–ä¹‹å¤–ï¼Œè¿˜åšäº†å“ªäº›æ”¹è¿›ï¼Ÿ**

3PC è¿˜åŒæ—¶åœ¨äº‹åŠ¡ç®¡ç†è€…å’Œäº‹åŠ¡å‚ä¸Žè€…ä¸­å¼•å…¥äº† **è¶…æ—¶æœºåˆ¶** ï¼Œå¦‚æžœåœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°äº‹åŠ¡å‚ä¸Žè€…çš„æ¶ˆæ¯å°±é»˜è®¤å¤±è´¥ï¼Œè¿›è€Œé¿å…äº‹åŠ¡å‚ä¸Žè€…ä¸€ç›´é˜»å¡žå ç”¨èµ„æºã€‚2PC
ä¸­åªæœ‰äº‹åŠ¡ç®¡ç†è€…æ‰æ‹¥æœ‰è¶…æ—¶æœºåˆ¶ï¼Œå½“äº‹åŠ¡å‚ä¸Žè€…é•¿æ—¶é—´æ— æ³•ä¸Žäº‹åŠ¡åè°ƒè€…é€šè®¯çš„æƒ…å†µä¸‹ï¼ˆæ¯”å¦‚åè°ƒè€…æŒ‚æŽ‰äº†ï¼‰ï¼Œå°±ä¼šå¯¼è‡´æ— æ³•é‡Šæ”¾èµ„æºé˜»å¡žçš„é—®é¢˜ã€‚

ä¸è¿‡ï¼Œ3PC å¹¶æ²¡æœ‰å®Œç¾Žè§£å†³ 2PC çš„é˜»å¡žé—®é¢˜ï¼Œå¼•å…¥äº†ä¸€äº›æ–°é—®é¢˜æ¯”å¦‚æ€§èƒ½ç³Ÿç³•ï¼Œè€Œä¸”ï¼Œä¾ç„¶å­˜åœ¨æ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚å› æ­¤ï¼Œ3PC
çš„å®žé™…åº”ç”¨å¹¶ä¸æ˜¯å¾ˆå¹¿æ³›ï¼Œå¤šæ•°åº”ç”¨ä¼šé€‰æ‹©é€šè¿‡å¤åˆ¶çŠ¶æ€æœºè§£å†³ 2PC çš„é˜»å¡žé—®é¢˜ã€‚

##### TCCï¼ˆè¡¥å¿äº‹åŠ¡ï¼‰

TCC å±žäºŽç›®å‰æ¯”è¾ƒç«çš„ä¸€ç§æŸ”æ€§äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚TCC è¿™ä¸ªæ¦‚å¿µæœ€æ—©è¯žç”ŸäºŽæ•°æ®åº“ä¸“å®¶å¸•ç‰¹ Â· èµ«å…°å¾·ï¼ˆPat Hellandï¼‰äºŽ 2007
å‘è¡¨çš„ [ã€ŠLife beyond Distributed Transactions: an Apostateâ€™s Opinionã€‹](https://www.ics.uci.edu/~cs223/papers/cidr07p15.pdf)
è¿™ç¯‡è®ºæ–‡ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥é˜…è¯»ä¸€ä¸‹è¿™ç¯‡è®ºæ–‡ã€‚

ç®€å•æ¥è¯´ï¼ŒTCC æ˜¯ Tryã€Confirmã€Cancel ä¸‰ä¸ªè¯çš„ç¼©å†™ï¼Œå®ƒåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

1. **Tryï¼ˆå°è¯•ï¼‰é˜¶æ®µ** : å°è¯•æ‰§è¡Œã€‚å®Œæˆä¸šåŠ¡æ£€æŸ¥ï¼Œå¹¶é¢„ç•™å¥½å¿…éœ€çš„ä¸šåŠ¡èµ„æºã€‚
2. **Confirmï¼ˆç¡®è®¤ï¼‰é˜¶æ®µ** ï¼šç¡®è®¤æ‰§è¡Œã€‚å½“æ‰€æœ‰äº‹åŠ¡å‚ä¸Žè€…çš„ Try é˜¶æ®µæ‰§è¡ŒæˆåŠŸå°±ä¼šæ‰§è¡Œ Confirm ï¼ŒConfirm é˜¶æ®µä¼šå¤„ç† Try
   é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºã€‚å¦åˆ™ï¼Œå°±ä¼šæ‰§è¡Œ Cancel ã€‚
3. **Cancelï¼ˆå–æ¶ˆï¼‰é˜¶æ®µ** ï¼šå–æ¶ˆæ‰§è¡Œï¼Œé‡Šæ”¾ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºã€‚

æ¯ä¸ªé˜¶æ®µç”±ä¸šåŠ¡ä»£ç æŽ§åˆ¶ï¼Œè¿™æ ·å¯ä»¥é¿å…é•¿äº‹åŠ¡ï¼Œæ€§èƒ½æ›´å¥½ã€‚

æˆ‘ä»¬æ‹¿è½¬è´¦åœºæ™¯æ¥è¯´ï¼š

1. **Tryï¼ˆå°è¯•ï¼‰é˜¶æ®µ** : åœ¨è½¬è´¦åœºæ™¯ä¸‹ï¼ŒTry è¦åšçš„äº‹æƒ…æ˜¯å°±æ˜¯æ£€æŸ¥è´¦æˆ·ä½™é¢æ˜¯å¦å……è¶³ï¼Œé¢„ç•™çš„èµ„æºå°±æ˜¯è½¬è´¦èµ„é‡‘ã€‚
2. **Confirmï¼ˆç¡®è®¤ï¼‰é˜¶æ®µ** ï¼š å¦‚æžœ Try é˜¶æ®µæ‰§è¡ŒæˆåŠŸçš„è¯ï¼ŒConfirm é˜¶æ®µå°±ä¼šæ‰§è¡ŒçœŸæ­£çš„æ‰£é’±æ“ä½œã€‚
3. **Cancelï¼ˆå–æ¶ˆï¼‰é˜¶æ®µ** ï¼šé‡Šæ”¾ Try é˜¶æ®µé¢„ç•™çš„è½¬è´¦èµ„é‡‘ã€‚

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨`TCC`æ¨¡å¼çš„æ—¶å€™ï¼Œéœ€è¦è‡ªå·±å®žçŽ° `try`, `confirm`, `cancel `è¿™ä¸‰ä¸ªæ–¹æ³•ï¼Œæ¥è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚

æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¼šæ‰§è¡Œ `try`, `confirm` æ–¹æ³•ã€‚

![img](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fguide-blog-images.oss-cn-shenzhen.aliyuncs.com%2Fgithub%2Fjavaguide%2Fdistributed-system%2Fdistributed-transaction%2Fdistributed-transaction-tcc-confirm.png&sign=82dc875113cad8430e870b66d153590ac5736da4e7bba748ec2422fd79137ecf)

å‡ºçŽ°å¼‚å¸¸çš„è¯ï¼Œä¼šæ‰§è¡Œ `try`,` cancel` æ–¹æ³•ã€‚

![img](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fguide-blog-images.oss-cn-shenzhen.aliyuncs.com%2Fgithub%2Fjavaguide%2Fdistributed-system%2Fdistributed-transaction%2Fdistributed-transaction-tcc-cancel.png&sign=33784c922ea4e16f29df6d994d4a6947299170634a68cbc30e13299b8ca5a133)

Try é˜¶æ®µå‡ºçŽ°é—®é¢˜çš„è¯ï¼Œå¯ä»¥æ‰§è¡Œ Cancelã€‚**é‚£å¦‚æžœ Confirm æˆ–è€… Cancel é˜¶æ®µå¤±è´¥äº†æ€Žä¹ˆåŠžå‘¢ï¼Ÿ**

TCC ä¼šè®°å½•äº‹åŠ¡æ—¥å¿—å¹¶æŒä¹…åŒ–äº‹åŠ¡æ—¥å¿—åˆ°æŸç§å­˜å‚¨ä»‹è´¨ä¸Šæ¯”å¦‚æœ¬åœ°æ–‡ä»¶ã€å…³ç³»åž‹æ•°æ®åº“ã€Zookeeperï¼Œäº‹åŠ¡æ—¥å¿—åŒ…å«äº†äº‹åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ï¼Œé€šè¿‡äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€å¯ä»¥åˆ¤æ–­å‡ºäº‹åŠ¡æ˜¯æäº¤æˆåŠŸäº†è¿˜æ˜¯æäº¤å¤±è´¥äº†ï¼Œä»¥åŠå…·ä½“å¤±è´¥åœ¨å“ªä¸€æ­¥ã€‚å¦‚æžœå‘çŽ°æ˜¯
Confirm æˆ–è€… Cancel é˜¶æ®µå¤±è´¥çš„è¯ï¼Œä¼šè¿›è¡Œé‡è¯•ï¼Œç»§ç»­å°è¯•æ‰§è¡Œ Confirm æˆ–è€… Cancel é˜¶æ®µçš„é€»è¾‘ã€‚é‡è¯•çš„æ¬¡æ•°é€šå¸¸ä¸º 6
æ¬¡ï¼Œå¦‚æžœè¶…è¿‡é‡è¯•çš„æ¬¡æ•°è¿˜æœªæˆåŠŸæ‰§è¡Œçš„è¯ï¼Œå°±éœ€è¦äººå·¥ä»‹å…¥å¤„ç†äº†ã€‚

å¦‚æžœä»£ç æ²¡æœ‰ç‰¹æ®Š Bug çš„è¯ï¼ŒConfirm æˆ–è€… Cancel é˜¶æ®µå‡ºçŽ°é—®é¢˜çš„æ¦‚çŽ‡æ˜¯æ¯”è¾ƒå°çš„ã€‚

**äº‹åŠ¡æ—¥å¿—ä¼šè¢«åˆ é™¤å—ï¼Ÿ** ä¼šçš„ã€‚å¦‚æžœäº‹åŠ¡æäº¤æˆåŠŸï¼ˆæ²¡æœ‰æŠ›å‡ºä»»ä½•å¼‚å¸¸ï¼‰ï¼Œå°±å¯ä»¥åˆ é™¤å¯¹åº”çš„äº‹åŠ¡æ—¥å¿—ï¼ŒèŠ‚çœèµ„æºã€‚

**TCC æ¨¡å¼ä¸éœ€è¦ä¾èµ–äºŽåº•å±‚æ•°æ®èµ„æºçš„äº‹åŠ¡æ”¯æŒï¼Œä½†æ˜¯éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å®žçŽ°æ›´å¤šçš„ä»£ç **ï¼Œå±žäºŽ **ä¾µå…¥ä¸šåŠ¡ä»£ç  çš„ä¸€ç§åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆ
**ã€‚

TCC äº‹åŠ¡æ¨¡åž‹çš„æ€æƒ³ç±»ä¼¼ 2PCï¼Œæˆ‘ç®€å•èŠ±äº†ä¸€å¼ å›¾å¯¹æ¯”ä¸€ä¸‹äºŒè€…ã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fguide-blog-images.oss-cn-shenzhen.aliyuncs.com%2Fgithub%2Fjavaguide%2Fdistributed-system%2Fdistributed-transaction%2F2pc-vs-tcc.png)

**TCC å’Œ 2PC/3PC æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ**

- 2PC/3PC ä¾é æ•°æ®åº“æˆ–è€…å­˜å‚¨èµ„æºå±‚é¢çš„äº‹åŠ¡ï¼ŒTCC ä¸»è¦é€šè¿‡ä¿®æ”¹ä¸šåŠ¡ä»£ç æ¥å®žçŽ°ã€‚

- 2PC/3PC å±žäºŽä¸šåŠ¡ä»£ç æ— ä¾µå…¥çš„ï¼ŒTCC å¯¹ä¸šåŠ¡ä»£ç æœ‰ä¾µå…¥ã€‚

- 2PC/3PC è¿½æ±‚çš„æ˜¯å¼ºä¸€è‡´æ€§ï¼Œåœ¨ä¸¤é˜¶æ®µæäº¤çš„æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸€ç›´ä¼šæŒæœ‰æ•°æ®åº“çš„é”ã€‚TCC è¿½æ±‚çš„æ˜¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸ä¼šä¸€ç›´æŒæœ‰å„ä¸ªä¸šåŠ¡èµ„æºçš„é”ã€‚

é’ˆå¯¹ TCC çš„å®žçŽ°ï¼Œä¸šç•Œä¹Ÿæœ‰ä¸€äº›ä¸é”™çš„å¼€æºæ¡†æž¶ã€‚ä¸åŒçš„æ¡†æž¶å¯¹äºŽ TCC çš„å®žçŽ°å¯èƒ½ç•¥æœ‰ä¸åŒï¼Œä¸è¿‡å¤§è‡´æ€æƒ³éƒ½ä¸€æ ·ã€‚

1. [ByteTCC](https://github.com/liuyangming/ByteTCC) : ByteTCC æ˜¯åŸºäºŽ Try-Confirm-Cancelï¼ˆTCCï¼‰æœºåˆ¶çš„åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†å™¨çš„å®žçŽ°ã€‚
   ç›¸å…³é˜…è¯»ï¼š[å…³äºŽå¦‚ä½•å®žçŽ°ä¸€ä¸ª TCC åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æž¶çš„ä¸€ç‚¹æ€è€ƒ](https://www.bytesoft.org/how-to-impl-tcc/)

2. [Seata](https://seata.io/zh-cn/index.html) :Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºŽåœ¨å¾®æœåŠ¡æž¶æž„ä¸‹æä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚

3. [Hmily](https://gitee.com/shuaiqiyu/hmily) : é‡‘èžçº§åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚

##### MQ äº‹åŠ¡

RocketMQ ã€ Kafkaã€Pulsar ã€QMQ éƒ½æä¾›äº†äº‹åŠ¡ç›¸å…³çš„åŠŸèƒ½ã€‚äº‹åŠ¡å…è®¸äº‹ä»¶æµåº”ç”¨å°†æ¶ˆè´¹ï¼Œå¤„ç†ï¼Œç”Ÿäº§æ¶ˆæ¯æ•´ä¸ªè¿‡ç¨‹å®šä¹‰ä¸ºä¸€ä¸ªåŽŸå­æ“ä½œã€‚

è¿™é‡Œæˆ‘ä»¬æ‹¿ RocketMQ
æ¥è¯´ï¼ˆå›¾æºï¼šã€Šæ¶ˆæ¯é˜Ÿåˆ—é«˜æ‰‹è¯¾ã€‹ï¼‰ã€‚ç›¸å…³é˜…è¯»ï¼š[RocketMQ äº‹åŠ¡æ¶ˆæ¯å‚è€ƒæ–‡æ¡£](https://rocketmq.apache.org/docs/transaction-example/) ã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2F2021060810404597.png)

1. MQ å‘é€æ–¹ï¼ˆæ¯”å¦‚ç‰©æµæœåŠ¡ï¼‰åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸Šå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œç„¶åŽå‘é€ä¸€ä¸ªâ€œåŠæ¶ˆæ¯â€ç»™ MQ Server/Brokerã€‚äº‹åŠ¡æäº¤ä¹‹å‰ï¼ŒåŠæ¶ˆæ¯å¯¹äºŽ MQ
   è®¢é˜…æ–¹/æ¶ˆè´¹è€…ï¼ˆæ¯”å¦‚ç¬¬ä¸‰æ–¹é€šçŸ¥æœåŠ¡ï¼‰ä¸å¯è§
2. â€œåŠæ¶ˆæ¯â€å‘é€æˆåŠŸçš„è¯ï¼ŒMQ å‘é€æ–¹å°±å¼€å§‹æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ã€‚
3. MQ å‘é€æ–¹çš„æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸçš„è¯ï¼Œâ€œåŠæ¶ˆæ¯â€å˜æˆæ­£å¸¸æ¶ˆæ¯ï¼Œå¯ä»¥æ­£å¸¸è¢«æ¶ˆè´¹ã€‚MQ å‘é€æ–¹çš„æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå¤±è´¥çš„è¯ï¼Œä¼šç›´æŽ¥å›žæ»šã€‚

ä»Žä¸Šé¢çš„æµç¨‹ä¸­å¯ä»¥çœ‹å‡ºï¼ŒMQ çš„äº‹åŠ¡æ¶ˆæ¯ä½¿ç”¨çš„æ˜¯ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰ï¼Œç®€å•æ¥è¯´å°±æ˜¯å’±å…ˆå‘é€åŠæ¶ˆæ¯ï¼Œç­‰æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸä¹‹åŽï¼ŒåŠæ¶ˆæ¯æ‰å˜ä¸ºæ­£å¸¸æ¶ˆæ¯ã€‚

**å¦‚æžœ MQ å‘é€æ–¹æäº¤æˆ–è€…å›žæ»šäº‹åŠ¡æ¶ˆæ¯æ—¶å¤±è´¥æ€Žä¹ˆåŠžï¼Ÿ**

RocketMQ ä¸­çš„ Broker ä¼šå®šæœŸåŽ» MQ å‘é€æ–¹ä¸ŠåæŸ¥è¿™ä¸ªäº‹åŠ¡çš„æœ¬åœ°äº‹åŠ¡çš„æ‰§è¡Œæƒ…å†µï¼Œå¹¶æ ¹æ®åæŸ¥ç»“æžœå†³å®šæäº¤æˆ–è€…å›žæ»šè¿™ä¸ªäº‹åŠ¡ã€‚

äº‹åŠ¡åæŸ¥æœºåˆ¶çš„å®žçŽ°ä¾èµ–äºŽæˆ‘ä»¬ä¸šåŠ¡ä»£ç å®žçŽ°çš„å¯¹åº”çš„æŽ¥å£ï¼Œæ¯”å¦‚ä½ è¦æŸ¥çœ‹åˆ›å»ºç‰©æµä¿¡æ¯çš„æœ¬åœ°äº‹åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸçš„è¯ï¼Œç›´æŽ¥åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢å¯¹åº”çš„ç‰©æµä¿¡æ¯æ˜¯å¦å­˜åœ¨å³å¯ã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2F20210608114710962.png)

å¦‚æžœæ­£å¸¸æ¶ˆæ¯æ²¡æœ‰è¢«æ­£ç¡®æ¶ˆè´¹æ€Žä¹ˆåŠžå‘¢ï¼Ÿ

æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥çš„è¯ï¼ŒRocketMQ ä¼šè‡ªåŠ¨è¿›è¡Œæ¶ˆè´¹é‡è¯•ã€‚å¦‚æžœè¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°è¿™ä¸ªæ¶ˆæ¯è¿˜æ˜¯æ²¡æœ‰æ­£ç¡®æ¶ˆè´¹ï¼ŒRocketMQ å°±ä¼šè®¤ä¸ºè¿™ä¸ªæ¶ˆæ¯æœ‰é—®é¢˜ï¼Œç„¶åŽå°†å…¶æ”¾åˆ°
æ­»ä¿¡é˜Ÿåˆ—ã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2F20210608120207740.png)

è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—çš„æ¶ˆè´¹ä¸€èˆ¬éœ€è¦äººå·¥å¤„ç†ï¼Œæ‰‹åŠ¨æŽ’æŸ¥é—®é¢˜ã€‚

**QMQ**  çš„äº‹åŠ¡æ¶ˆæ¯å°±æ²¡æœ‰ RocketMQ å®žçŽ°çš„é‚£ä¹ˆå¤æ‚äº†ï¼Œå®ƒå€ŸåŠ©äº†æ•°æ®åº“è‡ªå¸¦çš„äº‹åŠ¡åŠŸèƒ½ã€‚å…¶æ ¸å¿ƒæ€æƒ³å…¶å®žå°±æ˜¯ eBay æå‡ºçš„ **æœ¬åœ°æ¶ˆæ¯è¡¨
** æ–¹æ¡ˆï¼Œå°†åˆ†å¸ƒå¼äº‹åŠ¡æ‹†åˆ†æˆæœ¬åœ°äº‹åŠ¡è¿›è¡Œå¤„ç†ã€‚

æˆ‘ä»¬ç»´æŠ¤ä¸€ä¸ªæœ¬åœ°æ¶ˆæ¯è¡¨ç”¨æ¥å­˜æ”¾æ¶ˆæ¯å‘é€çš„çŠ¶æ€ï¼Œä¿å­˜æ¶ˆæ¯å‘é€æƒ…å†µåˆ°æœ¬åœ°æ¶ˆæ¯è¡¨çš„æ“ä½œå’Œä¸šåŠ¡æ“ä½œè¦åœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œæäº¤ã€‚è¿™æ ·çš„è¯ï¼Œä¸šåŠ¡æ‰§è¡ŒæˆåŠŸä»£è¡¨æ¶ˆæ¯è¡¨ä¹Ÿå†™å…¥æˆåŠŸã€‚

ç„¶åŽï¼Œæˆ‘ä»¬å†å•ç‹¬èµ·ä¸€ä¸ªçº¿ç¨‹å®šæ—¶è½®è¯¢æ¶ˆæ¯è¡¨ï¼ŒæŠŠæ²¡å¤„ç†çš„æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯ä¸­é—´ä»¶ã€‚

æ¶ˆæ¯å‘é€æˆåŠŸåŽï¼Œæ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸ºæˆåŠŸæˆ–è€…ç›´æŽ¥åˆ é™¤æ¶ˆæ¯ã€‚

RocketMQ çš„äº‹åŠ¡æ¶ˆæ¯æ–¹æ¡ˆä¸­ï¼Œå¦‚æžœæ¶ˆæ¯é˜Ÿåˆ—æŒ‚æŽ‰ï¼Œæ•°æ®åº“äº‹åŠ¡å°±æ— æ³•æ‰§è¡Œäº†ï¼Œæ•´ä¸ªåº”ç”¨ä¹Ÿå°±æŒ‚æŽ‰äº†ã€‚

QMQ çš„äº‹åŠ¡æ¶ˆæ¯æ–¹æ¡ˆä¸­ï¼Œå³ä½¿æ¶ˆæ¯é˜Ÿåˆ—æŒ‚äº†ä¹Ÿä¸ä¼šå½±å“æ•°æ®åº“äº‹åŠ¡çš„æ‰§è¡Œã€‚

å› æ­¤ï¼ŒQMQ å®žçŽ°çš„æ–¹æ¡ˆèƒ½æ›´åŠ é€‚åº”äºŽå¤§å¤šæ•°ä¸šåŠ¡ã€‚ä¸è¿‡ï¼Œè¿™ç§æ–¹æ³•åŒæ ·é€‚ç”¨äºŽå…¶ä»–æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåªèƒ½è¯´ QMQ å°è£…çš„æ›´å¥½ï¼Œå¼€ç®±å³ç”¨ç½¢äº†ï¼

ç›¸å…³é˜…è¯»ï¼š [é¢è¯•å®˜ï¼šRocketMQ åˆ†å¸ƒå¼äº‹åŠ¡æ¶ˆæ¯çš„ç¼ºç‚¹ï¼Ÿ](https://mp.weixin.qq.com/s/cBx1l1zaThN6_808fMl27g)

##### **Saga**

Saga ç»å¯¹å¯ä»¥è¯´æ˜¯åŽ†å²éžå¸¸æ‚ ä¹…äº†ï¼ŒSaga äº‹åŠ¡ç†è®ºåœ¨ 1987 å¹´ Hector & Kenneth åœ¨ ACM
å‘è¡¨çš„è®ºæ–‡ [ã€ŠSagasã€‹](https://www.cs.cornell.edu/andru/cs711/2002fa/reading/sagas.pdf) ä¸­å°±è¢«æå‡ºäº†ï¼Œæ—©äºŽåˆ†å¸ƒå¼äº‹åŠ¡æ¦‚å¿µçš„æå‡ºã€‚

Saga å±žäºŽé•¿äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†é•¿äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªæœ¬åœ°çŸ­äº‹åŠ¡ï¼ˆæœ¬åœ°çŸ­äº‹åŠ¡åºåˆ—ï¼‰ã€‚

![img](https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fguide-blog-images.oss-cn-shenzhen.aliyuncs.com%2Fgithub%2Fjavaguide%2Fdistributed-system%2Fdistributed-transaction%2Fdistributed-transaction-saga.png&sign=5d87613d39f415516e1cd40263a0cfc871c4340eb9fa34d7fe13647f167de18b)

- é•¿äº‹åŠ¡ â€”> T1,T2 ~ Tn ä¸ªæœ¬åœ°çŸ­äº‹åŠ¡
- æ¯ä¸ªçŸ­äº‹åŠ¡éƒ½æœ‰ä¸€ä¸ªè¡¥å¿åŠ¨ä½œ â€”> C1,C2 ~ Cn

ä¸‹å›¾æ¥è‡ªäºŽ [å¾®è½¯æŠ€æœ¯æ–‡æ¡£â€”Saga åˆ†å¸ƒå¼äº‹åŠ¡](https://docs.microsoft.com/zh-cn/azure/architecture/reference-architectures/saga/saga) ã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2F20210611101344496.png)

å¦‚æžœ T1,T2 ~ Tn è¿™äº›çŸ­äº‹åŠ¡éƒ½èƒ½é¡ºåˆ©å®Œæˆçš„è¯ï¼Œæ•´ä¸ªäº‹åŠ¡ä¹Ÿå°±é¡ºåˆ©ç»“æŸï¼Œå¦åˆ™ï¼Œå°†é‡‡å–æ¢å¤æ¨¡å¼ã€‚

**åå‘æ¢å¤ ï¼š**

- ç®€ä»‹ï¼šå¦‚æžœ Ti çŸ­äº‹åŠ¡æäº¤å¤±è´¥ï¼Œåˆ™è¡¥å¿æ‰€æœ‰å·²å®Œæˆçš„äº‹åŠ¡ï¼ˆä¸€ç›´æ‰§è¡Œ Ci å¯¹ Ti è¿›è¡Œè¡¥å¿ï¼‰ã€‚
- æ‰§è¡Œé¡ºåºï¼šT1ï¼ŒT2ï¼Œâ€¦ï¼ŒTiï¼ˆå¤±è´¥ï¼‰ï¼ŒCiï¼ˆè¡¥å¿ï¼‰ï¼Œâ€¦ï¼ŒC2ï¼ŒC1ã€‚

**æ­£å‘æ¢å¤ ï¼š**

- ç®€ä»‹ï¼šå¦‚æžœ Ti çŸ­äº‹åŠ¡æäº¤å¤±è´¥ï¼Œåˆ™ä¸€ç›´å¯¹ Ti è¿›è¡Œé‡è¯•ï¼Œç›´è‡³æˆåŠŸä¸ºæ­¢ã€‚
- æ‰§è¡Œé¡ºåºï¼šT1ï¼ŒT2ï¼Œâ€¦ï¼ŒTiï¼ˆå¤±è´¥ï¼‰ï¼ŒTiï¼ˆé‡è¯•ï¼‰â€¦ï¼ŒTi+1ï¼Œâ€¦ï¼ŒTnã€‚

å’Œ TCC ç±»ä¼¼ï¼ŒSaga æ­£å‘æ“ä½œä¸Žè¡¥å¿æ“ä½œéƒ½éœ€è¦ä¸šåŠ¡å¼€å‘è€…è‡ªå·±å®žçŽ°ï¼Œå› æ­¤ä¹Ÿå±žäºŽ **ä¾µå…¥ä¸šåŠ¡ä»£ç ** çš„ä¸€ç§åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‚å’Œ TCC
å¾ˆå¤§çš„ä¸€ç‚¹ä¸åŒæ˜¯ Saga æ²¡æœ‰â€œTryâ€ åŠ¨ä½œï¼Œå®ƒçš„æœ¬åœ°äº‹åŠ¡ Ti ç›´æŽ¥è¢«æäº¤ã€‚å› æ­¤ï¼Œæ€§èƒ½éžå¸¸é«˜ï¼

ç†è®ºä¸Šæ¥è¯´ï¼Œè¡¥å¿æ“ä½œä¸€å®šèƒ½å¤Ÿæ‰§è¡ŒæˆåŠŸã€‚ä¸è¿‡ï¼Œå½“ç½‘ç»œå‡ºçŽ°é—®é¢˜æˆ–è€…æœåŠ¡å™¨å®•æœºçš„è¯ï¼Œè¡¥å¿æ“ä½œä¹Ÿä¼šæ‰§è¡Œå¤±è´¥ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¾€å¾€éœ€è¦æˆ‘ä»¬è¿›è¡Œäººå·¥å¹²é¢„ã€‚å¹¶ä¸”ï¼Œä¸ºäº†èƒ½å¤Ÿæé«˜å®¹é”™æ€§ï¼ˆæ¯”å¦‚
Saga ç³»ç»Ÿæœ¬èº«ä¹Ÿå¯èƒ½ä¼šå´©æºƒï¼‰ï¼Œä¿è¯æ‰€æœ‰çš„çŸ­äº‹åŠ¡éƒ½å¾—ä»¥æäº¤æˆ–è¡¥å¿ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†è¿™äº›æ“ä½œé€šè¿‡æ—¥å¿—è®°å½•ä¸‹æ¥ï¼ˆSaga
logï¼Œç±»ä¼¼äºŽæ•°æ®åº“çš„æ—¥å¿—æœºåˆ¶ï¼‰ã€‚è¿™æ ·ï¼ŒSaga ç³»ç»Ÿæ¢å¤ä¹‹åŽï¼Œæˆ‘ä»¬å°±çŸ¥é“çŸ­äº‹åŠ¡æ‰§è¡Œåˆ°å“ªé‡Œäº†æˆ–è€…è¡¥å¿æ“ä½œæ‰§è¡Œåˆ°å“ªé‡Œäº†ã€‚

å¦å¤–ï¼Œå› ä¸º Saga æ²¡æœ‰è¿›è¡Œâ€œTryâ€ åŠ¨ä½œé¢„ç•™èµ„æºï¼Œæ‰€ä»¥ä¸èƒ½ä¿è¯éš”ç¦»æ€§ã€‚è¿™ä¹Ÿæ˜¯ Saga æ¯”è¾ƒå¤§çš„ä¸€ä¸ªç¼ºç‚¹ã€‚

é’ˆå¯¹ Saga çš„å®žçŽ°ï¼Œä¸šç•Œä¹Ÿæœ‰ä¸€äº›ä¸é”™çš„å¼€æºæ¡†æž¶ã€‚ä¸åŒçš„æ¡†æž¶å¯¹äºŽ Saga çš„å®žçŽ°å¯èƒ½ç•¥æœ‰ä¸åŒï¼Œä¸è¿‡å¤§è‡´æ€æƒ³éƒ½ä¸€æ ·ã€‚

1. [ServiceComb Pack](https://github.com/apache/servicecomb-pack) ï¼šå¾®æœåŠ¡åº”ç”¨çš„æ•°æ®æœ€ç»ˆä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆã€‚
2. [Seata](https://seata.io/zh-cn/index.html) :Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºŽåœ¨å¾®æœåŠ¡æž¶æž„ä¸‹æä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚

#### åˆ†å¸ƒå¼äº‹åŠ¡å¼€æºé¡¹ç›®

1. [Seata](http://seata.io/zh-cn/) ï¼šSeata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºŽåœ¨å¾®æœåŠ¡æž¶æž„ä¸‹æä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚ç»åŽ†è¿‡åŒ
   11 çš„å®žæˆ˜è€ƒéªŒã€‚
2. [Hmily](https://gitee.com/dromara/hmily) ï¼šHmily
   æ˜¯ä¸€æ¬¾é«˜æ€§èƒ½ï¼Œé›¶ä¾µå…¥ï¼Œé‡‘èžçº§åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œç›®å‰ä¸»è¦æä¾›æŸ”æ€§äº‹åŠ¡çš„æ”¯æŒï¼ŒåŒ…å« `TCC`, `TAC`(è‡ªåŠ¨ç”Ÿæˆå›žæ»š` SQL`)
   æ–¹æ¡ˆï¼Œæœªæ¥è¿˜ä¼šæ”¯æŒ XA ç­‰æ–¹æ¡ˆã€‚ä¸ªäººå¼€å‘é¡¹ç›®ï¼Œç›®å‰åœ¨äº¬ä¸œæ•°ç§‘é‡å¯ï¼Œæœªæ¥ä¼šæˆä¸ºäº¬ä¸œæ•°ç§‘çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚
3. [Raincat](https://gitee.com/dromara/Raincat) : 2 é˜¶æ®µæäº¤åˆ†å¸ƒå¼äº‹åŠ¡ä¸­é—´ä»¶ã€‚
4. [Myth](https://gitee.com/dromara/myth) : é‡‡ç”¨æ¶ˆæ¯é˜Ÿåˆ—è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„å¼€æºæ¡†æž¶, åŸºäºŽ Java è¯­è¨€æ¥å¼€å‘ï¼ˆJDK1.8ï¼‰ï¼Œæ”¯æŒ
   Dubboï¼ŒSpringCloud,Motan ç­‰ rpc æ¡†æž¶è¿›è¡Œåˆ†å¸ƒå¼äº‹åŠ¡ã€‚

### **æœåŠ¡æ²»ç†ï¼šç›‘æŽ§ç³»ç»Ÿå¦‚ä½•åšï¼Ÿ**

> ä¸ªäººå­¦ä¹ ç¬”è®°ï¼Œå¤§éƒ¨åˆ†å†…å®¹æ•´ç†è‡ªä¹¦ç±ã€åšå®¢å’Œå®˜æ–¹æ–‡æ¡£ã€‚
>
> ç›¸å…³æ–‡ç«  &ä¹¦ç±ï¼š
>
> - [ç›‘æŽ§ç³»ç»Ÿé€‰åž‹ï¼Œè¿™ç¯‡ä¸å¯ä¸è¯»ï¼](https://www.jianshu.com/p/302ba018082a)
> - [rometheus vs Nagios](https://logz.io/blog/prometheus-vs-nagios-metrics/)
> - [2020 å¹´å·¥ä½œä¸Šçš„æœ€å¤§æ”¶èŽ·â€”â€”ç›‘æŽ§å‘Šè­¦ä½“ç³»](https://www.cnblogs.com/hunternet/p/14270218.html)
> - [ã€ŠPrometheus æ“ä½œæŒ‡å—ã€‹](https://yunlzheng.gitbook.io/prometheus-book/)
>
> ç›¸å…³è§†é¢‘ï¼š
>
> - [ä½¿ç”¨Prometheuså®žè·µåŸºäºŽSpring Bootç›‘æŽ§å‘Šè­¦ä½“ç³»](https://www.imooc.com/learn/1231)
> - [Prometheus & Grafana -é™ˆå˜‰é¹ [å°šç¡…è°·å¤§æ•°æ®\]](https://www.bilibili.com/video/BV11f4y1A7aF)

#### ç›‘æŽ§ç³»ç»Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ

å»ºç«‹å®Œå–„çš„ç›‘æŽ§ä½“ç³»ä¸»è¦æ˜¯ä¸ºäº†ï¼š

- **é•¿æœŸè¶‹åŠ¿åˆ†æž** ï¼šé€šè¿‡å¯¹ç›‘æŽ§æ ·æœ¬æ•°æ®çš„æŒç»­æ”¶é›†å’Œç»Ÿè®¡ï¼Œå¯¹ç›‘æŽ§æŒ‡æ ‡è¿›è¡Œé•¿æœŸè¶‹åŠ¿åˆ†æžã€‚ä¾‹å¦‚ï¼Œé€šè¿‡å¯¹ç£ç›˜ç©ºé—´å¢žé•¿çŽ‡çš„åˆ¤æ–­ï¼Œæˆ‘ä»¬å¯ä»¥æå‰é¢„æµ‹åœ¨æœªæ¥ä»€ä¹ˆæ—¶é—´èŠ‚ç‚¹ä¸Šéœ€è¦å¯¹èµ„æºè¿›è¡Œæ‰©å®¹ã€‚
- **æ•°æ®å¯è§†åŒ–** ï¼šé€šè¿‡å¯è§†åŒ–ä»ªè¡¨ç›˜èƒ½å¤Ÿç›´æŽ¥èŽ·å–ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€ã€èµ„æºä½¿ç”¨æƒ…å†µã€ä»¥åŠæœåŠ¡è¿è¡ŒçŠ¶æ€ç­‰ç›´è§‚çš„ä¿¡æ¯ã€‚
- **é¢„çŸ¥æ•…éšœå’Œå‘Šè­¦** : å½“ç³»ç»Ÿå‡ºçŽ°æˆ–è€…å³å°†å‡ºçŽ°æ•…éšœæ—¶ï¼Œç›‘æŽ§ç³»ç»Ÿéœ€è¦è¿…é€Ÿååº”å¹¶é€šçŸ¥ç®¡ç†å‘˜ï¼Œä»Žè€Œèƒ½å¤Ÿå¯¹é—®é¢˜è¿›è¡Œå¿«é€Ÿçš„å¤„ç†æˆ–è€…æå‰é¢„é˜²é—®é¢˜çš„å‘ç”Ÿï¼Œé¿å…å‡ºçŽ°å¯¹ä¸šåŠ¡çš„å½±å“ã€‚
- **è¾…åŠ©å®šä½æ•…éšœã€æ€§èƒ½è°ƒä¼˜ã€å®¹é‡è§„åˆ’ä»¥åŠè‡ªåŠ¨åŒ–è¿ç»´**

**å‡ºä»»ä½•çº¿ä¸Šäº‹æ•…ï¼Œå…ˆä¸è¯´å…¶ä»–åœ°æ–¹æœ‰é—®é¢˜ï¼Œç›‘æŽ§éƒ¨åˆ†ä¸€å®šæ˜¯æœ‰é—®é¢˜çš„ã€‚**

**å¦‚ä½•æ‰èƒ½æ›´å¥½åœ°ä½¿ç”¨ç›‘æŽ§ä½¿ç”¨ï¼Ÿ**

1. **äº†è§£ç›‘æŽ§å¯¹è±¡çš„å·¥ä½œåŽŸç†**ï¼šè¦åšåˆ°å¯¹ç›‘æŽ§å¯¹è±¡æœ‰åŸºæœ¬çš„äº†è§£ï¼Œæ¸…æ¥šå®ƒçš„å·¥ä½œåŽŸç†ã€‚æ¯”å¦‚æƒ³å¯¹ JVM è¿›è¡Œç›‘æŽ§ï¼Œä½ å¿…é¡»æ¸…æ¥š JVM
   çš„å †å†…å­˜ç»“æž„å’Œåžƒåœ¾å›žæ”¶æœºåˆ¶ã€‚
2. **ç¡®å®šç›‘æŽ§å¯¹è±¡çš„æŒ‡æ ‡**ï¼šæ¸…æ¥šä½¿ç”¨å“ªäº›æŒ‡æ ‡æ¥åˆ»ç”»ç›‘æŽ§å¯¹è±¡çš„çŠ¶æ€ï¼Ÿæ¯”å¦‚æƒ³å¯¹æŸä¸ªæŽ¥å£è¿›è¡Œç›‘æŽ§ï¼Œå¯ä»¥é‡‡ç”¨è¯·æ±‚é‡ã€è€—æ—¶ã€è¶…æ—¶é‡ã€å¼‚å¸¸é‡ç­‰æŒ‡æ ‡æ¥è¡¡é‡ã€‚
3. **å®šä¹‰åˆç†çš„æŠ¥è­¦é˜ˆå€¼å’Œç­‰çº§**ï¼šè¾¾åˆ°ä»€ä¹ˆé˜ˆå€¼éœ€è¦å‘Šè­¦ï¼Ÿå¯¹åº”çš„æ•…éšœç­‰çº§æ˜¯å¤šå°‘ï¼Ÿä¸éœ€è¦å¤„ç†çš„å‘Šè­¦ä¸æ˜¯å¥½å‘Šè­¦ï¼Œå¯è§å®šä¹‰åˆç†çš„é˜ˆå€¼æœ‰å¤šé‡è¦ï¼Œå¦åˆ™åªä¼šé™ä½Žè¿ç»´æ•ˆçŽ‡æˆ–è€…è®©ç›‘æŽ§ç³»ç»Ÿå¤±åŽ»å®ƒçš„ä½œç”¨ã€‚
4. **å»ºç«‹å®Œå–„çš„æ•…éšœå¤„ç†æµç¨‹**ï¼šæ”¶åˆ°æ•…éšœå‘Šè­¦åŽï¼Œä¸€å®šè¦æœ‰ç›¸åº”çš„å¤„ç†æµç¨‹å’Œ oncall æœºåˆ¶ï¼Œè®©æ•…éšœåŠæ—¶è¢«è·Ÿè¿›å¤„ç†ã€‚

#### å¸¸è§çš„ç›‘æŽ§å¯¹è±¡å’ŒæŒ‡æ ‡æœ‰å“ªäº›ï¼Ÿ

- **ç¡¬ä»¶ç›‘**æŽ§ ï¼šç”µæºçŠ¶æ€ã€CPU çŠ¶æ€ã€æœºå™¨æ¸©åº¦ã€é£Žæ‰‡çŠ¶æ€ã€ç‰©ç†ç£ç›˜ã€raid çŠ¶æ€ã€å†…å­˜çŠ¶æ€ã€ç½‘å¡çŠ¶æ€
- **æœåŠ¡å™¨åŸºç¡€ç›‘æŽ§** ï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ
- **æ•°æ®åº“ç›‘æŽ§** ï¼šæ•°æ®åº“è¿žæŽ¥æ•°ã€QPSã€TPSã€å¹¶è¡Œå¤„ç†çš„ä¼šè¯æ•°ã€ç¼“å­˜å‘½ä¸­çŽ‡ã€ä¸»ä»Žå»¶æ—¶ã€é”çŠ¶æ€ã€æ…¢æŸ¥è¯¢
- **ä¸­é—´ä»¶ç›‘æŽ§** ï¼š
    - Nginxï¼šæ´»è·ƒè¿žæŽ¥æ•°ã€ç­‰å¾…è¿žæŽ¥æ•°ã€ä¸¢å¼ƒè¿žæŽ¥æ•°ã€è¯·æ±‚é‡ã€è€—æ—¶ã€5XX é”™è¯¯çŽ‡
    - Tomcatï¼šæœ€å¤§çº¿ç¨‹æ•°ã€å½“å‰çº¿ç¨‹æ•°ã€è¯·æ±‚é‡ã€è€—æ—¶ã€é”™è¯¯é‡ã€å †å†…å­˜ä½¿ç”¨æƒ…å†µã€GC æ¬¡æ•°å’Œè€—æ—¶
    - ç¼“å­˜ ï¼šæˆåŠŸè¿žæŽ¥æ•°ã€é˜»å¡žè¿žæŽ¥æ•°ã€å·²ä½¿ç”¨å†…å­˜ã€å†…å­˜ç¢Žç‰‡çŽ‡ã€è¯·æ±‚é‡ã€è€—æ—¶ã€ç¼“å­˜å‘½ä¸­çŽ‡
    - æ¶ˆæ¯é˜Ÿåˆ—ï¼šè¿žæŽ¥æ•°ã€é˜Ÿåˆ—æ•°ã€ç”Ÿäº§é€ŸçŽ‡ã€æ¶ˆè´¹é€ŸçŽ‡ã€æ¶ˆæ¯å †ç§¯é‡

- **åº”ç”¨ç›‘æŽ§** ï¼š
    - HTTP æŽ¥å£ï¼šURL å­˜æ´»ã€è¯·æ±‚é‡ã€è€—æ—¶ã€å¼‚å¸¸é‡
    - RPC æŽ¥å£ï¼šè¯·æ±‚é‡ã€è€—æ—¶ã€è¶…æ—¶é‡ã€æ‹’ç»é‡
    - JVM ï¼šGC æ¬¡æ•°ã€GC è€—æ—¶ã€å„ä¸ªå†…å­˜åŒºåŸŸçš„å¤§å°ã€å½“å‰çº¿ç¨‹æ•°ã€æ­»é”çº¿ç¨‹æ•°
    - çº¿ç¨‹æ± ï¼šæ´»è·ƒçº¿ç¨‹æ•°ã€ä»»åŠ¡é˜Ÿåˆ—å¤§å°ã€ä»»åŠ¡æ‰§è¡Œè€—æ—¶ã€æ‹’ç»ä»»åŠ¡æ•°
    - è¿žæŽ¥æ± ï¼šæ€»è¿žæŽ¥æ•°ã€æ´»è·ƒè¿žæŽ¥æ•°
    - æ—¥å¿—ç›‘æŽ§ï¼šè®¿é—®æ—¥å¿—ã€é”™è¯¯æ—¥å¿—
    - ä¸šåŠ¡æŒ‡æ ‡ï¼šè§†ä¸šåŠ¡æ¥å®šï¼Œæ¯”å¦‚ PVã€è®¢å•é‡ç­‰

#### ç›‘æŽ§çš„åŸºæœ¬æµç¨‹äº†è§£å—ï¼Ÿ

æ— è®ºæ˜¯å¼€æºçš„ç›‘æŽ§ç³»ç»Ÿè¿˜æ˜¯è‡ªç ”çš„ç›‘æŽ§ç³»ç»Ÿï¼Œç›‘æŽ§çš„æ•´ä¸ªæµç¨‹å¤§åŒå°å¼‚ï¼Œä¸€èˆ¬éƒ½åŒ…æ‹¬ä»¥ä¸‹æ¨¡å—ï¼š

- **æ•°æ®é‡‡é›†**ï¼šé‡‡é›†çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼ŒåŒ…æ‹¬æ—¥å¿—åŸ‹ç‚¹è¿›è¡Œé‡‡é›†ï¼ˆé€šè¿‡ Logstashã€Filebeat ç­‰è¿›è¡Œä¸ŠæŠ¥å’Œè§£æžï¼‰ï¼ŒJMX æ ‡å‡†æŽ¥å£è¾“å‡ºç›‘æŽ§æŒ‡æ ‡ï¼Œè¢«ç›‘æŽ§å¯¹è±¡æä¾›
  REST API è¿›è¡Œæ•°æ®é‡‡é›†ï¼ˆå¦‚ Hadoopã€ESï¼‰ï¼Œç³»ç»Ÿå‘½ä»¤è¡Œï¼Œç»Ÿä¸€çš„ SDK è¿›è¡Œä¾µå…¥å¼çš„åŸ‹ç‚¹å’Œä¸ŠæŠ¥ç­‰ã€‚
- **æ•°æ®ä¼ è¾“**ï¼šå°†é‡‡é›†çš„æ•°æ®ä»¥ TCPã€UDP æˆ–è€… HTTP åè®®çš„å½¢å¼ä¸ŠæŠ¥ç»™ç›‘æŽ§ç³»ç»Ÿï¼Œæœ‰ä¸»åŠ¨ Push æ¨¡å¼ï¼Œä¹Ÿæœ‰è¢«åŠ¨ Pull æ¨¡å¼ã€‚
- **æ•°æ®å­˜å‚¨**ï¼šæœ‰ä½¿ç”¨ MySQLã€Oracle ç­‰ RDBMS å­˜å‚¨çš„ï¼Œä¹Ÿæœ‰ä½¿ç”¨æ—¶åºæ•°æ®åº“ RRDToolã€OpentTSDBã€InfluxDB å­˜å‚¨çš„ï¼Œè¿˜æœ‰ä½¿ç”¨ HBase
  å­˜å‚¨çš„ã€‚
- **æ•°æ®å±•ç¤º**ï¼šæ•°æ®æŒ‡æ ‡çš„å›¾å½¢åŒ–å±•ç¤ºã€‚
- **ç›‘æŽ§å‘Šè­¦**ï¼šçµæ´»çš„å‘Šè­¦è®¾ç½®ï¼Œä»¥åŠæ”¯æŒé‚®ä»¶ã€çŸ­ä¿¡ã€IM ç­‰å¤šç§é€šçŸ¥é€šé“ã€‚

#### ç›‘æŽ§ç³»ç»Ÿéœ€è¦æ»¡è¶³ä»€ä¹ˆè¦æ±‚ï¼Ÿ

- **å®žæ—¶ç›‘æŽ§&å‘Šè­¦** ï¼šç›‘æŽ§ç³»ç»Ÿå¯¹ä¸šåŠ¡æœåŠ¡ç³»ç»Ÿå®žæ—¶ç›‘æŽ§ï¼Œå¦‚æžœäº§ç”Ÿç³»ç»Ÿå¼‚å¸¸åŠæ—¶å‘Šè­¦ç»™ç›¸å…³äººå‘˜ã€‚
- **é«˜å¯ç”¨** ï¼šè¦ä¿éšœç›‘æŽ§ç³»ç»Ÿçš„å¯ç”¨æ€§
- **æ•…éšœå®¹å¿** ï¼šç›‘æŽ§ç³»ç»Ÿä¸å½±å“ä¸šåŠ¡ç³»ç»Ÿçš„æ­£å¸¸è¿è¡Œï¼Œç›‘æŽ§ç³»ç»ŸæŒ‚äº†ï¼Œåº”ç”¨æ­£å¸¸è¿è¡Œã€‚
- **å¯æ‰©å±•** ï¼šæ”¯æŒåˆ†å¸ƒå¼ã€è·¨ IDC éƒ¨ç½²ï¼Œæ¨ªå‘æ‰©å±•ã€‚
- **å¯è§†åŒ–** ï¼šè‡ªå¸¦å¯è§†åŒ–å›¾æ ‡ã€æ”¯æŒå¯¹æŽ¥å„ç±»å¯è§†åŒ–ç»„ä»¶æ¯”å¦‚ Grafana ã€‚

#### ç›‘æŽ§ç³»ç»ŸæŠ€æœ¯é€‰åž‹æœ‰å“ªäº›ï¼Ÿå¦‚ä½•é€‰æ‹©ï¼Ÿ

##### è€ç‰Œç›‘æŽ§ç³»ç»Ÿ

Zabbix å’Œ Nagios ç›¸ç»§å‡ºçŽ°åœ¨ 1998 å¹´å’Œ 1999 å¹´ï¼Œç›®å‰å·²ç»è¢«æ·˜æ±°ï¼Œä¸å¤ªå»ºè®®ä½¿ç”¨ï¼ŒPrometheus æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚

###### Zabbix

- **ä»‹ç»** ï¼šè€ç‰Œç›‘æŽ§çš„ä¼˜ç§€ä»£è¡¨ã€‚äº§å“æˆç†Ÿï¼Œç›‘æŽ§åŠŸèƒ½å¾ˆå…¨é¢ï¼Œé‡‡é›†æ–¹å¼ä¸°å¯Œï¼ˆæ”¯æŒ Agentã€SNMPã€JMXã€SSH
  ç­‰å¤šç§é‡‡é›†æ–¹å¼ï¼Œä»¥åŠä¸»åŠ¨å’Œè¢«åŠ¨çš„æ•°æ®ä¼ è¾“æ–¹å¼ï¼‰ï¼Œä½¿ç”¨ä¹Ÿå¾ˆå¹¿æ³›ï¼Œå·®ä¸å¤šæœ‰ 70%å·¦å³çš„äº’è”ç½‘å…¬å¸éƒ½æ›¾ä½¿ç”¨è¿‡ Zabbix ä½œä¸ºç›‘æŽ§è§£å†³æ–¹æ¡ˆã€‚
- **å¼€å‘è¯­è¨€** ï¼š C
- **æ•°æ®å­˜å‚¨** ï¼š Zabbix å­˜å‚¨åœ¨ MySQL ä¸Šï¼Œä¹Ÿå¯ä»¥å­˜å‚¨åœ¨å…¶ä»–æ•°æ®åº“æœåŠ¡ã€‚Zabbix ç”±äºŽä½¿ç”¨äº†å…³ç³»åž‹æ•°æ®å­˜å‚¨æ—¶åºæ•°æ®ï¼Œæ‰€ä»¥åœ¨ç›‘æŽ§å¤§è§„æ¨¡é›†ç¾¤æ—¶å¸¸å¸¸åœ¨æ•°æ®å­˜å‚¨æ–¹é¢æ‰è¥Ÿè§è‚˜ã€‚æ‰€ä»¥ä»Ž
  Zabbix 4.2 ç‰ˆæœ¬åŽå¼€å§‹æ”¯æŒ TimescaleDB æ—¶åºæ•°æ®åº“ï¼Œä¸è¿‡ç›®å‰æˆç†Ÿåº¦è¿˜ä¸é«˜ã€‚
- **æ•°æ®é‡‡é›†æ–¹å¼** : Zabbix é€šè¿‡ SNMPã€Agentã€ICMPã€SSHã€IPMI ç­‰å¯¹ç³»ç»Ÿè¿›è¡Œæ•°æ®é‡‡é›†ã€‚Zabbix é‡‡ç”¨çš„æ˜¯ Push æ¨¡åž‹ï¼ˆå®¢æˆ·ç«¯å‘é€æ•°æ®ç»™æœåŠ¡ç«¯ï¼‰ã€‚
- **æ•°æ®å±•ç¤º** ï¼šè‡ªå¸¦å±•ç¤ºç•Œé¢ï¼Œä¹Ÿå¯ä»¥å¯¹æŽ¥ Grafanaã€‚
- **è¯„ä»·** ï¼šä¸å¤ªå»ºè®®ä½¿ç”¨ Zabbixï¼Œæ€§èƒ½å¯èƒ½ä¼šæˆä¸ºç›‘æŽ§ç³»ç»Ÿçš„ç“¶é¢ˆã€‚å¹¶ä¸”ï¼Œåº”ç”¨å±‚ç›‘æŽ§æ”¯æŒæœ‰é™ã€äºŒæ¬¡å¼€å‘éš¾åº¦å¤§ï¼ˆåŸºäºŽ c è¯­è¨€ï¼‰ã€æ•°æ®æ¨¡åž‹ä¸å¼ºå¤§ã€‚

ç›¸å…³é˜…è¯»ï¼š[ã€Šzabbix è¿ç»´æ‰‹å†Œã€‹](http://www.sunrisenan.com/docs/zabbix)

###### Nagios

- **ä»‹ç»** ï¼šNagios èƒ½æœ‰æ•ˆç›‘æŽ§ Windowsã€Linux å’Œ UNIX çš„ä¸»æœºçŠ¶æ€ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ç­‰ï¼‰ï¼Œä»¥åŠäº¤æ¢æœºã€è·¯ç”±å™¨ç­‰ç½‘ç»œè®¾å¤‡ï¼ˆSMTPã€POP3ã€HTTP
  å’Œ NNTP ç­‰ï¼‰ï¼Œè¿˜æœ‰ Serverã€Applicationã€Loggingï¼Œç”¨æˆ·å¯è‡ªå®šä¹‰ç›‘æŽ§è„šæœ¬å®žçŽ°å¯¹ä¸Šè¿°å¯¹è±¡çš„ç›‘æŽ§ã€‚Nagios åŒæ—¶æä¾›äº†ä¸€ä¸ªå¯é€‰çš„åŸºäºŽæµè§ˆå™¨çš„
  Web ç•Œé¢ï¼Œä»¥æ–¹ä¾¿ç³»ç»Ÿç®¡ç†äººå‘˜æŸ¥çœ‹ç½‘ç»œçŠ¶æ€ã€å„ç§ç³»ç»Ÿé—®é¢˜ä»¥åŠæ—¥å¿—ç­‰ã€‚
- **å¼€å‘è¯­è¨€** ï¼š C
- **æ•°æ®å­˜å‚¨** ï¼š MySQL æ•°æ®åº“
- **æ•°æ®é‡‡é›†æ–¹å¼** : é€šè¿‡å„ç§æ’ä»¶é‡‡é›†æ•°æ®
- **æ•°æ®å±•ç¤º** ï¼šè‡ªå¸¦å±•ç¤ºç•Œé¢ï¼Œä¸è¿‡åŠŸèƒ½ç®€å•ã€‚
- **è¯„ä»·** ï¼šä¸ç¬¦åˆå½“å‰ç›‘æŽ§ç³»ç»Ÿçš„è¦æ±‚ï¼Œè€Œä¸”ï¼ŒNagios å…è´¹ç‰ˆæœ¬çš„åŠŸèƒ½éžå¸¸æœ‰é™ï¼Œè¿ç»´ç®¡ç†éš¾åº¦éžå¸¸å¤§ã€‚

##### æ–°ä¸€ä»£ç›‘æŽ§ç³»ç»Ÿ

ç›¸æ¯”äºŽè€ç‰Œç›‘æŽ§ç³»ç»Ÿï¼Œæ–°ä¸€ä»£ç›‘æŽ§ç³»ç»Ÿæœ‰æ˜Žæ˜¾çš„ä¼˜åŠ¿ï¼Œæ¯”å¦‚ï¼šçµæ´»çš„æ•°æ®æ¨¡åž‹ã€æ›´æˆç†Ÿçš„æ—¶åºæ•°æ®åº“ã€å¼ºå¤§çš„å‘Šè­¦åŠŸèƒ½ã€‚

![image.png](é¢è¯•æŒ‡åŒ—.assets/1666351430977-06aeb3f0-ac03-4916-a6ac-4574fb979b42.png)

###### Open-Falcon

- **ä»‹ç»** ï¼šå°ç±³ 2015 å¹´å¼€æºçš„ä¼ä¸šçº§ç›‘æŽ§å·¥å…·ï¼Œåœ¨æž¶æž„è®¾è®¡ä¸Šå¸å–äº† Zabbix çš„ç»éªŒï¼ŒåŒæ—¶å¾ˆå¥½åœ°è§£å†³äº† Zabbix çš„è¯¸å¤šç—›ç‚¹ã€‚Github
  åœ°å€ï¼šhttps://github.com/open-falcon ã€‚å®˜æ–¹æ–‡æ¡£ï¼šhttps://book.open-falcon.org/ ã€‚
- **å¼€å‘è¯­è¨€** ï¼šGoã€Pythonã€‚
- **æ•°æ®å­˜å‚¨** ï¼š çŽ¯åž‹æ•°æ®åº“ï¼Œæ”¯æŒå¯¹æŽ¥æ—¶åºæ•°æ®åº“ OpenTSDBã€‚
- **æ•°æ®é‡‡é›†æ–¹å¼** : è‡ªåŠ¨å‘çŽ°ï¼Œæ”¯æŒ falcon-agentã€snmpã€æ”¯æŒç”¨æˆ·ä¸»åŠ¨ pushã€ç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶æ”¯æŒã€opentsdb data model
  likeï¼ˆtimestampã€endpointã€metricã€key-value tagsï¼‰ã€‚Open-Falcon å’Œ Zabbix é‡‡ç”¨çš„éƒ½æ˜¯ Push æ¨¡åž‹ï¼ˆå®¢æˆ·ç«¯å‘é€æ•°æ®ç»™æœåŠ¡ç«¯ï¼‰ã€‚
- **æ•°æ®å±•ç¤º** ï¼šè‡ªå¸¦å±•ç¤ºç•Œé¢ï¼Œä¹Ÿå¯ä»¥å¯¹æŽ¥ Grafanaã€‚
- **è¯„ä»·** ï¼šç”¨æˆ·é›†ä¸­åœ¨å›½å†…ï¼Œæµè¡Œåº¦ä¸€èˆ¬ï¼Œç”Ÿæ€ä¸€èˆ¬ã€‚

Open-Falcon æž¶æž„å›¾å¦‚ä¸‹ï¼š

![image.png](é¢è¯•æŒ‡åŒ—.assets/1666351431508-d051cfb1-a325-44dc-b551-588c3ae0ce2d.png)

- **Falcon-agent** ï¼šé‡‡é›†æ¨¡å—ã€‚ç±»ä¼¼ Zabbix çš„ agentï¼ŒKubernetes è‡ªå¸¦ç›‘æŽ§ä½“ç³»ä¸­çš„ cAdvisorï¼ŒNagios ä¸­çš„ Pluginï¼Œä½¿ç”¨ Go
  è¯­è¨€å¼€å‘ï¼Œç”¨äºŽé‡‡é›†ä¸»æœºä¸Šçš„å„ç§æŒ‡æ ‡æ•°æ®ã€‚
- **Hearthbeat server** ï¼šå¿ƒè·³æœåŠ¡ã€‚æ¯ä¸ª Agent éƒ½ä¼šå‘¨æœŸæ€§åœ°é€šè¿‡ RPC æ–¹å¼å°†è‡ªå·±åœ°çŠ¶æ€ä¸ŠæŠ¥ç»™ HBSï¼Œä¸»è¦åŒ…æ‹¬ä¸»æœºåã€ä¸»æœº
  IPã€Agent ç‰ˆæœ¬å’Œæ’ä»¶ç‰ˆæœ¬ï¼ŒAgent è¿˜ä¼šä»Ž HBS èŽ·å–è‡ªå·±éœ€è¦æ‰§è¡Œçš„é‡‡é›†ä»»åŠ¡å’Œè‡ªå®šä¹‰æ’ä»¶ã€‚
- **Transfer** ï¼šè´Ÿè´£ç›‘æŽ§ agent å‘é€çš„ç›‘æŽ§æ•°æ®ï¼Œå¹¶å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œåœ¨è¿‡æ»¤åŽé€šè¿‡ä¸€è‡´æ€§ Hash ç®—æ³•å°†æ•°æ®å‘é€åˆ° Judge æˆ–è€…
  Graphã€‚ä¸ºäº†æ”¯æŒå­˜å‚¨å¤§é‡çš„åŽ†å²æ•°æ®ï¼ŒTransfer è¿˜æ”¯æŒ OpenTSDBã€‚Transfer æœ¬èº«æ²¡æœ‰çŠ¶æ€ï¼Œå¯ä»¥éšæ„æ‰©å±•ã€‚
- **Jedge** ï¼šå‘Šè­¦æ¨¡å—ã€‚Transfer è½¬å‘åˆ° Judge çš„æ•°æ®ä¼šè§¦å‘ç”¨æˆ·è®¾å®šçš„å‘Šè­¦è§„åˆ™ï¼Œå¦‚æžœæ»¡è¶³ï¼Œåˆ™ä¼šè§¦å‘é‚®ä»¶ã€å¾®ä¿¡æˆ–è€…å›žè°ƒæŽ¥å£ã€‚è¿™é‡Œä¸ºäº†é¿å…é‡å¤å‘Šè­¦ï¼Œå¼•å…¥äº†
  Redis æš‚å­˜å‘Šè­¦ï¼Œä»Žè€Œå®Œæˆå‘Šè­¦åˆå¹¶å’ŒæŠ‘åˆ¶ã€‚
- **Graph** ï¼šRRD æ•°æ®ä¸ŠæŠ¥ã€å½’æ¡£ã€å­˜å‚¨çš„ç»„ä»¶ã€‚Graph åœ¨æ”¶åˆ°æ•°æ®ä»¥åŽï¼Œä¼šä»¥ RRDtool çš„æ•°æ®å½’æ¡£æ–¹å¼å­˜å‚¨æ•°æ®ï¼ŒåŒæ—¶æä¾› RPC
  æ–¹å¼çš„ç›‘æŽ§æŸ¥è¯¢æŽ¥å£ã€‚
- **API** ï¼š æŸ¥è¯¢æ¨¡å—ã€‚ä¸»è¦æä¾›æŸ¥è¯¢æŽ¥å£ï¼Œä¸ä½†å¯ä»¥ä»Ž Grapg é‡Œé¢è¯»å–æ•°æ®ï¼Œè¿˜å¯ä»¥å¯¹æŽ¥ MySQLï¼Œç”¨äºŽä¿å­˜å‘Šè­¦ã€ç”¨æˆ·ç­‰ä¿¡æ¯ã€‚
- **Dashboard** ï¼š ç›‘æŽ§æ•°æ®å±•ç¤ºé¢æ¿ã€‚ç”± Python å¼€å‘è€Œæˆï¼Œæä¾› Open-Falcon çš„æ•°æ®å’Œå‘Šè­¦å±•ç¤ºï¼Œç›‘æŽ§æ•°æ®æ¥è‡ª Graphï¼ŒDashboard
  å…è®¸ç”¨æˆ·è‡ªå®šä¹‰ç›‘æŽ§é¢æ¿ã€‚
- **Aggregator** : èšåˆæ¨¡å—ã€‚èšåˆæŸé›†ç¾¤ä¸‹æ‰€æœ‰æœºå™¨çš„æŸä¸ªæŒ‡æ ‡çš„å€¼ï¼Œæä¾›ä¸€ç§é›†ç¾¤è§†è§’çš„ç›‘æŽ§ä½“éªŒã€‚ é€šè¿‡å®šæ—¶ä»Ž Graph
  èŽ·å–æ•°æ®ï¼ŒæŒ‰ç…§é›†ç¾¤èšåˆäº§ç”Ÿæ–°çš„ç›‘æŽ§æ•°æ®å¹¶å°†ç›‘æŽ§æ•°æ®å‘é€åˆ° Transferã€‚

###### Prometheus

- **ä»‹ç»** ï¼šPrometheus å—å¯å‘äºŽ Google çš„ Brogmon ç›‘æŽ§ç³»ç»Ÿï¼Œç”±å‰ Google å‘˜å·¥ 2015 å¹´æ­£å¼å‘å¸ƒã€‚æˆªæ­¢åˆ° 2021 å¹´ 9 æœˆ 2
  æ—¥ï¼ŒPrometheus åœ¨ Github ä¸Šå·²ç»æ”¶èŽ·äº† 38.5k+ Starï¼Œ600+ä½ Contributorsã€‚ Github åœ°å€ï¼šhttps://github.com/prometheus ã€‚
- **å¼€å‘è¯­è¨€** ï¼šGo
- **æ•°æ®å­˜å‚¨** ï¼š Prometheus è‡ªç ”ä¸€å¥—é«˜æ€§èƒ½çš„æ—¶åºæ•°æ®åº“ï¼Œå¹¶ä¸”è¿˜æ”¯æŒå¤–æŽ¥æ—¶åºæ•°æ®åº“ã€‚
- **æ•°æ®é‡‡é›†æ–¹å¼** : Prometheus çš„åŸºæœ¬åŽŸç†æ˜¯é€šè¿‡ HTTP åè®®å‘¨æœŸæ€§æŠ“å–è¢«ç›‘æŽ§ç»„ä»¶çš„çŠ¶æ€ï¼Œä»»æ„ç»„ä»¶åªè¦æä¾›å¯¹åº”çš„ HTTP
  æŽ¥å£å°±å¯ä»¥æŽ¥å…¥ç›‘æŽ§ã€‚Prometheus åœ¨æ”¶é›†æ•°æ®æ—¶ï¼Œé‡‡ç”¨çš„ Pull æ¨¡åž‹ï¼ˆæœåŠ¡ç«¯ä¸»åŠ¨åŽ»å®¢æˆ·ç«¯æ‹‰å–æ•°æ®ï¼‰
- **æ•°æ®å±•ç¤º** ï¼šè‡ªå¸¦å±•ç¤ºç•Œé¢ï¼Œä¹Ÿå¯ä»¥å¯¹æŽ¥ Grafanaã€‚
- **è¯„ä»·** ï¼šç›®å‰å›½å†…å¤–ä½¿ç”¨æœ€å¹¿æ³›çš„ä¸€ä¸ªç›‘æŽ§ç³»ç»Ÿï¼Œç”Ÿæ€ä¹Ÿéžå¸¸å¥½ï¼Œæˆç†Ÿç¨³å®šï¼

**Prometheus ç‰¹æ€§ ï¼š**

- å¼€ç®±å³ç”¨çš„å„ç§æœåŠ¡å‘çŽ°æœºåˆ¶ï¼Œå¯ä»¥**è‡ªåŠ¨å‘çŽ°ç›‘æŽ§ç«¯ç‚¹**ï¼›
- ä¸“ä¸ºç›‘æŽ§æŒ‡æ ‡æ•°æ®è®¾è®¡çš„**é«˜æ€§èƒ½æ—¶åºæ•°æ®åº“ TSDB**ï¼›
- å¼ºå¤§æ˜“ç”¨çš„æŸ¥è¯¢è¯­è¨€**PromQL**ä»¥åŠä¸°å¯Œçš„**èšåˆå‡½æ•°**ï¼›
- å¯ä»¥é…ç½®çµæ´»çš„å‘Šè­¦è§„åˆ™ï¼Œæ”¯æŒ**å‘Šè­¦æ”¶æ•›ï¼ˆåˆ†ç»„ã€æŠ‘åˆ¶ã€é™é»˜ï¼‰ã€å¤šçº§è·¯ç”±**ç­‰ç­‰é«˜çº§åŠŸèƒ½ï¼›
- **ç”Ÿæ€å®Œå–„**ï¼Œæœ‰å„ç§çŽ°æˆçš„å¼€æº Exporter å®žçŽ°ï¼Œå®žçŽ°è‡ªå®šä¹‰çš„ç›‘æŽ§æŒ‡æ ‡ä¹Ÿéžå¸¸ç®€å•ã€‚

**Prometheus åŸºæœ¬æž¶æž„ ï¼š**

![image.png](é¢è¯•æŒ‡åŒ—.assets/1666351430632-4fe8a2cc-0036-4b4b-a4c1-b055c34df407.png)

- **Prometheus Server**ï¼šæ ¸å¿ƒç»„ä»¶ï¼Œç”¨äºŽæ”¶é›†ã€å­˜å‚¨ç›‘æŽ§æ•°æ®ã€‚å®ƒåŒæ—¶æ”¯æŒé™æ€é…ç½®å’Œé€šè¿‡ Service Discovery
  åŠ¨æ€å‘çŽ°æ¥ç®¡ç†ç›‘æŽ§ç›®æ ‡ï¼Œå¹¶ä»Žç›‘æŽ§ç›®æ ‡ä¸­èŽ·å–æ•°æ®ã€‚æ­¤å¤–ï¼ŒPrometheus Server ä¹Ÿæ˜¯ä¸€ä¸ªæ—¶åºæ•°æ®åº“ï¼Œå®ƒå°†ç›‘æŽ§æ•°æ®ä¿å­˜åœ¨æœ¬åœ°ç£ç›˜ä¸­ï¼Œå¹¶å¯¹å¤–æä¾›è‡ªå®šä¹‰çš„
  PromQL è¯­è¨€å®žçŽ°å¯¹æ•°æ®çš„æŸ¥è¯¢å’Œåˆ†æžã€‚
- **Exporter**ï¼šç”¨æ¥é‡‡é›†æ•°æ®ï¼Œä½œç”¨ç±»ä¼¼äºŽ agentï¼ŒåŒºåˆ«åœ¨äºŽ Prometheus æ˜¯åŸºäºŽ Pull æ–¹å¼æ‹‰å–é‡‡é›†æ•°æ®çš„ï¼Œå› æ­¤ï¼ŒExporter é€šè¿‡ HTTP
  æœåŠ¡çš„å½¢å¼å°†ç›‘æŽ§æ•°æ®æŒ‰ç…§æ ‡å‡†æ ¼å¼æš´éœ²ç»™ Prometheus Serverï¼Œç¤¾åŒºä¸­å·²ç»æœ‰å¤§é‡çŽ°æˆçš„ Exporter å¯ä»¥ç›´æŽ¥ä½¿ç”¨ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥ä½¿ç”¨å„ç§è¯­è¨€çš„
  client library è‡ªå®šä¹‰å®žçŽ°ã€‚
- **Push gateway**ï¼šä¸»è¦ç”¨äºŽçž¬æ—¶ä»»åŠ¡çš„åœºæ™¯ï¼Œé˜²æ­¢ Prometheus Server æ¥ pull æ•°æ®ä¹‹å‰æ­¤ç±» Short-lived jobs å°±å·²ç»æ‰§è¡Œå®Œæ¯•äº†ï¼Œå› æ­¤
  job å¯ä»¥é‡‡ç”¨ push çš„æ–¹å¼å°†ç›‘æŽ§æ•°æ®ä¸»åŠ¨æ±‡æŠ¥ç»™ Push gateway ç¼“å­˜èµ·æ¥è¿›è¡Œä¸­è½¬ã€‚
- å½“å‘Šè­¦äº§ç”Ÿæ—¶ï¼ŒPrometheus Server å°†å‘Šè­¦ä¿¡æ¯æŽ¨é€ç»™ Alert Managerï¼Œç”±å®ƒå‘é€å‘Šè­¦ä¿¡æ¯ç»™æŽ¥æ”¶æ–¹ã€‚
- Prometheus å†…ç½®äº†ä¸€ä¸ªç®€å•çš„ web æŽ§åˆ¶å°ï¼Œå¯ä»¥æŸ¥è¯¢é…ç½®ä¿¡æ¯å’ŒæŒ‡æ ‡ç­‰ï¼Œè€Œå®žé™…åº”ç”¨ä¸­æˆ‘ä»¬é€šå¸¸ä¼šå°† Prometheus ä½œä¸º Grafana
  çš„æ•°æ®æºï¼Œåˆ›å»ºä»ªè¡¨ç›˜ä»¥åŠæŸ¥çœ‹æŒ‡æ ‡ã€‚

æŽ¨èä¸€æœ¬ Prometheus çš„å¼€æºä¹¦ç±[ã€ŠPrometheus æ“ä½œæŒ‡å—ã€‹](https://yunlzheng.gitbook.io/prometheus-book/)ã€‚

#### æ€»ç»“

- ç›‘æŽ§æ˜¯ä¸€é¡¹é•¿æœŸå»ºè®¾çš„äº‹æƒ…ï¼Œä¸€å¼€å§‹å°±æƒ³åšä¸€ä¸ª All In One çš„ç›‘æŽ§è§£å†³æ–¹æ¡ˆï¼Œæˆ‘è§‰å¾—æ²¡æœ‰å¿…è¦ã€‚ä»Žæˆæœ¬è§’åº¦è€ƒè™‘ï¼Œåœ¨åˆæœŸç›´æŽ¥ä½¿ç”¨å¼€æºçš„ç›‘æŽ§æ–¹æ¡ˆå³å¯ï¼Œå…ˆè§£å†³æœ‰æ— é—®é¢˜ã€‚
- Zabbixã€Open-Falcon å’Œ Prometheus éƒ½æ”¯æŒå’Œ Grafana åšå¿«é€Ÿé›†æˆï¼Œæƒ³è¦ç¾Žè§‚ä¸”å¼ºå¤§çš„å¯è§†åŒ–ä½“éªŒï¼Œå¯ä»¥å’Œ Grafana è¿›è¡Œç»„åˆã€‚
- Open-Falcon çš„æ ¸å¿ƒä¼˜åŠ¿åœ¨äºŽæ•°æ®åˆ†ç‰‡åŠŸèƒ½ï¼Œèƒ½æ”¯æ’‘æ›´å¤šçš„æœºå™¨å’Œç›‘æŽ§é¡¹ï¼›Prometheus åˆ™æ˜¯å®¹å™¨ç›‘æŽ§æ–¹é¢çš„æ ‡é…ï¼Œæœ‰ Google å’Œ k8s åŠ æŒã€‚

### **æœåŠ¡æ²»ç†ï¼šåˆ†å¸ƒå¼ä¸‹å¦‚ä½•è¿›è¡Œæ—¥å¿—ç®¡ç†ï¼Ÿ**

å› ä¸ºæ—¥å¿—ç³»ç»Ÿåœ¨è¯¢é—®é¡¹ç›®ç»åŽ†çš„æ—¶å€™ç»å¸¸ä¼šè¢«é—®åˆ°ï¼Œæ‰€ä»¥ï¼Œæˆ‘å°±å†™äº†è¿™ç¯‡æ–‡ç« ã€‚

è¿™æ˜¯ä¸€ç¯‡æ—¥å¿—ç³»ç»Ÿå¸¸è§æ¦‚å¿µçš„æ‰«ç›²ç¯‡~ä¸ä¼šæ¶‰åŠåˆ°å…·ä½“æž¶æž„çš„æ—¥å¿—ç³»ç»Ÿçš„æ­å»ºè¿‡ç¨‹ã€‚æ—¨åœ¨å¸®åŠ©å¯¹äºŽæ—¥å¿—ç³»ç»Ÿä¸å¤ªäº†è§£çš„å°ä¼™ä¼´ï¼Œæ™®åŠä¸€äº›æ—¥å¿—ç³»ç»Ÿå¸¸è§çš„æ¦‚å¿µã€‚

#### ä½•ä¸ºæ—¥å¿—ï¼Ÿ

åœ¨æˆ‘çœ‹æ¥ï¼Œæ—¥å¿—å°±æ˜¯ç³»ç»Ÿå¯¹æŸäº›è¡Œä¸ºçš„ä¸€äº›è®°å½•ï¼Œè¿™äº›è¡Œä¸ºåŒ…æ‹¬ï¼šç³»ç»Ÿå‡ºçŽ°é”™è¯¯ï¼ˆå®šä½é—®é¢˜ã€è§£å†³é—®é¢˜ï¼‰ã€è®°å½•å…³é”®çš„ä¸šåŠ¡ä¿¡æ¯ï¼ˆå®šä½é—®é¢˜ã€è§£å†³é—®é¢˜ï¼‰ã€è®°å½•æ“ä½œè¡Œä¸ºï¼ˆä¿éšœå®‰å…¨ï¼‰ç­‰ç­‰ã€‚

æŒ‰ç…§è¾ƒä¸ºå®˜æ–¹çš„è¯æ¥è¯´ï¼šâ€œæ—¥å¿—æ˜¯å¸¦æ—¶é—´æˆ³çš„åŸºäºŽæ—¶é—´åºåˆ—çš„æœºå™¨æ•°æ®ï¼ŒåŒ…æ‹¬ IT
ç³»ç»Ÿä¿¡æ¯ï¼ˆæœåŠ¡å™¨ã€ç½‘ç»œè®¾å¤‡ã€æ“ä½œç³»ç»Ÿã€åº”ç”¨è½¯ä»¶ï¼‰ã€ç‰©è”ç½‘å„ç§ä¼ æ„Ÿå™¨ä¿¡æ¯ã€‚æ—¥å¿—å¯ä»¥åæ˜ ç”¨æˆ·/æœºå™¨çš„è¡Œä¸ºï¼Œæ˜¯çœŸå®žçš„æ•°æ®â€ã€‚

#### ä¸ºä½•è¦ç”¨æ—¥å¿—ç³»ç»Ÿï¼Ÿ

æ²¡æœ‰æ—¥å¿—ç³»ç»Ÿä¹‹å‰ï¼Œæˆ‘ä»¬çš„æ—¥å¿—å¯èƒ½åˆ†å¸ƒåœ¨å¤šå°æœåŠ¡å™¨ä¸Šã€‚æ¯æ¬¡éœ€è¦æŸ¥çœ‹æ—¥å¿—ï¼Œæˆ‘ä»¬éƒ½éœ€è¦ç™»å½•æ¯å°æœºå™¨ã€‚ç„¶åŽï¼Œä½¿ç”¨ `grep`ã€`wc` ç­‰ Linux
å‘½ä»¤æ¥å¯¹æ—¥å¿—è¿›è¡Œæœç´¢ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯éžå¸¸éº»çƒ¦å¹¶ä¸”è€—æ—¶çš„ï¼å¹¶ä¸”ï¼Œæ—¥å¿—é‡ä¸å¤§çš„æ—¶å€™ï¼Œè¿™ä¸ªé€Ÿåº¦è¿˜èƒ½å¿å—ã€‚å½“æ—¥å¿—é‡æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œæ•´ä¸ªè¿‡ç¨‹å°±æ˜¯éžå¸¸æ…¢ã€‚

ä»Žä¸Šé¢æˆ‘çš„æè¿°ä¸­ï¼Œä½ å·²ç»å‘çŽ°ï¼Œæ²¡æœ‰å¯¹æ—¥å¿—å®žçŽ°é›†ä¸­ç®¡ç†ï¼Œä¸»è¦ç»™æˆ‘ä»¬å¸¦æ¥äº†ä¸‹é¢è¿™å‡ ç‚¹é—®é¢˜ï¼š

1. å¼€å‘äººå‘˜ç™»å½•çº¿ä¸ŠæœåŠ¡å™¨æŸ¥çœ‹æ—¥å¿—æ¯”è¾ƒéº»çƒ¦å¹¶ä¸”å­˜åœ¨å®‰å…¨éšæ‚£
2. æ—¥å¿—æ•°æ®æ¯”è¾ƒåˆ†æ•£ï¼Œéš¾ä»¥ç»´æŠ¤ï¼Œä¸æ–¹ä¾¿æ£€ç´¢ã€‚
3. æ—¥å¿—æ•°é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼ŒæŸ¥è¯¢é€Ÿåº¦æ¯”è¾ƒæ…¢ã€‚
4. æ— æ³•å¯¹æ—¥å¿—æ•°æ®è¿›è¡Œå¯è§†åŒ–å±•ç¤ºã€‚

**æ—¥å¿—ç³»ç»Ÿå°±æ˜¯ä¸ºäº†å¯¹æ—¥å¿—å®žçŽ°é›†ä¸­ç®¡ç†ã€‚å®ƒä¹Ÿæ˜¯ä¸€ä¸ªç³»ç»Ÿï¼Œä¸è¿‡ä¸»è¦æ˜¯è´Ÿè´£å¤„ç†æ—¥å¿—ç½¢äº†ã€‚**

#### ä¸€ä¸ªæœ€åŸºæœ¬çš„æ—¥å¿—ç³»ç»Ÿè¦åšå“ªäº›äº‹æƒ…ï¼Ÿ

ä¸ºäº†è§£å†³æ²¡æœ‰æ—¥å¿—ç³»ç»Ÿçš„æ—¶å€™ï¼Œå­˜åœ¨çš„ä¸€äº›é—®é¢˜ï¼Œä¸€ç›´æœ€åŸºæœ¬çš„ **æ—¥å¿—ç³»ç»Ÿéœ€è¦åšå“ªäº›äº‹æƒ…å‘¢ï¼Ÿ**

1. **é‡‡é›†æ—¥å¿—** ï¼šæ”¯æŒå¤šç§æ—¥å¿—æ ¼å¼ä»¥åŠæ•°æ®æºçš„é‡‡é›†ã€‚

2. **æ—¥å¿—æ•°æ®æ¸…æ´—/å¤„ç†** ï¼šé‡‡é›†åˆ°çš„åŽŸå§‹æ—¥å¿—æ•°æ®éœ€è¦é¦–å…ˆæ¸…æ´—/å¤„ç†ä¸€æ³¢ã€‚

3. **å­˜å‚¨** ï¼šä¸ºäº†æ–¹ä¾¿å¯¹æ¸…æ´—åŽçš„æ—¥å¿—è¿›è¡Œå¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æŽ¥å¤šç§å­˜å‚¨æ–¹å¼æ¯”å¦‚ ElasticSearchï¼ˆæ—¥å¿—æ£€ç´¢ï¼‰ ã€Hadoop(ç¦»çº¿æ•°æ®åˆ†æž)ã€‚

4. **å±•ç¤ºä¸Žæœç´ ** ï¼šæ”¯æŒå¯è§†åŒ–åœ°å±•ç¤ºæ—¥å¿—ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ ¹æ®å…³é”®è¯å¿«é€Ÿçš„å®šä½åˆ°æ—¥å¿—å¹¶æŸ¥çœ‹æ—¥å¿—ä¸Šä¸‹æ–‡ã€‚

5. **å‘Šè­¦** ï¼šæ”¯æŒå¯¹æŽ¥å¸¸è§çš„ç›‘æŽ§ç³»ç»Ÿã€‚

æˆ‘ä¸“é—¨ç”»äº†ä¸€å¼ å›¾ï¼Œå±•ç¤ºä¸€ä¸‹æ—¥å¿—ç³»ç»Ÿå¤„ç†æ—¥å¿—çš„ä¸€ä¸ªåŸºæœ¬æµç¨‹ã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2Fimg_convert%2F39558d5db0fab7865088a9ab3626f575.png)

å¦å¤–ï¼Œä¸€äº›æ¯”è¾ƒé«˜å¤§ä¸Šçš„æ—¥å¿—ç³»ç»Ÿç”šè‡³è¿˜æ”¯æŒ **å®žæ—¶åˆ†æžã€ç¦»çº¿åˆ†æž** ç­‰åŠŸèƒ½

#### ELK äº†è§£ä¹ˆï¼Ÿ

ELK æ˜¯ç›®å‰ä½¿ç”¨çš„æ¯”è¾ƒå¤šçš„ä¸€ä¸ªå¼€æºçš„æ—¥å¿—ç³»ç»Ÿè§£å†³æ–¹æ¡ˆï¼ŒèƒŒé æ˜¯ [Elastic](https://www.elastic.co/cn/) è¿™å®¶ä¸“æ³¨æœç´¢çš„å…¬å¸ã€‚

##### ELK è€ä¸‰ä»¶å¥—

æœ€åŽŸå§‹çš„æ—¶å€™ï¼ŒELK æ˜¯ç”± 3 ä¸ªå¼€æºé¡¹ç›®çš„é¦–å­—æ¯æž„æˆï¼Œåˆ†åˆ«æ˜¯ **E**lasticsearch ã€**L**ogstashã€**K**ibanaã€‚

ä¸‹å›¾æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ **ELK æ—¥å¿—ç³»ç»Ÿæž¶æž„ ï¼š**

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2Fimg_convert%2F7dc144a91d2afa1126889d250fb3ac03.png)

æˆ‘ä»¬åˆ†åˆ«æ¥ä»‹ç»ä¸€ä¸‹è¿™äº›å¼€æºé¡¹ç›®ä»¥åŠå®ƒä»¬åœ¨è¿™ä¸ªæ—¥å¿—ç³»ç»Ÿä¸­èµ·åˆ°çš„ä½œç”¨ï¼š

- **Logstash** ï¼šLogstash ä¸»è¦ç”¨äºŽæ—¥å¿—çš„æœé›†ã€åˆ†æžå’Œè¿‡æ»¤ï¼Œæ”¯æŒå¯¹å¤šç§æ—¥å¿—ç±»åž‹è¿›è¡Œå¤„ç†ã€‚åœ¨ ELK æ—¥å¿—ç³»ç»Ÿä¸­ï¼ŒLogstash è´Ÿè´£æ—¥å¿—çš„æ”¶é›†å’Œæ¸…æ´—ã€‚
- **Elasticsearch** ï¼šElasticSearch ä¸€æ¬¾ä½¿ç”¨ **Java** è¯­è¨€å¼€å‘çš„æœç´¢å¼•æ“Žï¼ŒåŸºäºŽ **Lucence**
  ã€‚å¯ä»¥è§£å†³ä½¿ç”¨æ•°æ®åº“è¿›è¡Œæ¨¡ç³Šæœç´¢æ—¶å­˜åœ¨çš„æ€§èƒ½é—®é¢˜ï¼Œæä¾›æµ·é‡æ•°æ®è¿‘å®žæ—¶çš„æ£€ç´¢ä½“éªŒã€‚åœ¨ ELK æ—¥å¿—ç³»ç»Ÿä¸­ï¼ŒElasticsearch è´Ÿè´£æ—¥å¿—çš„æœç´ ã€‚
- **Kibana** ï¼šKibana æ˜¯ä¸“é—¨è®¾è®¡ç”¨æ¥ä¸Ž Elasticsearch åä½œçš„ï¼Œå¯ä»¥è‡ªå®šä¹‰å¤šç§è¡¨æ ¼ã€æŸ±çŠ¶å›¾ã€é¥¼çŠ¶å›¾ã€æŠ˜çº¿å›¾å¯¹å­˜å‚¨åœ¨ Elasticsearch
  ä¸­çš„æ•°æ®è¿›è¡Œæ·±å…¥æŒ–æŽ˜åˆ†æžä¸Žå¯è§†åŒ–ã€‚ ELK æ—¥å¿—ç³»ç»Ÿä¸­ï¼ŒLogstash ä¸»è¦è´Ÿè´£å¯¹ä»Ž Elasticsearch ä¸­æœç´¢å‡ºæ¥çš„æ—¥å¿—è¿›è¡Œå¯è§†åŒ–å±•ç¤ºã€‚

##### æ–°ä¸€ä»£ ELK æž¶æž„

ELK å±žäºŽæ¯”è¾ƒè€ç‰Œçš„ä¸€æ¬¾æ—¥å¿—ç³»ç»Ÿè§£å†³æ–¹æ¡ˆï¼Œè¿™ä¸ªæ–¹æ¡ˆå­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼š**Logstash å¯¹èµ„æºæ¶ˆè€—è¿‡é«˜ã€‚**

äºŽæ˜¯ï¼Œ Elastic æŽ¨å‡ºäº† Beats ã€‚Beats åŸºäºŽåä¸º[libbeat](https://github.com/elastic/beats/tree/master/libbeat)çš„ Go æ¡†æž¶ï¼Œä¸€å…±åŒ…å«
8 ä½æˆå‘˜ã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2Fimg_convert%2Fc16f973d5532a0a4f0d686ee6645b67f.png)

è¿™ä¸ªæ—¶å€™ï¼ŒELK å·²ç»ä¸ä»…ä»…ä»£è¡¨ **E**lasticsearch ã€**L**ogstashã€**K**ibana è¿™ 3 ä¸ªå¼€æºé¡¹ç›®äº†ã€‚

Elastic å®˜æ–¹å°† ELK é‡å‘½åä¸º **Elastic Stack**ï¼ˆElasticsearchã€Kibanaã€Beats å’Œ Logstashï¼‰ã€‚ä½†æ˜¯ï¼Œå¤§å®¶ç›®å‰ä»ç„¶ä¹ æƒ¯å°†å…¶æˆä¸º
ELK ã€‚

Elastic çš„å®˜æ–¹æ–‡æ¡£æ˜¯è¿™æ ·æè¿°çš„ï¼ˆç”± Chrome æ’ä»¶ Mate Translate æä¾›ç¿»è¯‘åŠŸèƒ½ï¼‰ï¼š

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2Fimg_convert%2F274a1a229d2e5dff517e065ecf7b436e.png)

çŽ°åœ¨çš„ ELK æž¶æž„å˜æˆäº†è¿™æ ·ï¼š

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2Fimg_convert%2Fff75430c69e043a044bef1a355023dfe-167635397809056.png)

Beats é‡‡é›†çš„æ•°æ®å¯ä»¥ç›´æŽ¥å‘é€åˆ° Elasticsearch æˆ–è€…åœ¨ Logstash è¿›ä¸€æ­¥å¤„ç†ä¹‹åŽå†å‘é€åˆ° Elasticsearchã€‚

Beats çš„è¯žç”Ÿï¼Œä¹Ÿå¤§å¤§åœ°æ‰©å±•äº†è€ä¸‰ä»¶å¥—ç‰ˆæœ¬çš„ ELK çš„åŠŸèƒ½ã€‚Beats ç»„ä»¶é™¤äº†èƒ½å¤Ÿé€šè¿‡ Filebeat é‡‡é›†æ—¥å¿—ä¹‹å¤–ï¼Œè¿˜èƒ½é€šè¿‡ Metricbeat
é‡‡é›†æœåŠ¡å™¨çš„å„ç§æŒ‡æ ‡ï¼Œé€šè¿‡ Packetbeat é‡‡é›†ç½‘ç»œæ•°æ®ã€‚

æˆ‘ä»¬ä¸éœ€è¦å°† Beats éƒ½ç”¨ä¸Šï¼Œä¸€èˆ¬å¯¹äºŽä¸€ä¸ªåŸºæœ¬çš„æ—¥å¿—ç³»ç»Ÿï¼Œåªéœ€è¦ **Filebeat** å°±å¤Ÿäº†ã€‚

æ ¹æ®[Filebeat å®˜æ–¹ä»‹ç»](https://www.elastic.co/cn/beats/filebeat)ï¼š

> Filebeat æ˜¯ä¸€ä¸ªè½»é‡åž‹æ—¥å¿—é‡‡é›†å™¨ã€‚æ— è®ºæ‚¨æ˜¯ä»Žå®‰å…¨è®¾å¤‡ã€äº‘ã€å®¹å™¨ã€ä¸»æœºè¿˜æ˜¯ OT è¿›è¡Œæ•°æ®æ”¶é›†ï¼ŒFilebeat
> éƒ½å°†ä¸ºæ‚¨æä¾›ä¸€ç§è½»é‡åž‹æ–¹æ³•ï¼Œç”¨äºŽè½¬å‘å’Œæ±‡æ€»æ—¥å¿—ä¸Žæ–‡ä»¶ï¼Œè®©ç®€å•çš„äº‹æƒ…ä¸å†ç¹æ‚ã€‚

Filebeat æ˜¯ Elastic Stack çš„ä¸€éƒ¨åˆ†ï¼Œèƒ½å¤Ÿä¸Ž Logstashã€Elasticsearch å’Œ Kibana æ— ç¼åä½œã€‚

Filebeat èƒ½å¤Ÿè½»æ¾åœ°å°†æ•°æ®ä¼ é€åˆ° Logstashï¼ˆå¯¹æ—¥å¿—è¿›è¡Œå¤„ç†ï¼‰ã€Elasticsearchï¼ˆæ—¥å¿—æ£€ç´¢ï¼‰ã€ç”šè‡³æ˜¯ Kibana ï¼ˆæ—¥å¿—å±•ç¤ºï¼‰ä¸­ã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2Fimg_convert%2Fc697787897052b1b8270c9904a7b06c8.png)

Filebeat åªæ˜¯å¯¹æ—¥å¿—è¿›è¡Œé‡‡é›†ï¼Œæ— æ³•å¯¹æ—¥å¿—è¿›è¡Œå¤„ç†ã€‚æ—¥å¿—å…·ä½“çš„å¤„ç†å¾€å¾€è¿˜æ˜¯è¦äº¤ç»™ Logstash æ¥åšã€‚

æ›´å¤šå…³äºŽ Filebeat
çš„å†…å®¹ï¼Œä½ å¯ä»¥çœ‹çœ‹ [Filebeat å®˜æ–¹æ–‡æ¡£æ•™ç¨‹](https://www.elastic.co/guide/en/beats/filebeat/current/index.html)ã€‚

##### Filebeat+Logstash+Elasticsearch+Kibana æž¶æž„æ¦‚è§ˆ

ä¸‹å›¾ä¸€ä¸ªæœ€åŸºæœ¬çš„ Filebeat+Logstash+Elasticsearch+Kibana
æž¶æž„å›¾ï¼Œå›¾ç‰‡æ¥æºäºŽï¼š[ã€ŠThe ELK Stack ( Elasticsearch, Logstash, and Kibana ) Using Filebeatã€‹](https://www.technolush.com/blog/the-elk-stack-using-filebeat)ã€‚

Filebeat æ›¿ä»£ Logstash é‡‡é›†æ—¥å¿—ï¼Œå…·ä½“çš„æ—¥å¿—å¤„ç†è¿˜æ˜¯ç”± Logstash æ¥åšã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2Fimg_convert%2F22f3304f9800c1a49ce1f5c610da262d.png)

é’ˆå¯¹ä¸Šå›¾çš„æ—¥å¿—ç³»ç»Ÿæž¶æž„å›¾ï¼Œæœ‰ä¸‹é¢å‡ ä¸ªå¯ä¼˜åŒ–ç‚¹ï¼š

1. åœ¨ Kibana å’Œç”¨æˆ·ä¹‹é—´ï¼Œä½¿ç”¨ Nginx æ¥åšåå‘ä»£ç†ï¼Œå…ç”¨æˆ·ç›´æŽ¥è®¿é—® Kibana æœåŠ¡å™¨ï¼Œæé«˜å®‰å…¨æ€§ã€‚
2. Filebeat å’Œ Logstash ä¹‹é—´å¢žåŠ ä¸€å±‚æ¶ˆæ¯é˜Ÿåˆ—æ¯”å¦‚ Kafkaã€RabbitMQã€‚Filebeat è´Ÿè´£å°†æ”¶é›†åˆ°çš„æ•°æ®å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒLogstash
   å–å‡ºæ•°æ®åšè¿›ä¸€æ­¥å¤„ç†ã€‚

##### EFK

EFK ä¸­çš„ F ä»£è¡¨çš„æ˜¯ [Fluentd](https://github.com/fluent/fluentd)ã€‚ä¸‹å›¾æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ **EFK æ—¥å¿—ç³»ç»Ÿæž¶æž„ ï¼š**

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2Fimg_convert%2F8005ba7b087ad3e00643e5f1c4a854b4.png)

Fluentd æ˜¯ä¸€æ¬¾å¼€æºçš„æ—¥å¿—æ”¶é›†å™¨ï¼Œä½¿ç”¨ Ruby ç¼–å†™ï¼Œå…¶æä¾›çš„åŠŸèƒ½å’Œ Logstash
å·®ä¸å¤šã€‚ä½†æ˜¯ï¼Œè¦æ›´åŠ è½»é‡ï¼Œæ€§èƒ½ä¹Ÿæ›´ä¼˜è¶Šï¼Œå†…å­˜å ç”¨ä¹Ÿæ›´ä½Žã€‚å…·ä½“ä½¿ç”¨æ•™ç¨‹ï¼Œå¯ä»¥å‚è€ƒ[ã€Šæ€§èƒ½ä¼˜è¶Šçš„è½»é‡çº§æ—¥å¿—æ”¶é›†å·¥å…·ï¼Œå¾®è½¯ã€äºšé©¬é€Šéƒ½åœ¨ç”¨ï¼ã€‹](https://mp.weixin.qq.com/s/sXYDIJpIhPsVGNkSCIaNfQ)ã€‚

#### è½»é‡çº§æ—¥å¿—ç³»ç»Ÿ Loki

ä¸Šé¢ä»‹ç»åˆ°çš„ ELK æ—¥å¿—ç³»ç»Ÿæ–¹æ¡ˆåŠŸèƒ½ä¸°å¯Œï¼Œç¨³å®šå¯é ã€‚ä¸è¿‡ï¼Œå¯¹èµ„æºçš„æ¶ˆè€—ä¹Ÿæ›´å¤§ï¼Œæˆæœ¬ä¹Ÿæ›´é«˜ã€‚è€Œä¸”ï¼Œç”¨è¿‡ ELK
æ—¥å¿—ç³»ç»Ÿçš„å°ä¼™ä¼´è‚¯å®šä¼šå‘çŽ°å…¶å®žå¾ˆå¤šåŠŸèƒ½åŽ‹æ ¹éƒ½ç”¨ä¸ä¸Šã€‚

å› æ­¤ï¼Œå°±æœ‰äº† Lokiï¼Œè¿™æ˜¯ä¸€ä¸ª Grafana Labs å›¢é˜Ÿå¼€æºçš„å°å·§æ˜“ç”¨çš„æ—¥å¿—ç³»ç»Ÿï¼ŒåŽŸç”Ÿæ”¯æŒ Grafanaã€‚

å¹¶ä¸”ï¼ŒLoki ä¸“é—¨ä¸º Prometheus å’Œ Kubernetes ç”¨æˆ·åšäº†ç›¸å…³ä¼˜åŒ–æ¯”å¦‚ Loki ç‰¹åˆ«é€‚åˆå­˜å‚¨Kubernetes Pod æ—¥å¿—ã€‚

> é¡¹ç›®åœ°å€ï¼šhttps://github.com/grafana/loki/

å®˜æ–¹çš„ä»‹ç»ä¹Ÿæ¯”è¾ƒæœ‰æ„æ€å“ˆï¼` Like Prometheus,But For Logs`. ï¼ˆç±»ä¼¼äºŽ Prometheus çš„æ—¥å¿—ç³»ç»Ÿï¼Œä¸è¿‡ä¸»è¦æ˜¯ä¸ºæ—¥å¿—æœåŠ¡çš„ï¼‰ã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2Fimg_convert%2Ff6df2d0349aad765e9c924ec469f5d59.png)

æ ¹æ®å®˜ç½‘ ï¼ŒLoki çš„æž¶æž„å¦‚ä¸‹å›¾æ‰€ç¤º

![img](é¢è¯•æŒ‡åŒ—.assets/imagesurl=https%3A%2F%2Fimg-blog.csdnimg.cn%2Fc629732c94614af8a474006aab05099d.png)

Loki çš„æ•´ä¸ªæž¶æž„éžå¸¸ç®€å•ï¼Œä¸»è¦æœ‰ 3 ä¸ªç»„ä»¶ç»„æˆï¼š

- Loki æ˜¯ä¸»æœåŠ¡å™¨ï¼Œè´Ÿè´£å­˜å‚¨æ—¥å¿—å’Œå¤„ç†æŸ¥è¯¢ã€‚
- Promtail æ˜¯ä»£ç†ï¼Œè´Ÿè´£æ”¶é›†æ—¥å¿—å¹¶å°†å…¶å‘é€ç»™ Loki ã€‚
- Grafana ç”¨äºŽ UI å±•ç¤ºã€‚

Loki æä¾›äº†è¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£ï¼Œä¸Šæ‰‹ç›¸å¯¹æ¥è¯´æ¯”è¾ƒå®¹æ˜“ã€‚å¹¶ä¸”ï¼Œç›®å‰å…¶æµè¡Œåº¦è¿˜æ˜¯å¯ä»¥çš„ã€‚ä½ å¯ä»¥å¾ˆæ–¹ä¾¿åœ¨ç½‘ç»œä¸Šæœç´¢åˆ°æœ‰å…³ Loki çš„åšæ–‡ã€‚

#### æ€»ç»“

è¿™ç¯‡æ–‡ç« æˆ‘ä¸»è¦ä»‹ç»äº†æ—¥å¿—ç³»ç»Ÿç›¸å…³çš„çŸ¥è¯†ï¼ŒåŒ…æ‹¬ï¼š

- ä½•ä¸ºæ—¥å¿—ï¼Ÿ
- ä¸ºä½•è¦ç”¨æ—¥å¿—ç³»ç»Ÿï¼Ÿä¸€ä¸ªåŸºæœ¬çš„æ—¥å¿—ç³»ç»Ÿè¦åšå“ªäº›äº‹æƒ…ï¼Ÿ
- ELKã€EFK
- è½»é‡çº§æ—¥å¿—ç³»ç»Ÿ Loki

å¦å¤–ï¼Œå¤§éƒ¨åˆ†å›¾ç‰‡éƒ½æ˜¯æˆ‘ä½¿ç”¨ draw.io æ¥ç»˜åˆ¶çš„ã€‚ä¸€äº›æŠ€æœ¯åè¯çš„å›¾æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æŽ¥é€šè¿‡ Google å›¾ç‰‡æœç´¢å³å¯ï¼Œæ–¹æ³•ï¼š
æŠ€æœ¯åè¯+å›¾æ ‡ï¼ˆç¤ºä¾‹ï¼šLogstash iconï¼‰

#### å‚è€ƒ

1. ELK æž¶æž„å’Œ Filebeat å·¥ä½œåŽŸç†è¯¦è§£ï¼šhttps://developer.ibm.com/zh/articles/os-cn-elk-filebeat/
2. ELK Introduction-elastic å®˜æ–¹ ï¼šhttps://elastic-stack.readthedocs.io/en/latest/introduction.html
3. ELK Stack Tutorial: Learn Elasticsearch, Logstash, and Kibana ï¼šhttps://www.guru99.com/elk-stack-tutorial.html
