## å¸¸è§æ¡†æ¶

### **SpringBoot å¸¸è§é¢è¯•é¢˜æ€»ç»“**

#### å‰–æé¢è¯•æœ€å¸¸è§é—®é¢˜ä¹‹  Spring Boot

å¸‚é¢ä¸Šå…³äº Spring Boot çš„é¢è¯•é¢˜æŠ„æ¥æŠ„å»ï¼Œæ¯«æ— ä»·å€¼å¯è¨€ã€‚

è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä¼šç®€å•å°±è‡ªå·±è¿™å‡ å¹´ä½¿ç”¨ Spring Boot çš„ä¸€äº›ç»éªŒï¼Œæ€»ç»“ä¸€äº›å¸¸è§çš„é¢è¯•é¢˜ä¾›å°ä¼™ä¼´ä»¬è‡ªæµ‹å’Œå­¦ä¹ ã€‚å°‘éƒ¨åˆ†å…³äº
Spring/Spring Boot çš„ä»‹ç»å‚è€ƒäº†å®˜ç½‘ï¼Œå…¶ä»–çš†ä¸ºåŸåˆ›ã€‚

##### 1. ç®€å•ä»‹ç»ä¸€ä¸‹ Spring?æœ‰å•¥ç¼ºç‚¹?

Spring æ˜¯é‡é‡çº§ä¼ä¸šå¼€å‘æ¡†æ¶ **Enterprise JavaBeanï¼ˆEJBï¼‰** çš„æ›¿ä»£å“ï¼ŒSpring ä¸ºä¼ä¸šçº§ Java å¼€å‘æä¾›äº†ä¸€ç§ç›¸å¯¹ç®€å•çš„æ–¹æ³•ï¼Œé€šè¿‡
ä¾èµ–æ³¨å…¥ å’Œ **é¢å‘åˆ‡é¢ç¼–ç¨‹** ï¼Œç”¨ç®€å•çš„ **Java å¯¹è±¡ï¼ˆPlain Old Java Objectï¼ŒPOJOï¼‰** å®ç°äº† EJB çš„åŠŸèƒ½

**è™½ç„¶ Spring çš„ç»„ä»¶ä»£ç æ˜¯è½»é‡çº§çš„ï¼Œä½†å®ƒçš„é…ç½®å´æ˜¯é‡é‡çº§çš„ï¼ˆéœ€è¦å¤§é‡ XML é…ç½®ï¼‰ ã€‚**

ä¸ºæ­¤ï¼ŒSpring 2.5 å¼•å…¥äº†åŸºäºæ³¨è§£çš„ç»„ä»¶æ‰«æï¼Œè¿™æ¶ˆé™¤äº†å¤§é‡é’ˆå¯¹åº”ç”¨ç¨‹åºè‡ªèº«ç»„ä»¶çš„æ˜¾å¼ XML é…ç½®ã€‚Spring 3.0 å¼•å…¥äº†åŸºäº Java
çš„é…ç½®ï¼Œè¿™æ˜¯ä¸€ç§ç±»å‹å®‰å…¨çš„å¯é‡æ„é…ç½®æ–¹å¼ï¼Œå¯ä»¥ä»£æ›¿ XMLã€‚

å°½ç®¡å¦‚æ­¤ï¼Œæˆ‘ä»¬ä¾æ—§æ²¡èƒ½é€ƒè„±é…ç½®çš„é­”çˆªã€‚å¼€å¯æŸäº› Spring ç‰¹æ€§æ—¶ï¼Œæ¯”å¦‚äº‹åŠ¡ç®¡ç†å’Œ Spring MVCï¼Œè¿˜æ˜¯éœ€è¦ç”¨ XML æˆ– Java
è¿›è¡Œæ˜¾å¼é…ç½®ã€‚å¯ç”¨ç¬¬ä¸‰æ–¹åº“æ—¶ä¹Ÿéœ€è¦æ˜¾å¼é…ç½®ï¼Œæ¯”å¦‚åŸºäº Thymeleaf çš„ Web è§†å›¾ã€‚é…ç½® Servlet å’Œè¿‡æ»¤å™¨ï¼ˆæ¯”å¦‚ Spring
çš„DispatcherServletï¼‰åŒæ ·éœ€è¦åœ¨ web.xml æˆ– Servlet åˆå§‹åŒ–ä»£ç é‡Œè¿›è¡Œæ˜¾å¼é…ç½®ã€‚ç»„ä»¶æ‰«æå‡å°‘äº†é…ç½®é‡ï¼ŒJava é…ç½®è®©å®ƒçœ‹ä¸Šå»ç®€æ´ä¸å°‘ï¼Œä½†
Spring è¿˜æ˜¯éœ€è¦ä¸å°‘é…ç½®ã€‚

å…‰é…ç½®è¿™äº› XML æ–‡ä»¶éƒ½å¤Ÿæˆ‘ä»¬å¤´ç–¼çš„äº†ï¼Œå ç”¨äº†æˆ‘ä»¬å¤§éƒ¨åˆ†æ—¶é—´å’Œç²¾åŠ›ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œç›¸å…³åº“çš„ä¾èµ–éå¸¸è®©äººå¤´ç–¼ï¼Œä¸åŒåº“ä¹‹é—´çš„ç‰ˆæœ¬å†²çªä¹Ÿéå¸¸å¸¸è§ã€‚

##### 2. ä¸ºä»€ä¹ˆè¦æœ‰ SpringBoot?

Spring æ—¨åœ¨ç®€åŒ– J2EE ä¼ä¸šåº”ç”¨ç¨‹åºå¼€å‘ã€‚Spring Boot æ—¨åœ¨ç®€åŒ– Spring å¼€å‘ï¼ˆå‡å°‘é…ç½®æ–‡ä»¶ï¼Œå¼€ç®±å³ç”¨ï¼ï¼‰ã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/c7f84ba8-d183-4d3a-ad1a-5225c00c9247.png)

##### 3. è¯´å‡ºä½¿ç”¨ Spring Boot çš„ä¸»è¦ä¼˜ç‚¹

1. å¼€å‘åŸºäº Spring çš„åº”ç”¨ç¨‹åºå¾ˆå®¹æ˜“ã€‚
2. Spring Boot é¡¹ç›®æ‰€éœ€çš„å¼€å‘æˆ–å·¥ç¨‹æ—¶é—´æ˜æ˜¾å‡å°‘ï¼Œé€šå¸¸ä¼šæé«˜æ•´ä½“ç”Ÿäº§åŠ›ã€‚
3. Spring Boot ä¸éœ€è¦ç¼–å†™å¤§é‡æ ·æ¿ä»£ç ã€XML é…ç½®å’Œæ³¨é‡Šã€‚
4. Spring å¼•å¯¼åº”ç”¨ç¨‹åºå¯ä»¥å¾ˆå®¹æ˜“åœ°ä¸ Spring ç”Ÿæ€ç³»ç»Ÿé›†æˆï¼Œå¦‚ Spring JDBCã€Spring ORMã€Spring Dataã€Spring Security ç­‰ã€‚
5. Spring Boot éµå¾ªâ€œå›ºæ‰§å·±è§çš„é»˜è®¤é…ç½®â€ï¼Œä»¥å‡å°‘å¼€å‘å·¥ä½œï¼ˆé»˜è®¤é…ç½®å¯ä»¥ä¿®æ”¹ï¼‰ã€‚
6. Spring Boot åº”ç”¨ç¨‹åºæä¾›åµŒå…¥å¼ HTTP æœåŠ¡å™¨ï¼Œå¦‚ Tomcat å’Œ Jettyï¼Œå¯ä»¥è½»æ¾åœ°å¼€å‘å’Œæµ‹è¯• web åº”ç”¨ç¨‹åºã€‚ï¼ˆè¿™ç‚¹å¾ˆèµï¼æ™®é€šè¿è¡Œ
   Java ç¨‹åºçš„æ–¹å¼å°±èƒ½è¿è¡ŒåŸºäº Spring Boot web é¡¹ç›®ï¼Œçœäº‹å¾ˆå¤šï¼‰
7. Spring Boot æä¾›å‘½ä»¤è¡Œæ¥å£(CLI)å·¥å…·ï¼Œç”¨äºå¼€å‘å’Œæµ‹è¯• Spring Boot åº”ç”¨ç¨‹åºï¼Œå¦‚ Java æˆ– Groovyã€‚
8. Spring Boot æä¾›äº†å¤šç§æ’ä»¶ï¼Œå¯ä»¥ä½¿ç”¨å†…ç½®å·¥å…·(å¦‚ Maven å’Œ Gradle)å¼€å‘å’Œæµ‹è¯• Spring Boot åº”ç”¨ç¨‹åºã€‚

##### 4. ä»€ä¹ˆæ˜¯ Spring Boot Starters?

Spring Boot Starters æ˜¯ä¸€ç³»åˆ—ä¾èµ–å…³ç³»çš„é›†åˆï¼Œå› ä¸ºå®ƒçš„å­˜åœ¨ï¼Œé¡¹ç›®çš„ä¾èµ–ä¹‹é—´çš„å…³ç³»å¯¹æˆ‘ä»¬æ¥è¯´å˜çš„æ›´åŠ ç®€å•äº†ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šåœ¨æ²¡æœ‰ Spring Boot Starters ä¹‹å‰ï¼Œæˆ‘ä»¬å¼€å‘ REST æœåŠ¡æˆ– Web åº”ç”¨ç¨‹åºæ—¶; æˆ‘ä»¬éœ€è¦ä½¿ç”¨åƒ Spring MVCï¼ŒTomcat å’Œ
Jackson è¿™æ ·çš„åº“ï¼Œè¿™äº›ä¾èµ–æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ä¸€ä¸ªä¸€ä¸ªæ·»åŠ ã€‚ä½†æ˜¯ï¼Œæœ‰äº† Spring Boot Starters æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªåªéœ€æ·»åŠ ä¸€ä¸ª*
*spring-boot-starter-web**ä¸€ä¸ªä¾èµ–å°±å¯ä»¥äº†ï¼Œè¿™ä¸ªä¾èµ–åŒ…å«çš„å­ä¾èµ–ä¸­åŒ…å«äº†æˆ‘ä»¬å¼€å‘ REST æœåŠ¡éœ€è¦çš„æ‰€æœ‰ä¾èµ–ã€‚

```xml

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
```

##### 5. Spring Boot æ”¯æŒå“ªäº›å†…åµŒ Servlet å®¹å™¨ï¼Ÿ

Spring Boot æ”¯æŒä»¥ä¸‹åµŒå…¥å¼ Servlet å®¹å™¨:

| Name         | Servlet Version |
|--------------|-----------------|
| Tomcat 9.0   | 4.0             |
| Jetty 9.4    | 3.1             |
| Undertow 2.0 | 4.0             |

æ‚¨è¿˜å¯ä»¥å°† Spring å¼•å¯¼åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°ä»»ä½• Servlet 3.1+å…¼å®¹çš„ Web å®¹å™¨ä¸­ã€‚

è¿™å°±æ˜¯ä½ ä¸ºä»€ä¹ˆå¯ä»¥é€šè¿‡ç›´æ¥åƒè¿è¡Œ æ™®é€š Java é¡¹ç›®ä¸€æ ·è¿è¡Œ SpringBoot é¡¹ç›®ã€‚è¿™æ ·çš„ç¡®çœäº‹äº†å¾ˆå¤šï¼Œæ–¹ä¾¿äº†æˆ‘ä»¬è¿›è¡Œå¼€å‘ï¼Œé™ä½äº†å­¦ä¹ éš¾åº¦ã€‚

##### 6. å¦‚ä½•åœ¨ Spring Boot åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ Jetty è€Œä¸æ˜¯ Tomcat?

Spring Boot ï¼ˆspring-boot-starter-webï¼‰ä½¿ç”¨ Tomcat ä½œä¸ºé»˜è®¤çš„åµŒå…¥å¼ servlet å®¹å™¨, å¦‚æœä½ æƒ³ä½¿ç”¨ Jetty
çš„è¯åªéœ€è¦ä¿®æ”¹pom.xml(Maven)æˆ–è€…build.gradle(Gradle)å°±å¯ä»¥äº†ã€‚

**Maven:**

```xml
<!--ä»Webå¯åŠ¨å™¨ä¾èµ–ä¸­æ’é™¤Tomcat-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
    <exclusions>
        <exclusion>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-tomcat</artifactId>
        </exclusion>
    </exclusions>
</dependency>
        <!--æ·»åŠ Jettyä¾èµ–-->
<dependency>
<groupId>org.springframework.boot</groupId>
<artifactId>spring-boot-starter-jetty</artifactId>
</dependency>
```

**Gradle:**

```groovy
compile("org.springframework.boot:spring-boot-starter-web") {
     exclude group: 'org.springframework.boot', module: 'spring-boot-starter-tomcat'
}
compile("org.springframework.boot:spring-boot-starter-jetty")
```

è¯´ä¸ªé¢˜å¤–è¯ï¼Œä»ä¸Šé¢å¯ä»¥çœ‹å‡ºä½¿ç”¨ Gradle æ›´åŠ ç®€æ´æ˜äº†ï¼Œä½†æ˜¯å›½å†…ç›®å‰è¿˜æ˜¯ Maven ä½¿ç”¨çš„å¤šä¸€ç‚¹ï¼Œæˆ‘ä¸ªäººè§‰å¾— Gradle åœ¨å¾ˆå¤šæ–¹é¢éƒ½è¦å¥½å¾ˆå¤šã€‚

##### 7. ä»‹ç»ä¸€ä¸‹@SpringBootApplication æ³¨è§£

```java
package org.springframework.boot.autoconfigure;
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@SpringBootConfiguration
@EnableAutoConfiguration
@ComponentScan(excludeFilters = {
		@Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),
		@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) })
public @interface SpringBootApplication {
   ......
}
```

```java
package org.springframework.boot;
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Configuration
public @interface SpringBootConfiguration {

}
```

å¯ä»¥çœ‹å‡ºå¤§æ¦‚å¯ä»¥æŠŠ `@SpringBootApplication`çœ‹ä½œæ˜¯` @Configurationã€@EnableAutoConfigurationã€@ComponentScan `æ³¨è§£çš„é›†åˆã€‚æ ¹æ®
SpringBoot å®˜ç½‘ï¼Œè¿™ä¸‰ä¸ªæ³¨è§£çš„ä½œç”¨åˆ†åˆ«æ˜¯ï¼š

- `@EnableAutoConfiguration`ï¼šå¯ç”¨ SpringBoot çš„è‡ªåŠ¨é…ç½®æœºåˆ¶
- `@ComponentScan`ï¼š æ‰«æè¢«`@Component` (`@Service,@Controller`)æ³¨è§£çš„` bean`ï¼Œæ³¨è§£é»˜è®¤ä¼šæ‰«æè¯¥ç±»æ‰€åœ¨çš„åŒ…ä¸‹æ‰€æœ‰çš„ç±»ã€‚
- `@Configuration`ï¼šå…è®¸åœ¨ä¸Šä¸‹æ–‡ä¸­æ³¨å†Œé¢å¤–çš„` bean` æˆ–å¯¼å…¥å…¶ä»–é…ç½®ç±»

##### 8. Spring Boot çš„è‡ªåŠ¨é…ç½®æ˜¯å¦‚ä½•å®ç°çš„?

è¿™ä¸ªæ˜¯å› ä¸º`@SpringBootApplication`æ³¨è§£çš„åŸå› ï¼Œåœ¨ä¸Šä¸€ä¸ªé—®é¢˜ä¸­å·²ç»æåˆ°äº†è¿™ä¸ªæ³¨è§£ã€‚æˆ‘ä»¬çŸ¥é“ `@SpringBootApplication`
çœ‹ä½œæ˜¯ `@Configurationã€@EnableAutoConfigurationã€@ComponentScan `æ³¨è§£çš„é›†åˆã€‚

- `@EnableAutoConfiguration`ï¼šå¯ç”¨ SpringBoot çš„è‡ªåŠ¨é…ç½®æœºåˆ¶
- `@ComponentScan`ï¼š æ‰«æè¢«`@Component (@Service,@Controller)`æ³¨è§£çš„ beanï¼Œæ³¨è§£é»˜è®¤ä¼šæ‰«æè¯¥ç±»æ‰€åœ¨çš„åŒ…ä¸‹æ‰€æœ‰çš„ç±»ã€‚
- `@Configuration`ï¼šå…è®¸åœ¨ä¸Šä¸‹æ–‡ä¸­æ³¨å†Œé¢å¤–çš„ bean æˆ–å¯¼å…¥å…¶ä»–é…ç½®ç±»

@EnableAutoConfigurationæ˜¯å¯åŠ¨è‡ªåŠ¨é…ç½®çš„å…³é”®ï¼Œæºç å¦‚ä¸‹(å»ºè®®è‡ªå·±æ‰“æ–­ç‚¹è°ƒè¯•ï¼Œèµ°ä¸€éåŸºæœ¬çš„æµç¨‹)ï¼š

```java
import java.lang.annotation.Documented;
import java.lang.annotation.ElementType;
import java.lang.annotation.Inherited;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;
import org.springframework.context.annotation.Import;

@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@AutoConfigurationPackage
@Import({AutoConfigurationImportSelector.class})
public @interface EnableAutoConfiguration {
    String ENABLED_OVERRIDE_PROPERTY = "spring.boot.enableautoconfiguration";

    Class<?>[] exclude() default {};

    String[] excludeName() default {};
}
```

`@EnableAutoConfiguration` æ³¨è§£é€šè¿‡ Spring æä¾›çš„ `@Import `æ³¨è§£å¯¼å…¥äº†`AutoConfigurationImportSelector`ç±»ï¼ˆ`@Import`
æ³¨è§£å¯ä»¥å¯¼å…¥é…ç½®ç±»æˆ–è€… Bean åˆ°å½“å‰ç±»ä¸­ï¼‰ã€‚

`AutoConfigurationImportSelector`ç±»ä¸­`getCandidateConfigurations`æ–¹æ³•ä¼šå°†æ‰€æœ‰è‡ªåŠ¨é…ç½®ç±»çš„ä¿¡æ¯ä»¥` List `çš„å½¢å¼è¿”å›ã€‚è¿™äº›é…ç½®ä¿¡æ¯ä¼šè¢«
Spring å®¹å™¨ä½œ `bean `æ¥ç®¡ç†ã€‚

```java
	protected List<String> getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes) {
		List<String> configurations = SpringFactoriesLoader.loadFactoryNames(getSpringFactoriesLoaderFactoryClass(),
				getBeanClassLoader());
		Assert.notEmpty(configurations, "No auto configuration classes found in META-INF/spring.factories. If you "
				+ "are using a custom packaging, make sure that file is correct.");
		return configurations;
	}
```

è‡ªåŠ¨é…ç½®ä¿¡æ¯æœ‰äº†ï¼Œé‚£ä¹ˆè‡ªåŠ¨é…ç½®è¿˜å·®ä»€ä¹ˆå‘¢ï¼Ÿ

`@Conditional `æ³¨è§£ã€‚`@ConditionalOnClass`(æŒ‡å®šçš„ç±»å¿…é¡»å­˜åœ¨äºç±»è·¯å¾„ä¸‹),`@ConditionalOnBean`(å®¹å™¨ä¸­æ˜¯å¦æœ‰æŒ‡å®šçš„ Bean)
ç­‰ç­‰éƒ½æ˜¯å¯¹`@Conditional`æ³¨è§£çš„æ‰©å±•ã€‚

æ‹¿ Spring Security çš„è‡ªåŠ¨é…ç½®ä¸¾ä¸ªä¾‹å­:`SecurityAutoConfiguration`ä¸­å¯¼å…¥äº†`WebSecurityEnablerConfiguration`
ç±»ï¼Œ`WebSecurityEnablerConfiguration`æºä»£ç å¦‚ä¸‹ï¼š

```java
@Configuration
@ConditionalOnBean(WebSecurityConfigurerAdapter.class)
@ConditionalOnMissingBean(name = BeanIds.SPRING_SECURITY_FILTER_CHAIN)
@ConditionalOnWebApplication(type = ConditionalOnWebApplication.Type.SERVLET)
@EnableWebSecurity
public class WebSecurityEnablerConfiguration {

}
```

`WebSecurityEnablerConfiguration`ç±»ä¸­ä½¿ç”¨`@ConditionalOnBean`æŒ‡å®šäº†å®¹å™¨ä¸­å¿…é¡»è¿˜æœ‰`WebSecurityConfigurerAdapter`
ç±»æˆ–å…¶å®ç°ç±»ã€‚æ‰€ä»¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ Spring Security é…ç½®ç±»éƒ½ä¼šå»å®ç° `WebSecurityConfigurerAdapter`ï¼Œè¿™æ ·è‡ªåŠ¨å°†é…ç½®å°±å®Œæˆäº†ã€‚

##### 9. å¼€å‘ RESTful Web æœåŠ¡å¸¸ç”¨çš„æ³¨è§£æœ‰å“ªäº›ï¼Ÿ

Spring Bean ç›¸å…³ï¼š

- @Autowired : è‡ªåŠ¨å¯¼å…¥å¯¹è±¡åˆ°ç±»ä¸­ï¼Œè¢«æ³¨å…¥è¿›çš„ç±»åŒæ ·è¦è¢« Spring å®¹å™¨ç®¡ç†ã€‚
- @RestController : @RestControlleræ³¨è§£æ˜¯@Controllerå’Œ@ResponseBodyçš„åˆé›†,è¡¨ç¤ºè¿™æ˜¯ä¸ªæ§åˆ¶å™¨ bean,å¹¶ä¸”æ˜¯å°†å‡½æ•°çš„è¿”å›å€¼ç›´
  æ¥å¡«å…¥ HTTP å“åº”ä½“ä¸­,æ˜¯ REST é£æ ¼çš„æ§åˆ¶å™¨ã€‚
- @Component ï¼šé€šç”¨çš„æ³¨è§£ï¼Œå¯æ ‡æ³¨ä»»æ„ç±»ä¸º Spring ç»„ä»¶ã€‚å¦‚æœä¸€ä¸ª Bean ä¸çŸ¥é“å±äºå“ªä¸ªå±‚ï¼Œå¯ä»¥ä½¿ç”¨@Component æ³¨è§£æ ‡æ³¨ã€‚
- @Repository : å¯¹åº”æŒä¹…å±‚å³ Dao å±‚ï¼Œä¸»è¦ç”¨äºæ•°æ®åº“ç›¸å…³æ“ä½œã€‚
- @Service : å¯¹åº”æœåŠ¡å±‚ï¼Œä¸»è¦æ¶‰åŠä¸€äº›å¤æ‚çš„é€»è¾‘ï¼Œéœ€è¦ç”¨åˆ° Dao å±‚ã€‚
- @Controller : å¯¹åº” Spring MVC æ§åˆ¶å±‚ï¼Œä¸»è¦ç”¨äºæ¥å—ç”¨æˆ·è¯·æ±‚å¹¶è°ƒç”¨ Service å±‚è¿”å›æ•°æ®ç»™å‰ç«¯é¡µé¢ã€‚

**å¤„ç†å¸¸è§çš„ HTTP è¯·æ±‚ç±»å‹ï¼š**

- @GetMapping : GET è¯·æ±‚ã€
- @PostMapping : POST è¯·æ±‚ã€‚
- @PutMapping : PUT è¯·æ±‚ã€‚
- @DeleteMapping : DELETE è¯·æ±‚ã€‚

å‰åç«¯ä¼ å€¼ï¼š

- @RequestParamä»¥åŠ@Pathvairable ï¼š@PathVariableç”¨äºè·å–è·¯å¾„å‚æ•°ï¼Œ@RequestParamç”¨äºè·å–æŸ¥è¯¢å‚æ•°ã€‚
- @RequestBody ï¼šç”¨äºè¯»å– Request è¯·æ±‚ï¼ˆå¯èƒ½æ˜¯ POST,PUT,DELETE,GET è¯·æ±‚ï¼‰çš„ body éƒ¨åˆ†å¹¶ä¸” Content-Type ä¸º application/json
  æ ¼å¼çš„æ•°æ®ï¼Œæ¥æ”¶åˆ°æ•°æ®ä¹‹åä¼šè‡ªåŠ¨å°†æ•°æ®ç»‘å®šåˆ° Java å¯¹è±¡ä¸Šå»ã€‚ç³»ç»Ÿä¼šä½¿ç”¨HttpMessageConverteræˆ–è€…è‡ªå®šä¹‰çš„HttpMessageConverterå°†è¯·æ±‚çš„
  body ä¸­çš„ json å­—ç¬¦ä¸²è½¬æ¢ä¸º java å¯¹è±¡ã€‚

è¯¦ç»†ä»‹ç»å¯ä»¥æŸ¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š[ã€ŠSpring/Spring Boot å¸¸ç”¨æ³¨è§£æ€»ç»“ã€‹](https://javaguide.cn/system-design/framework/spring/spring-common-annotations.html) ã€‚

##### 10. Spirng Boot å¸¸ç”¨çš„ä¸¤ç§é…ç½®æ–‡ä»¶

æˆ‘ä»¬å¯ä»¥é€šè¿‡ application.propertiesæˆ–è€… application.yml å¯¹ Spring Boot ç¨‹åºè¿›è¡Œç®€å•çš„é…ç½®ã€‚å¦‚æœï¼Œä½ ä¸è¿›è¡Œé…ç½®çš„è¯ï¼Œå°±æ˜¯ä½¿ç”¨çš„é»˜è®¤é…ç½®ã€‚

##### 11. ä»€ä¹ˆæ˜¯ YAMLï¼ŸYAML é…ç½®çš„ä¼˜åŠ¿åœ¨å“ªé‡Œ ?

YAML æ˜¯ä¸€ç§äººç±»å¯è¯»çš„æ•°æ®åºåˆ—åŒ–è¯­è¨€ã€‚å®ƒé€šå¸¸ç”¨äºé…ç½®æ–‡ä»¶ã€‚ä¸å±æ€§æ–‡ä»¶ç›¸æ¯”ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ å¤æ‚çš„å±æ€§ï¼ŒYAML
æ–‡ä»¶å°±æ›´åŠ ç»“æ„åŒ–ï¼Œè€Œä¸”æ›´å°‘æ··æ·†ã€‚å¯ä»¥çœ‹å‡º YAML å…·æœ‰åˆ†å±‚é…ç½®æ•°æ®ã€‚

ç›¸æ¯”äº Properties é…ç½®çš„æ–¹å¼ï¼ŒYAML é…ç½®çš„æ–¹å¼æ›´åŠ ç›´è§‚æ¸…æ™°ï¼Œç®€ä»‹æ˜äº†ï¼Œæœ‰å±‚æ¬¡æ„Ÿã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/036f4674-44ca-42bb-91d5-9256452e6316.png)

ä½†æ˜¯ï¼ŒYAML é…ç½®çš„æ–¹å¼æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œé‚£å°±æ˜¯ä¸æ”¯æŒ @PropertySource æ³¨è§£å¯¼å…¥è‡ªå®šä¹‰çš„ YAML é…ç½®ã€‚

##### 12. Spring Boot å¸¸ç”¨çš„è¯»å–é…ç½®æ–‡ä»¶çš„æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ

æˆ‘ä»¬è¦è¯»å–çš„é…ç½®æ–‡ä»¶application.yml å†…å®¹å¦‚ä¸‹ï¼š

```yaml
wuhan2020: 2020å¹´åˆæ­¦æ±‰çˆ†å‘äº†æ–°å‹å† çŠ¶ç—…æ¯’ï¼Œç–«æƒ…ä¸¥é‡ï¼Œä½†æ˜¯ï¼Œæˆ‘ç›¸ä¿¡ä¸€åˆ‡éƒ½ä¼šè¿‡å»ï¼æ­¦æ±‰åŠ æ²¹ï¼ä¸­å›½åŠ æ²¹ï¼

my-profile:
  name: Guideå“¥
  email: koushuangbwcx@163.com

library:
  location: æ¹–åŒ—æ­¦æ±‰åŠ æ²¹ä¸­å›½åŠ æ²¹
  books:
    - name: å¤©æ‰åŸºæœ¬æ³•
      description: äºŒåäºŒå²çš„æ—æœå¤•åœ¨çˆ¶äº²ç¡®è¯Šé˜¿å°”èŒ¨æµ·é»˜ç—…è¿™å¤©ï¼Œå¾—çŸ¥è‡ªå·±æš—æ‹å¤šå¹´çš„æ ¡å›­ç”·ç¥è£´ä¹‹å³å°†å‡ºå›½æ·±é€ çš„æ¶ˆæ¯â€”â€”å¯¹æ–¹è€ƒå–çš„å­¦æ ¡ï¼Œæ°æ˜¯çˆ¶äº²å½“å¹´ä¸ºå¥¹æ”¾å¼ƒçš„é‚£æ‰€ã€‚
    - name: æ—¶é—´çš„ç§©åº
      description: ä¸ºä»€ä¹ˆæˆ‘ä»¬è®°å¾—è¿‡å»ï¼Œè€Œéæœªæ¥ï¼Ÿæ—¶é—´â€œæµé€â€æ„å‘³ç€ä»€ä¹ˆï¼Ÿæ˜¯æˆ‘ä»¬å­˜åœ¨äºæ—¶é—´ä¹‹å†…ï¼Œè¿˜æ˜¯æ—¶é—´å­˜åœ¨äºæˆ‘ä»¬ä¹‹ä¸­ï¼Ÿå¡æ´›Â·ç½—éŸ¦åˆ©ç”¨è¯—æ„çš„æ–‡å­—ï¼Œé‚€è¯·æˆ‘ä»¬æ€è€ƒè¿™ä¸€äº˜å¤éš¾é¢˜â€”â€”æ—¶é—´çš„æœ¬è´¨ã€‚
    - name: äº†ä¸èµ·çš„æˆ‘
      description: å¦‚ä½•å…»æˆä¸€ä¸ªæ–°ä¹ æƒ¯ï¼Ÿå¦‚ä½•è®©å¿ƒæ™ºå˜å¾—æ›´æˆç†Ÿï¼Ÿå¦‚ä½•æ‹¥æœ‰é«˜è´¨é‡çš„å…³ç³»ï¼Ÿ å¦‚ä½•èµ°å‡ºäººç”Ÿçš„è‰°éš¾æ—¶åˆ»ï¼Ÿ
```

###### 12.1. é€šè¿‡ @value è¯»å–æ¯”è¾ƒç®€å•çš„é…ç½®ä¿¡æ¯

ä½¿ç”¨ `@Value("${property}") `è¯»å–æ¯”è¾ƒç®€å•çš„é…ç½®ä¿¡æ¯ï¼š

```java
@Value("${wuhan2020}")
String wuhan2020;
```

> **éœ€è¦æ³¨æ„çš„æ˜¯` @value`è¿™ç§æ–¹å¼æ˜¯ä¸è¢«æ¨èçš„ï¼ŒSpring æ¯”è¾ƒå»ºè®®çš„æ˜¯ä¸‹é¢å‡ ç§è¯»å–é…ç½®ä¿¡æ¯çš„æ–¹å¼ã€‚**

###### 12.2. é€šè¿‡@ConfigurationPropertiesè¯»å–å¹¶ä¸ bean ç»‘å®š

> **LibraryProperties ç±»ä¸ŠåŠ äº† `@Component` æ³¨è§£ï¼Œæˆ‘ä»¬å¯ä»¥åƒä½¿ç”¨æ™®é€š bean ä¸€æ ·å°†å…¶æ³¨å…¥åˆ°ç±»ä¸­ä½¿ç”¨ã€‚**

```java
import lombok.Getter;
import lombok.Setter;
import lombok.ToString;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Configuration;
import org.springframework.stereotype.Component;

import java.util.List;

@Component
@ConfigurationProperties(prefix = "library")
@Setter
@Getter
@ToString
class LibraryProperties {
    private String location;
    private List<Book> books;

    @Setter
    @Getter
    @ToString
    static class Book {
        String name;
        String description;
    }
}
```

è¿™ä¸ªæ—¶å€™ä½ å°±å¯ä»¥åƒä½¿ç”¨æ™®é€š bean ä¸€æ ·ï¼Œå°†å…¶æ³¨å…¥åˆ°ç±»ä¸­ä½¿ç”¨ï¼š

```java
package cn.javaguide.readconfigproperties;

import org.springframework.beans.factory.InitializingBean;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

/**
 * @author shuang.kou
 */
@SpringBootApplication
public class ReadConfigPropertiesApplication implements InitializingBean {

    private final LibraryProperties library;

    public ReadConfigPropertiesApplication(LibraryProperties library) {
        this.library = library;
    }

    public static void main(String[] args) {
        SpringApplication.run(ReadConfigPropertiesApplication.class, args);
    }

    @Override
    public void afterPropertiesSet() {
        System.out.println(library.getLocation());
        System.out.println(library.getBooks());    }
}
```

æ§åˆ¶å°è¾“å‡ºï¼š

```
æ¹–åŒ—æ­¦æ±‰åŠ æ²¹ä¸­å›½åŠ æ²¹
[LibraryProperties.Book(name=å¤©æ‰åŸºæœ¬æ³•, description........]
```

###### 12.3. é€šè¿‡@ConfigurationPropertiesè¯»å–å¹¶æ ¡éªŒ

æˆ‘ä»¬å…ˆå°†`application.yml`ä¿®æ”¹ä¸ºå¦‚ä¸‹å†…å®¹ï¼Œæ˜æ˜¾çœ‹å‡ºè¿™ä¸æ˜¯ä¸€ä¸ªæ­£ç¡®çš„ email æ ¼å¼ï¼š

```yaml
my-profile:
  name: Guideå“¥
  email: koushuangbwcx@
```

> **ProfileProperties ç±»æ²¡æœ‰åŠ  @Component æ³¨è§£ã€‚æˆ‘ä»¬åœ¨æˆ‘ä»¬è¦ä½¿ç”¨ProfileProperties
çš„åœ°æ–¹ä½¿ç”¨@EnableConfigurationPropertiesæ³¨å†Œæˆ‘ä»¬çš„é…ç½® beanï¼š**

```java
import lombok.Getter;
import lombok.Setter;
import lombok.ToString;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;
import org.springframework.validation.annotation.Validated;

import javax.validation.constraints.Email;
import javax.validation.constraints.NotEmpty;

/**
* @author shuang.kou
*/
@Getter
@Setter
@ToString
@ConfigurationProperties("my-profile")
@Validated
public class ProfileProperties {
   @NotEmpty
   private String name;

   @Email
   @NotEmpty
   private String email;

   //é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰è¯»å–åˆ°çš„è¯å°±ç”¨é»˜è®¤å€¼
   private Boolean handsome = Boolean.TRUE;

}
```

å…·ä½“ä½¿ç”¨ï¼š

```java
package cn.javaguide.readconfigproperties;

import org.springframework.beans.factory.InitializingBean;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.context.properties.EnableConfigurationProperties;

/**
 * @author shuang.kou
 */
@SpringBootApplication
@EnableConfigurationProperties(ProfileProperties.class)
public class ReadConfigPropertiesApplication implements InitializingBean {
    private final ProfileProperties profileProperties;

    public ReadConfigPropertiesApplication(ProfileProperties profileProperties) {
        this.profileProperties = profileProperties;
    }

    public static void main(String[] args) {
        SpringApplication.run(ReadConfigPropertiesApplication.class, args);
    }

    @Override
    public void afterPropertiesSet() {
        System.out.println(profileProperties.toString());
    }
}
```

å› ä¸ºæˆ‘ä»¬çš„é‚®ç®±æ ¼å¼ä¸æ­£ç¡®ï¼Œæ‰€ä»¥ç¨‹åºè¿è¡Œçš„æ—¶å€™å°±æŠ¥é”™ï¼Œæ ¹æœ¬è¿è¡Œä¸èµ·æ¥ï¼Œä¿è¯äº†æ•°æ®ç±»å‹çš„å®‰å…¨æ€§ï¼š

```
Binding to target org.springframework.boot.context.properties.bind.BindException: Failed to bind properties under 'my-profile' to cn.javaguide.readconfigproperties.ProfileProperties failed:

    Property: my-profile.email
    Value: koushuangbwcx@
    Origin: class path resource [application.yml]:5:10
    Reason: must be a well-formed email address
```

æˆ‘ä»¬æŠŠé‚®ç®±æµ‹è¯•æ”¹ä¸ºæ­£ç¡®çš„ä¹‹åå†è¿è¡Œï¼Œæ§åˆ¶å°å°±èƒ½æˆåŠŸæ‰“å°å‡ºè¯»å–åˆ°çš„ä¿¡æ¯ï¼š

```
ProfileProperties(name=Guideå“¥, email=koushuangbwcx@163.com, handsome=true)
```

###### 12.4. @PropertySourceè¯»å–æŒ‡å®šçš„ properties æ–‡ä»¶

```java
import lombok.Getter;
import lombok.Setter;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.PropertySource;
import org.springframework.stereotype.Component;

@Component
@PropertySource("classpath:website.properties")
@Getter
@Setter
class WebSite {
    @Value("${url}")
    private String url;
}
```

ä½¿ç”¨ï¼š

```java
@Autowired
private WebSite webSite;

System.out.println(webSite.getUrl());//https://javaguide.cn/
```

##### 13. Spring Boot åŠ è½½é…ç½®æ–‡ä»¶çš„ä¼˜å…ˆçº§äº†è§£ä¹ˆï¼Ÿ

Spring è¯»å–é…ç½®æ–‡ä»¶ä¹Ÿæ˜¯æœ‰ä¼˜å…ˆçº§çš„ï¼Œç›´æ¥ä¸Šå›¾ï¼š

![img](é¢è¯•æŒ‡åŒ—.assets/823d9ef9-2f6d-4533-9c31-1ab278115937.jpg)

æ›´å¯¹å†…å®¹è¯·æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-external-config

##### 14. å¸¸ç”¨çš„ Bean æ˜ å°„å·¥å…·æœ‰å“ªäº›ï¼Ÿ

æˆ‘ä»¬ç»å¸¸åœ¨ä»£ç ä¸­ä¼šå¯¹ä¸€ä¸ªæ•°æ®ç»“æ„å°è£…æˆDOã€SDOã€DTOã€VOç­‰ï¼Œè€Œè¿™äº›Beanä¸­çš„å¤§éƒ¨åˆ†å±æ€§éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥ä½¿ç”¨å±æ€§æ‹·è´ç±»å·¥å…·å¯ä»¥å¸®åŠ©æˆ‘ä»¬èŠ‚çœå¤§é‡çš„
set å’Œ get æ“ä½œã€‚

å¸¸ç”¨çš„ Bean æ˜ å°„å·¥å…·æœ‰ï¼šSpring BeanUtilsã€Apache BeanUtilsã€MapStructã€ModelMapperã€Dozerã€Orikaã€JMapper ã€‚

ç”±äº Apache BeanUtils ã€Dozer ã€ModelMapper æ€§èƒ½å¤ªå·®ï¼Œæ‰€ä»¥ä¸å»ºè®®ä½¿ç”¨ã€‚MapStruct æ€§èƒ½æ›´å¥½è€Œä¸”ä½¿ç”¨èµ·æ¥æ¯”è¾ƒçµæ´»ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒä¸é”™çš„é€‰æ‹©ã€‚

##### 15. Spring Boot å¦‚ä½•ç›‘æ§ç³»ç»Ÿå®é™…è¿è¡ŒçŠ¶å†µï¼Ÿ

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Spring Boot Actuator æ¥å¯¹ Spring Boot é¡¹ç›®è¿›è¡Œç®€å•çš„ç›‘æ§ã€‚

```xml

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

é›†æˆäº†è¿™ä¸ªæ¨¡å—ä¹‹åï¼Œä½ çš„ Spring Boot åº”ç”¨ç¨‹åºå°±è‡ªå¸¦äº†ä¸€äº›å¼€ç®±å³ç”¨çš„è·å–ç¨‹åºè¿è¡Œæ—¶çš„å†…éƒ¨çŠ¶æ€ä¿¡æ¯çš„ APIã€‚

æ¯”å¦‚é€šè¿‡ GET æ–¹æ³•è®¿é—® `/health `æ¥å£ï¼Œä½ å°±å¯ä»¥è·å–åº”ç”¨ç¨‹åºçš„å¥åº·æŒ‡æ ‡ã€‚

##### 16. Spring Boot å¦‚ä½•åšè¯·æ±‚å‚æ•°æ ¡éªŒï¼Ÿ

æ•°æ®çš„æ ¡éªŒçš„é‡è¦æ€§å°±ä¸ç”¨è¯´äº†ï¼Œå³ä½¿åœ¨å‰ç«¯å¯¹æ•°æ®è¿›è¡Œæ ¡éªŒçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦å¯¹ä¼ å…¥åç«¯çš„æ•°æ®å†è¿›è¡Œä¸€éæ ¡éªŒï¼Œé¿å…ç”¨æˆ·ç»•è¿‡æµè§ˆå™¨ç›´æ¥é€šè¿‡ä¸€äº›
HTTP å·¥å…·ç›´æ¥å‘åç«¯è¯·æ±‚ä¸€äº›è¿æ³•æ•°æ®ã€‚

Spring Boot ç¨‹åºåšè¯·æ±‚å‚æ•°æ ¡éªŒçš„è¯åªéœ€è¦spring-boot-starter-web ä¾èµ–å°±å¤Ÿäº†ï¼Œå®ƒçš„å­ä¾èµ–åŒ…å«äº†æˆ‘ä»¬æ‰€éœ€è¦çš„ä¸œè¥¿ã€‚

###### 16.1. æ ¡éªŒæ³¨è§£

**JSR æä¾›çš„æ ¡éªŒæ³¨è§£:**

- @Null è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º null
- @NotNull è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸ä¸º null
- @AssertTrue è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º true
- @AssertFalse è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ä¸º false
- @Min(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å¤§äºç­‰äºæŒ‡å®šçš„æœ€å°å€¼
- @Max(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å°äºç­‰äºæŒ‡å®šçš„æœ€å¤§å€¼
- @DecimalMin(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å¤§äºç­‰äºæŒ‡å®šçš„æœ€å°å€¼
- @DecimalMax(value) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»å°äºç­‰äºæŒ‡å®šçš„æœ€å¤§å€¼
- @Size(max=, min=) è¢«æ³¨é‡Šçš„å…ƒç´ çš„å¤§å°å¿…é¡»åœ¨æŒ‡å®šçš„èŒƒå›´å†…
- @Digits (integer, fraction) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶å€¼å¿…é¡»åœ¨å¯æ¥å—çš„èŒƒå›´å†…
- @Past è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªè¿‡å»çš„æ—¥æœŸ
- @Future è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ä¸€ä¸ªå°†æ¥çš„æ—¥æœŸ
- @Pattern(regex=,flag=) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ç¬¦åˆæŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼

**Hibernate Validator æä¾›çš„æ ¡éªŒæ³¨è§£ï¼š**

- @NotBlank(message =) éªŒè¯å­—ç¬¦ä¸²é nullï¼Œä¸”é•¿åº¦å¿…é¡»å¤§äº 0
- @Email è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»æ˜¯ç”µå­é‚®ç®±åœ°å€
- @Length(min=,max=) è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²çš„å¤§å°å¿…é¡»åœ¨æŒ‡å®šçš„èŒƒå›´å†…
- @NotEmpty è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²çš„å¿…é¡»éç©º
- @Range(min=,max=,message=) è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»åœ¨åˆé€‚çš„èŒƒå›´å†…

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class Person {

    @NotNull(message = "classId ä¸èƒ½ä¸ºç©º")
    private String classId;

    @Size(max = 33)
    @NotNull(message = "name ä¸èƒ½ä¸ºç©º")
    private String name;

    @Pattern(regexp = "((^Man$|^Woman$|^UGM$))", message = "sex å€¼ä¸åœ¨å¯é€‰èŒƒå›´")
    @NotNull(message = "sex ä¸èƒ½ä¸ºç©º")
    private String sex;

    @Email(message = "email æ ¼å¼ä¸æ­£ç¡®")
    @NotNull(message = "email ä¸èƒ½ä¸ºç©º")
    private String email;

}
```

###### 16.2. éªŒè¯è¯·æ±‚ä½“(RequestBody)

æˆ‘ä»¬åœ¨éœ€è¦éªŒè¯çš„å‚æ•°ä¸ŠåŠ ä¸Šäº†`@Valid `æ³¨è§£ï¼Œå¦‚æœéªŒè¯å¤±è´¥ï¼Œå®ƒå°†æŠ›å‡º`MethodArgumentNotValidException`ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring
ä¼šå°†æ­¤å¼‚å¸¸è½¬æ¢ä¸º HTTP Status 400ï¼ˆé”™è¯¯è¯·æ±‚ï¼‰ã€‚

```java
@RestController
@RequestMapping("/api")
public class PersonController {

    @PostMapping("/person")
    public ResponseEntity<Person> getPerson(@RequestBody @Valid Person person) {
        return ResponseEntity.ok().body(person);
    }
}
```

###### 16.3. éªŒè¯è¯·æ±‚å‚æ•°(Path Variables å’Œ Request Parameters)

ä¸€å®šä¸€å®šä¸è¦å¿˜è®°åœ¨ç±»ä¸ŠåŠ ä¸Š Validated æ³¨è§£äº†ï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥å‘Šè¯‰ Spring å»æ ¡éªŒæ–¹æ³•å‚æ•°ã€‚

```java
@RestController
@RequestMapping("/api")
@Validated
public class PersonController {

    @GetMapping("/person/{id}")
    public ResponseEntity<Integer> getPersonByID(@Valid @PathVariable("id") @Max(value = 5,message = "è¶…è¿‡ id çš„èŒƒå›´äº†") Integer id) {
        return ResponseEntity.ok().body(id);
    }

    @PutMapping("/person")
    public ResponseEntity<String> getPersonByName(@Valid @RequestParam("name") @Size(max = 6,message = "è¶…è¿‡ name çš„èŒƒå›´äº†") String name) {
        return ResponseEntity.ok().body(name);
    }
}
```

æ›´å¤šå†…å®¹è¯·å‚è€ƒæˆ‘çš„åŸåˆ›ï¼š [å¦‚ä½•åœ¨ Spring/Spring Boot ä¸­åšå‚æ•°æ ¡éªŒï¼Ÿä½ éœ€è¦äº†è§£çš„éƒ½åœ¨è¿™é‡Œï¼](https://javaguide.cn/system-design/framework/spring/spring-common-annotations.html)

##### 17. å¦‚ä½•ä½¿ç”¨ Spring Boot å®ç°å…¨å±€å¼‚å¸¸å¤„ç†ï¼Ÿ

å¯ä»¥ä½¿ç”¨ @ControllerAdvice å’Œ @ExceptionHandler å¤„ç†å…¨å±€å¼‚å¸¸ã€‚

æ›´å¤šå†…å®¹è¯·å‚è€ƒæˆ‘çš„åŸåˆ› ï¼š[Spring Boot å¼‚å¸¸å¤„ç†åœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨](https://snailclimb.gitee.io/springboot-guide/#/./docs/advanced/springboot-handle-exception-plus)

##### 18. Spring Boot ä¸­å¦‚ä½•å®ç°å®šæ—¶ä»»åŠ¡ ?

æˆ‘ä»¬ä½¿ç”¨ @Scheduled æ³¨è§£å°±èƒ½å¾ˆæ–¹ä¾¿åœ°åˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡ã€‚

```java
@Component
public class ScheduledTasks {
    private static final Logger log = LoggerFactory.getLogger(ScheduledTasks.class);
    private static final SimpleDateFormat dateFormat = new SimpleDateFormat("HH:mm:ss");

    /**
     * fixedRateï¼šå›ºå®šé€Ÿç‡æ‰§è¡Œã€‚æ¯5ç§’æ‰§è¡Œä¸€æ¬¡ã€‚
     */
    @Scheduled(fixedRate = 5000)
    public void reportCurrentTimeWithFixedRate() {
        log.info("Current Thread : {}", Thread.currentThread().getName());
        log.info("Fixed Rate Task : The time is now {}", dateFormat.format(new Date()));
    }
}
```

å•çº¯ä¾é  `@Scheduled` æ³¨è§£ è¿˜ä¸è¡Œï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ SpringBoot ä¸­æˆ‘ä»¬åªéœ€è¦åœ¨å¯åŠ¨ç±»ä¸ŠåŠ ä¸Š`@EnableScheduling`
æ³¨è§£ï¼Œè¿™æ ·æ‰å¯ä»¥å¯åŠ¨å®šæ—¶ä»»åŠ¡ã€‚`@EnableScheduling `æ³¨è§£çš„ä½œç”¨æ˜¯å‘ç°æ³¨è§£ `@Scheduled `çš„ä»»åŠ¡å¹¶åœ¨åå°æ‰§è¡Œè¯¥ä»»åŠ¡ã€‚

### **Netty å¸¸è§é¢è¯•é¢˜æ€»ç»“**

å¾ˆå¤šå°ä¼™ä¼´æä¸æ¸…æ¥šä¸ºå•¥è¦å­¦ä¹  Netty ï¼Œæ­£å¼ä»Šå¤©è¿™ç¯‡æ–‡ç« å¼€å§‹ä¹‹å‰ï¼Œç®€å•è¯´ä¸€ä¸‹è‡ªå·±çš„çœ‹æ³•ï¼š

- Netty åŸºäº NIO ï¼ˆNIO æ˜¯ä¸€ç§åŒæ­¥éé˜»å¡çš„ I/O æ¨¡å‹ï¼Œåœ¨ Java 1.4 ä¸­å¼•å…¥äº† NIO ï¼‰ï¼Œä½¿ç”¨ Netty å¯ä»¥æå¤§åœ°ç®€åŒ– TCP å’Œ UDP
  å¥—æ¥å­—æœåŠ¡å™¨ç­‰ç½‘ç»œç¼–ç¨‹ï¼Œå¹¶ä¸”æ€§èƒ½ä»¥åŠå®‰å…¨æ€§ç­‰å¾ˆå¤šæ–¹é¢éƒ½éå¸¸ä¼˜ç§€ã€‚
- æˆ‘ä»¬å¹³å¸¸ç»å¸¸æ¥è§¦çš„ Dubboã€RocketMQã€Elasticsearchã€gRPCã€Spark ç­‰ç­‰çƒ­é—¨å¼€æºé¡¹ç›®éƒ½ç”¨åˆ°äº† Nettyã€‚
- å¤§éƒ¨åˆ†å¾®æœåŠ¡æ¡†æ¶åº•å±‚æ¶‰åŠåˆ°ç½‘ç»œé€šä¿¡çš„éƒ¨åˆ†éƒ½æ˜¯åŸºäº Netty æ¥åšçš„ï¼Œæ¯”å¦‚è¯´ Spring Cloud ç”Ÿæ€ç³»ç»Ÿä¸­çš„ç½‘å…³ Spring Cloud
  Gatewayã€‚

ç®€å•æ€»ç»“ä¸€ä¸‹å’Œ Netty ç›¸å…³é—®é¢˜ã€‚

#### BIO,NIO å’Œ AIO æœ‰å•¥åŒºåˆ«ï¼Ÿ

ğŸ‘¨â€ğŸ’»é¢è¯•å®˜ ï¼šå…ˆæ¥ç®€å•ä»‹ç»ä¸€ä¸‹ BIO,NIO å’Œ AIO 3 è€…çš„åŒºåˆ«å§ï¼

ğŸ™‹ æˆ‘ ï¼šå¥½çš„ï¼

![img](é¢è¯•æŒ‡åŒ—.assets/ca80695a-53b5-48a4-b54d-b2fa021ebc69.png)

- **BIO (Blocking I/O):** åŒæ­¥é˜»å¡ I/O æ¨¡å¼ï¼Œæ•°æ®çš„è¯»å–å†™å…¥å¿…é¡»é˜»å¡åœ¨ä¸€ä¸ªçº¿ç¨‹å†…ç­‰å¾…å…¶å®Œæˆã€‚åœ¨å®¢æˆ·ç«¯è¿æ¥æ•°é‡ä¸é«˜çš„æƒ…å†µä¸‹ï¼Œæ˜¯æ²¡é—®é¢˜çš„ã€‚ä½†æ˜¯ï¼Œå½“é¢å¯¹åä¸‡ç”šè‡³ç™¾ä¸‡çº§è¿æ¥çš„æ—¶å€™ï¼Œä¼ ç»Ÿçš„
  BIO æ¨¡å‹æ˜¯æ— èƒ½ä¸ºåŠ›çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ›´é«˜æ•ˆçš„ I/O å¤„ç†æ¨¡å‹æ¥åº”å¯¹æ›´é«˜çš„å¹¶å‘é‡ã€‚
- **NIO (Non-blocking/New I/O):** NIO æ˜¯ä¸€ç§åŒæ­¥éé˜»å¡çš„ I/O æ¨¡å‹ï¼Œäº Java 1.4 ä¸­å¼•å…¥ï¼Œå¯¹åº” java.nioåŒ…ï¼Œæä¾›äº† Channel ,
  Selectorï¼ŒBuffer ç­‰æŠ½è±¡ã€‚NIO ä¸­çš„ N å¯ä»¥ç†è§£ä¸º Non-blockingï¼Œä¸å•çº¯æ˜¯ Newã€‚å®ƒæ”¯æŒé¢å‘ç¼“å†²çš„ï¼ŒåŸºäºé€šé“çš„ I/O æ“ä½œæ–¹æ³•ã€‚ NIO
  æä¾›äº†ä¸ä¼ ç»Ÿ BIO æ¨¡å‹ä¸­çš„ Socket å’Œ ServerSocket ç›¸å¯¹åº”çš„ SocketChannel å’Œ ServerSocketChannel
  ä¸¤ç§ä¸åŒçš„å¥—æ¥å­—é€šé“å®ç°,ä¸¤ç§é€šé“éƒ½æ”¯æŒé˜»å¡å’Œéé˜»å¡ä¸¤ç§æ¨¡å¼ã€‚å¯¹äºé«˜è´Ÿè½½ã€é«˜å¹¶å‘çš„ï¼ˆç½‘ç»œï¼‰åº”ç”¨ï¼Œåº”ä½¿ç”¨ NIO çš„éé˜»å¡æ¨¡å¼æ¥å¼€å‘
- **AIO (Asynchronous I/O):** AIO ä¹Ÿå°±æ˜¯ NIO 2ã€‚åœ¨ Java 7 ä¸­å¼•å…¥äº† NIO çš„æ”¹è¿›ç‰ˆ NIO 2,å®ƒæ˜¯å¼‚æ­¥éé˜»å¡çš„ IO æ¨¡å‹ã€‚å¼‚æ­¥ IO
  æ˜¯åŸºäºäº‹ä»¶å’Œå›è°ƒæœºåˆ¶å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨æ“ä½œä¹‹åä¼šç›´æ¥è¿”å›ï¼Œä¸ä¼šå µå¡åœ¨é‚£é‡Œï¼Œå½“åå°å¤„ç†å®Œæˆï¼Œæ“ä½œç³»ç»Ÿä¼šé€šçŸ¥ç›¸åº”çš„çº¿ç¨‹è¿›è¡Œåç»­çš„æ“ä½œã€‚AIO
  æ˜¯å¼‚æ­¥ IO çš„ç¼©å†™ï¼Œè™½ç„¶ NIO åœ¨ç½‘ç»œæ“ä½œä¸­ï¼Œæä¾›äº†éé˜»å¡çš„æ–¹æ³•ï¼Œä½†æ˜¯ NIO çš„ IO è¡Œä¸ºè¿˜æ˜¯åŒæ­¥çš„ã€‚å¯¹äº NIO æ¥è¯´ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡çº¿ç¨‹æ˜¯åœ¨
  IO æ“ä½œå‡†å¤‡å¥½æ—¶ï¼Œå¾—åˆ°é€šçŸ¥ï¼Œæ¥ç€å°±ç”±è¿™ä¸ªçº¿ç¨‹è‡ªè¡Œè¿›è¡Œ IO æ“ä½œï¼ŒIO æ“ä½œæœ¬èº«æ˜¯åŒæ­¥çš„ã€‚æŸ¥é˜…ç½‘ä¸Šç›¸å…³èµ„æ–™ï¼Œæˆ‘å‘ç°å°±ç›®å‰æ¥è¯´ AIO
  çš„åº”ç”¨è¿˜ä¸æ˜¯å¾ˆå¹¿æ³›ï¼ŒNetty ä¹‹å‰ä¹Ÿå°è¯•ä½¿ç”¨è¿‡ AIOï¼Œä¸è¿‡åˆæ”¾å¼ƒäº†ã€‚

å…³äº IO
æ¨¡å‹æ›´è¯¦ç»†çš„ä»‹ç»ï¼Œä½ å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š[ã€Šå¸¸è§çš„ IO æ¨¡å‹æœ‰å“ªäº›ï¼ŸJava ä¸­çš„ BIOã€NIOã€AIO æœ‰å•¥åŒºåˆ«ï¼Ÿã€‹](https://javaguide.cn/java/io/io-model.html)
è¿™ç¯‡æ–‡ç« ã€‚

#### Netty æ˜¯ä»€ä¹ˆï¼Ÿ

ğŸ‘¨â€ğŸ’»é¢è¯•å®˜ ï¼šé‚£ä½ å†æ¥ä»‹ç»ä¸€ä¸‹è‡ªå·±å¯¹ Netty çš„è®¤è¯†å§ï¼å°ä¼™å­ã€‚

ğŸ™‹ æˆ‘ ï¼šå¥½çš„ï¼é‚£æˆ‘å°±ç®€å•ç”¨ 3 ç‚¹æ¥æ¦‚æ‹¬ä¸€ä¸‹ Netty å§ï¼

1. Netty æ˜¯ä¸€ä¸ª åŸºäº NIO çš„ client-server(å®¢æˆ·ç«¯æœåŠ¡å™¨)æ¡†æ¶ï¼Œä½¿ç”¨å®ƒå¯ä»¥å¿«é€Ÿç®€å•åœ°å¼€å‘ç½‘ç»œåº”ç”¨ç¨‹åºã€‚
2. å®ƒæå¤§åœ°ç®€åŒ–å¹¶ä¼˜åŒ–äº† TCP å’Œ UDP å¥—æ¥å­—æœåŠ¡å™¨ç­‰ç½‘ç»œç¼–ç¨‹,å¹¶ä¸”æ€§èƒ½ä»¥åŠå®‰å…¨æ€§ç­‰å¾ˆå¤šæ–¹é¢ç”šè‡³éƒ½è¦æ›´å¥½ã€‚
3. æ”¯æŒå¤šç§åè®® å¦‚ FTPï¼ŒSMTPï¼ŒHTTP ä»¥åŠå„ç§äºŒè¿›åˆ¶å’ŒåŸºäºæ–‡æœ¬çš„ä¼ ç»Ÿåè®®ã€‚

ç”¨å®˜æ–¹çš„æ€»ç»“å°±æ˜¯ï¼š**Netty æˆåŠŸåœ°æ‰¾åˆ°äº†ä¸€ç§åœ¨ä¸å¦¥åå¯ç»´æŠ¤æ€§å’Œæ€§èƒ½çš„æƒ…å†µä¸‹å®ç°æ˜“äºå¼€å‘ï¼Œæ€§èƒ½ï¼Œç¨³å®šæ€§å’Œçµæ´»æ€§çš„æ–¹æ³•ã€‚**

ç½‘ç»œç¼–ç¨‹æˆ‘æ„¿æ„ç§°ä¸­ Netty ä¸ºç‹ ã€‚

#### ä¸ºå•¥ä¸ç›´æ¥ç”¨ NIO å‘¢?

ğŸ‘¨â€ğŸ’»é¢è¯•å®˜ ï¼šä½ ä¸Šé¢ä¹Ÿè¯´äº† Netty åŸºäº NIOï¼Œé‚£ä¸ºå•¥ä¸ç›´æ¥ç”¨ NIO å‘¢?ã€‚

ä¸ç”¨ NIO ä¸»è¦æ˜¯å› ä¸º NIO çš„ç¼–ç¨‹æ¨¡å‹å¤æ‚è€Œä¸”å­˜åœ¨ä¸€äº› BUGï¼Œå¹¶ä¸”å¯¹ç¼–ç¨‹åŠŸåº•è¦æ±‚æ¯”è¾ƒé«˜ã€‚ä¸‹å›¾å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä½¿ç”¨ NIO è¿›è¡Œç¼–ç¨‹çš„æ¡ˆä¾‹ï¼š

![img](é¢è¯•æŒ‡åŒ—.assets/65cda835ebfc0909924fc3cdb88099a7.png)

è€Œä¸”ï¼ŒNIO åœ¨é¢å¯¹æ–­è¿é‡è¿ã€åŒ…ä¸¢å¤±ã€ç²˜åŒ…ç­‰é—®é¢˜æ—¶å¤„ç†è¿‡ç¨‹éå¸¸å¤æ‚ã€‚Netty çš„å‡ºç°æ­£æ˜¯ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæ›´å¤šå…³äº Netty çš„ç‰¹ç‚¹å¯ä»¥çœ‹ä¸‹é¢çš„å†…å®¹ã€‚

#### ä¸ºä»€ä¹ˆè¦ç”¨ Nettyï¼Ÿ

ğŸ‘¨â€ğŸ’»é¢è¯•å®˜ ï¼šä¸ºä»€ä¹ˆè¦ç”¨ Netty å‘¢ï¼Ÿèƒ½ä¸èƒ½è¯´ä¸€ä¸‹è‡ªå·±çš„çœ‹æ³•ã€‚

ğŸ™‹ æˆ‘ ï¼šå› ä¸º Netty å…·æœ‰ä¸‹é¢è¿™äº›ä¼˜ç‚¹ï¼Œå¹¶ä¸”ç›¸æ¯”äºç›´æ¥ä½¿ç”¨ JDK è‡ªå¸¦çš„ NIO ç›¸å…³çš„ API æ¥è¯´æ›´åŠ æ˜“ç”¨ã€‚

- ç»Ÿä¸€çš„ APIï¼Œæ”¯æŒå¤šç§ä¼ è¾“ç±»å‹ï¼Œé˜»å¡å’Œéé˜»å¡çš„ã€‚
- ç®€å•è€Œå¼ºå¤§çš„çº¿ç¨‹æ¨¡å‹ã€‚
- è‡ªå¸¦ç¼–è§£ç å™¨è§£å†³ TCP ç²˜åŒ…/æ‹†åŒ…é—®é¢˜ã€‚
- è‡ªå¸¦å„ç§åè®®æ ˆã€‚
- çœŸæ­£çš„æ— è¿æ¥æ•°æ®åŒ…å¥—æ¥å­—æ”¯æŒã€‚
- æ¯”ç›´æ¥ä½¿ç”¨ Java æ ¸å¿ƒ API æœ‰æ›´é«˜çš„ååé‡ã€æ›´ä½çš„å»¶è¿Ÿã€æ›´ä½çš„èµ„æºæ¶ˆè€—å’Œæ›´å°‘çš„å†…å­˜å¤åˆ¶ã€‚
- å®‰å…¨æ€§ä¸é”™ï¼Œæœ‰å®Œæ•´çš„ SSL/TLS ä»¥åŠ StartTLS æ”¯æŒã€‚
- ç¤¾åŒºæ´»è·ƒ
- æˆç†Ÿç¨³å®šï¼Œç»å†äº†å¤§å‹é¡¹ç›®çš„ä½¿ç”¨å’Œè€ƒéªŒï¼Œè€Œä¸”å¾ˆå¤šå¼€æºé¡¹ç›®éƒ½ä½¿ç”¨åˆ°äº† Nettyï¼Œ æ¯”å¦‚æˆ‘ä»¬ç»å¸¸æ¥è§¦çš„ Dubboã€RocketMQ ç­‰ç­‰ã€‚
- ......

#### Netty åº”ç”¨åœºæ™¯äº†è§£ä¹ˆï¼Ÿ

ğŸ‘¨â€ğŸ’»é¢è¯•å®˜ ï¼šèƒ½ä¸èƒ½é€šä¿—åœ°è¯´ä¸€ä¸‹ä½¿ç”¨ Netty å¯ä»¥åšä»€ä¹ˆäº‹æƒ…ï¼Ÿ

ğŸ™‹ æˆ‘ ï¼šå‡­å€Ÿè‡ªå·±çš„äº†è§£ï¼Œç®€å•è¯´ä¸€ä¸‹å§ï¼ç†è®ºä¸Šæ¥è¯´ï¼ŒNIO å¯ä»¥åšçš„äº‹æƒ… ï¼Œä½¿ç”¨ Netty éƒ½å¯ä»¥åšå¹¶ä¸”æ›´å¥½ã€‚Netty ä¸»è¦ç”¨æ¥åšç½‘ç»œé€šä¿¡ :

1. ä½œä¸º RPC æ¡†æ¶çš„ç½‘ç»œé€šä¿¡å·¥å…· ï¼š æˆ‘ä»¬åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸åŒæœåŠ¡èŠ‚ç‚¹ä¹‹é—´ç»å¸¸éœ€è¦ç›¸äº’è°ƒç”¨ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ RPC
   æ¡†æ¶äº†ã€‚ä¸åŒæœåŠ¡èŠ‚ç‚¹çš„é€šä¿¡æ˜¯å¦‚ä½•åšçš„å‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨ Netty æ¥åšã€‚æ¯”å¦‚æˆ‘è°ƒç”¨å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹çš„æ–¹æ³•çš„è¯ï¼Œè‡³å°‘æ˜¯è¦è®©å¯¹æ–¹çŸ¥é“æˆ‘è°ƒç”¨çš„æ˜¯å“ªä¸ªç±»ä¸­çš„å“ªä¸ªæ–¹æ³•ä»¥åŠç›¸å…³å‚æ•°å§ï¼
2. å®ç°ä¸€ä¸ªè‡ªå·±çš„ HTTP æœåŠ¡å™¨ ï¼šé€šè¿‡ Netty æˆ‘ä»¬å¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ªç®€å•çš„ HTTP æœåŠ¡å™¨ï¼Œè¿™ä¸ªå¤§å®¶åº”è¯¥ä¸é™Œç”Ÿã€‚è¯´åˆ° HTTP æœåŠ¡å™¨çš„è¯ï¼Œä½œä¸º
   Java åç«¯å¼€å‘ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨ Tomcat æ¯”è¾ƒå¤šã€‚ä¸€ä¸ªæœ€åŸºæœ¬çš„ HTTP æœåŠ¡å™¨å¯è¦ä»¥å¤„ç†å¸¸è§çš„ HTTP Method çš„è¯·æ±‚ï¼Œæ¯”å¦‚ POST è¯·æ±‚ã€GET
   è¯·æ±‚ç­‰ç­‰ã€‚
3. å®ç°ä¸€ä¸ªå³æ—¶é€šè®¯ç³»ç»Ÿ ï¼š ä½¿ç”¨ Netty æˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªå¯ä»¥èŠå¤©ç±»ä¼¼å¾®ä¿¡çš„å³æ—¶é€šè®¯ç³»ç»Ÿï¼Œè¿™æ–¹é¢çš„å¼€æºé¡¹ç›®è¿˜è›®å¤šçš„ï¼Œå¯ä»¥è‡ªè¡Œå»
   Github æ‰¾ä¸€æ‰¾ã€‚
4. å®ç°æ¶ˆæ¯æ¨é€ç³»ç»Ÿ ï¼šå¸‚é¢ä¸Šæœ‰å¾ˆå¤šæ¶ˆæ¯æ¨é€ç³»ç»Ÿéƒ½æ˜¯åŸºäº Netty æ¥åšçš„ã€‚
5. ......

#### é‚£äº›å¼€æºé¡¹ç›®ç”¨åˆ°äº† Netty?

æˆ‘ä»¬å¹³å¸¸ç»å¸¸æ¥è§¦çš„ Dubboã€RocketMQã€Elasticsearchã€gRPC ç­‰ç­‰éƒ½ç”¨åˆ°äº† Nettyã€‚

å¯ä»¥è¯´å¤§é‡çš„å¼€æºé¡¹ç›®éƒ½ç”¨åˆ°äº† Nettyï¼Œæ‰€ä»¥æŒæ¡ Netty æœ‰åŠ©äºä½ æ›´å¥½çš„ä½¿ç”¨è¿™äº›å¼€æºé¡¹ç›®å¹¶ä¸”è®©ä½ æœ‰èƒ½åŠ›å¯¹å…¶è¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚

å®é™…ä¸Šè¿˜æœ‰å¾ˆå¤šå¾ˆå¤šä¼˜ç§€çš„é¡¹ç›®ç”¨åˆ°äº† Netty,Netty
å®˜æ–¹ä¹Ÿåšäº†ç»Ÿè®¡ï¼Œç»Ÿè®¡ç»“æœåœ¨è¿™é‡Œï¼šhttps://netty.io/wiki/related-projects.html ã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/fcd551063cc03f0b8afb238f6a569fde.png)

#### ä»‹ç»ä¸€ä¸‹ Netty çš„æ ¸å¿ƒç»„ä»¶ï¼Ÿ

ğŸ‘¨â€ğŸ’»é¢è¯•å®˜ ï¼šNetty æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Ÿåˆ†åˆ«æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ

ğŸ™‹ æˆ‘ ï¼šè¡¨é¢ä¸Šï¼Œå˜´ä¸Šå¼€å§‹è¯´èµ· Netty çš„æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Œå®åˆ™ï¼Œå†…å¿ƒå·²ç»å¼€å§‹ mmp äº†ï¼Œæ·±åº¦æ€€ç–‘è¿™é¢è¯•å®˜æ˜¯å­˜å¿ƒææˆ‘å•Šï¼

ç®€å•ä»‹ç» Netty æœ€æ ¸å¿ƒçš„ä¸€äº›ç»„ä»¶ï¼ˆå¯¹äºæ¯ä¸€ä¸ªç»„ä»¶è¿™é‡Œä¸è¯¦ç»†ä»‹ç»ï¼‰ã€‚é€šè¿‡ä¸‹é¢è¿™å¼ å›¾ä½ å¯ä»¥å°†æˆ‘æåˆ°çš„è¿™äº› Netty æ ¸å¿ƒç»„ä»¶ä¸²è”èµ·æ¥ã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/f2f7557a44dbb95963b8ddd6a0960bb9.png)

##### Bytebufï¼ˆå­—èŠ‚å®¹å™¨ï¼‰

**ç½‘ç»œé€šä¿¡æœ€ç»ˆéƒ½æ˜¯é€šè¿‡å­—èŠ‚æµè¿›è¡Œä¼ è¾“çš„ã€‚ ByteBuf å°±æ˜¯ Netty æä¾›çš„ä¸€ä¸ªå­—èŠ‚å®¹å™¨ï¼Œå…¶å†…éƒ¨æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ã€‚** å½“æˆ‘ä»¬é€šè¿‡ Netty
ä¼ è¾“æ•°æ®çš„æ—¶å€™ï¼Œå°±æ˜¯é€šè¿‡ ByteBuf è¿›è¡Œçš„ã€‚

æˆ‘ä»¬å¯ä»¥å°† ByteBuf çœ‹ä½œæ˜¯ Netty å¯¹ Java NIO æä¾›äº† ByteBuffer å­—èŠ‚å®¹å™¨çš„å°è£…å’ŒæŠ½è±¡ã€‚

æœ‰å¾ˆå¤šå°ä¼™ä¼´å¯èƒ½å°±è¦é—®äº† ï¼š **ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ Java NIO æä¾›çš„ ByteBuffer å‘¢ï¼Ÿ**

å› ä¸º ByteBuffer è¿™ä¸ªç±»ä½¿ç”¨èµ·æ¥è¿‡äºå¤æ‚å’Œç¹çã€‚

##### Bootstrap å’Œ ServerBootstrapï¼ˆå¯åŠ¨å¼•å¯¼ç±»ï¼‰

**`Bootstrap `æ˜¯å®¢æˆ·ç«¯çš„å¯åŠ¨å¼•å¯¼ç±»/è¾…åŠ©ç±»**ï¼Œå…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

```java
        EventLoopGroup group = new NioEventLoopGroup();
        try {
            //åˆ›å»ºå®¢æˆ·ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šBootstrap
            Bootstrap b = new Bootstrap();
            //æŒ‡å®šçº¿ç¨‹æ¨¡å‹
            b.group(group).
                    ......
            // å°è¯•å»ºç«‹è¿æ¥
            ChannelFuture f = b.connect(host, port).sync();
            f.channel().closeFuture().sync();
        } finally {
            // ä¼˜é›…å…³é—­ç›¸å…³çº¿ç¨‹ç»„èµ„æº
            group.shutdownGracefully();
        }
```

**`ServerBootstrap` æ˜¯æœåŠ¡ç«¯çš„å¯åŠ¨å¼•å¯¼ç±»/è¾…åŠ©ç±»**ï¼Œå…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

```java
        // 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
        EventLoopGroup bossGroup = new NioEventLoopGroup(1);
        EventLoopGroup workerGroup = new NioEventLoopGroup();
        try {
            //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
            ServerBootstrap b = new ServerBootstrap();
            //3.ç»™å¼•å¯¼ç±»é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„,ç¡®å®šäº†çº¿ç¨‹æ¨¡å‹
            b.group(bossGroup, workerGroup).
                   ......
            // 6.ç»‘å®šç«¯å£
            ChannelFuture f = b.bind(port).sync();
            // ç­‰å¾…è¿æ¥å…³é—­
            f.channel().closeFuture().sync();
        } finally {
            //7.ä¼˜é›…å…³é—­ç›¸å…³çº¿ç¨‹ç»„èµ„æº
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
```

ä»ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š

1. Bootstrap é€šå¸¸ä½¿ç”¨ connect() æ–¹æ³•è¿æ¥åˆ°è¿œç¨‹çš„ä¸»æœºå’Œç«¯å£ï¼Œä½œä¸ºä¸€ä¸ª Netty TCP åè®®é€šä¿¡ä¸­çš„å®¢æˆ·ç«¯ã€‚å¦å¤–ï¼ŒBootstrap ä¹Ÿå¯ä»¥é€šè¿‡
   bind() æ–¹æ³•ç»‘å®šæœ¬åœ°çš„ä¸€ä¸ªç«¯å£ï¼Œä½œä¸º UDP åè®®é€šä¿¡ä¸­çš„ä¸€ç«¯ã€‚
2. ServerBootstrapé€šå¸¸ä½¿ç”¨ bind() æ–¹æ³•ç»‘å®šæœ¬åœ°çš„ç«¯å£ä¸Šï¼Œç„¶åç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ã€‚
3. Bootstrap åªéœ€è¦é…ç½®ä¸€ä¸ªçº¿ç¨‹ç»„â€” EventLoopGroup ,è€Œ ServerBootstrapéœ€è¦é…ç½®ä¸¤ä¸ªçº¿ç¨‹ç»„â€” EventLoopGroup
   ï¼Œä¸€ä¸ªç”¨äºæ¥æ”¶è¿æ¥ï¼Œä¸€ä¸ªç”¨äºå…·ä½“çš„ IO å¤„ç†ã€‚

##### Channelï¼ˆç½‘ç»œæ“ä½œæŠ½è±¡ç±»ï¼‰

`Channel` æ¥å£æ˜¯ Netty å¯¹ç½‘ç»œæ“ä½œæŠ½è±¡ç±»ã€‚é€šè¿‡ `Channel `æˆ‘ä»¬å¯ä»¥è¿›è¡Œ I/O æ“ä½œã€‚

ä¸€æ—¦å®¢æˆ·ç«¯æˆåŠŸè¿æ¥æœåŠ¡ç«¯ï¼Œå°±ä¼šæ–°å»ºä¸€ä¸ª Channel åŒè¯¥ç”¨æˆ·ç«¯è¿›è¡Œç»‘å®šï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
   //  é€šè¿‡ Bootstrap çš„ connect æ–¹æ³•è¿æ¥åˆ°æœåŠ¡ç«¯
   public Channel doConnect(InetSocketAddress inetSocketAddress) {
        CompletableFuture<Channel> completableFuture = new CompletableFuture<>();
        bootstrap.connect(inetSocketAddress).addListener((ChannelFutureListener) future -> {
            if (future.isSuccess()) {
                completableFuture.complete(future.channel());
            } else {
                throw new IllegalStateException();
            }
        });
        return completableFuture.get();
    }
```

æ¯”è¾ƒå¸¸ç”¨çš„`Channel`æ¥å£å®ç°ç±»æ˜¯ ï¼š

- NioServerSocketChannelï¼ˆæœåŠ¡ç«¯ï¼‰
- NioSocketChannelï¼ˆå®¢æˆ·ç«¯ï¼‰

è¿™ä¸¤ä¸ª` Channel `å¯ä»¥å’Œ BIO ç¼–ç¨‹æ¨¡å‹ä¸­çš„`ServerSocket`ä»¥åŠ`Socket`ä¸¤ä¸ªæ¦‚å¿µå¯¹åº”ä¸Šã€‚

##### EventLoopï¼ˆäº‹ä»¶å¾ªç¯ï¼‰

###### EventLoop ä»‹ç»

è¿™ä¹ˆè¯´å§ï¼EventLoopï¼ˆäº‹ä»¶å¾ªç¯ï¼‰æ¥å£å¯ä»¥è¯´æ˜¯ Netty ä¸­æœ€æ ¸å¿ƒçš„æ¦‚å¿µäº†ï¼

ã€ŠNetty å®æˆ˜ã€‹è¿™æœ¬ä¹¦æ˜¯è¿™æ ·ä»‹ç»å®ƒçš„ï¼š

> EventLoop å®šä¹‰äº† Netty çš„æ ¸å¿ƒæŠ½è±¡ï¼Œç”¨äºå¤„ç†è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸä¸­æ‰€å‘ç”Ÿçš„äº‹ä»¶ã€‚

æ˜¯ä¸æ˜¯å¾ˆéš¾ç†è§£ï¼Ÿè¯´å®è¯ï¼Œæˆ‘å­¦ä¹  Netty çš„æ—¶å€™çœ‹åˆ°è¿™å¥è¯æ˜¯æ²¡å¤ªèƒ½ç†è§£çš„ã€‚

è¯´ç™½äº†ï¼Œ**EventLoop çš„ä¸»è¦ä½œç”¨å®é™…å°±æ˜¯è´£ç›‘å¬ç½‘ç»œäº‹ä»¶å¹¶è°ƒç”¨äº‹ä»¶å¤„ç†å™¨è¿›è¡Œç›¸å…³ I/O æ“ä½œï¼ˆè¯»å†™ï¼‰çš„å¤„ç†**ã€‚

###### Channel å’Œ EventLoop çš„å…³ç³»

é‚£ Channel å’Œ EventLoop ç›´æ¥æœ‰å•¥è”ç³»å‘¢ï¼Ÿ

**Channel ä¸º Netty ç½‘ç»œæ“ä½œ(è¯»å†™ç­‰æ“ä½œ)æŠ½è±¡ç±»ï¼ŒEventLoop è´Ÿè´£å¤„ç†æ³¨å†Œåˆ°å…¶ä¸Šçš„Channel çš„ I/O æ“ä½œï¼Œä¸¤è€…é…åˆè¿›è¡Œ I/O æ“ä½œã€‚**

###### EventloopGroup å’Œ EventLoop çš„å…³ç³»

EventLoopGroup åŒ…å«å¤šä¸ª EventLoopï¼ˆæ¯ä¸€ä¸ª EventLoop é€šå¸¸å†…éƒ¨åŒ…å«ä¸€ä¸ªçº¿ç¨‹ï¼‰ï¼Œå®ƒç®¡ç†ç€æ‰€æœ‰çš„ EventLoop çš„ç”Ÿå‘½å‘¨æœŸã€‚

å¹¶ä¸”ï¼Œ**EventLoop å¤„ç†çš„ I/O äº‹ä»¶éƒ½å°†åœ¨å®ƒä¸“æœ‰çš„ Thread ä¸Šè¢«å¤„ç†ï¼Œå³ Thread å’Œ EventLoop å±äº 1 : 1 çš„å…³ç³»ï¼Œä»è€Œä¿è¯çº¿ç¨‹å®‰å…¨
**ã€‚

ä¸‹å›¾æ˜¯ Netty **NIO** æ¨¡å‹å¯¹åº”çš„` EventLoop` æ¨¡å‹ã€‚é€šè¿‡è¿™ä¸ªå›¾åº”è¯¥å¯ä»¥å°†`EventloopGroupã€EventLoopã€ Channel`ä¸‰è€…è”ç³»èµ·æ¥ã€‚

â€‹    ![img](é¢è¯•æŒ‡åŒ—.assets/6e1e15c1448cc2bf5d9c24446f3c515b.png&sign=cc48ba24302d0ef7ab3a604d6ce6e27aec3adb38f07b9adfbf1757299bb3bbe2)

##### **ChannelHandlerï¼ˆæ¶ˆæ¯å¤„ç†å™¨ï¼‰ å’Œ ChannelPipelineï¼ˆChannelHandler å¯¹è±¡é“¾è¡¨ï¼‰**

ä¸‹é¢è¿™æ®µä»£ç ä½¿ç”¨è¿‡ Netty çš„å°ä¼™ä¼´åº”è¯¥ä¸ä¼šé™Œç”Ÿï¼Œæˆ‘ä»¬æŒ‡å®šäº†åºåˆ—åŒ–ç¼–è§£ç å™¨ä»¥åŠè‡ªå®šä¹‰çš„ ChannelHandler å¤„ç†æ¶ˆæ¯ã€‚

```java
        b.group(eventLoopGroup)
                .handler(new ChannelInitializer<SocketChannel>() {
                    @Override
                    protected void initChannel(SocketChannel ch) {
                        ch.pipeline().addLast(new NettyKryoDecoder(kryoSerializer, RpcResponse.class));
                        ch.pipeline().addLast(new NettyKryoEncoder(kryoSerializer, RpcRequest.class));
                        ch.pipeline().addLast(new KryoClientHandler());
                    }
                });
```

**`ChannelHandler `æ˜¯æ¶ˆæ¯çš„å…·ä½“å¤„ç†å™¨ï¼Œä¸»è¦è´Ÿè´£å¤„ç†å®¢æˆ·ç«¯/æœåŠ¡ç«¯æ¥æ”¶å’Œå‘é€çš„æ•°æ®ã€‚**

å½“ Channel è¢«åˆ›å»ºæ—¶ï¼Œå®ƒä¼šè¢«è‡ªåŠ¨åœ°åˆ†é…åˆ°å®ƒä¸“å±çš„ `ChannelPipeline`ã€‚ ä¸€ä¸ª`Channel`
åŒ…å«ä¸€ä¸ª `ChannelPipeline`ã€‚ `ChannelPipeline` ä¸º `ChannelHandler` çš„é“¾ï¼Œä¸€ä¸ª `pipeline `ä¸Šå¯ä»¥æœ‰å¤šä¸ª` ChannelHandler`ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨ `ChannelPipeline `ä¸Šé€šè¿‡ `addLast() `æ–¹æ³•æ·»åŠ ä¸€ä¸ªæˆ–è€…å¤šä¸ª`ChannelHandler `ï¼ˆä¸€ä¸ªæ•°æ®æˆ–è€…äº‹ä»¶å¯èƒ½ä¼šè¢«å¤šä¸ª
Handler å¤„ç†ï¼‰ ã€‚å½“ä¸€ä¸ª `ChannelHandler `å¤„ç†å®Œä¹‹åå°±å°†æ•°æ®äº¤ç»™ä¸‹ä¸€ä¸ª `ChannelHandler `ã€‚

å½“ `ChannelHandler` è¢«æ·»åŠ åˆ°çš„` ChannelPipeline` å®ƒå¾—åˆ°ä¸€ä¸ª `ChannelHandlerContext`ï¼Œå®ƒä»£è¡¨ä¸€ä¸ª `ChannelHandler`
å’Œ `ChannelPipeline `ä¹‹é—´çš„â€œç»‘å®šâ€ã€‚ `ChannelPipeline` é€šè¿‡ `ChannelHandlerContext`æ¥é—´æ¥ç®¡ç† `ChannelHandler` ã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/images(1)-166606199525910)

##### **ChannelFutureï¼ˆæ“ä½œæ‰§è¡Œç»“æœï¼‰**

```java
public interface ChannelFuture extends Future<Void> {
    Channel channel();

    ChannelFuture addListener(GenericFutureListener<? extends Future<? super Void>> var1);
     ......

    ChannelFuture sync() throws InterruptedException;
}
```

Netty ä¸­æ‰€æœ‰çš„ I/O æ“ä½œéƒ½ä¸ºå¼‚æ­¥çš„ï¼Œæˆ‘ä»¬ä¸èƒ½ç«‹åˆ»å¾—åˆ°æ“ä½œæ˜¯å¦æ‰§è¡ŒæˆåŠŸã€‚

ä¸è¿‡ï¼Œä½ å¯ä»¥é€šè¿‡ `ChannelFuture `æ¥å£çš„ `addListener() `æ–¹æ³•æ³¨å†Œä¸€ä¸ª `ChannelFutureListener`ï¼Œå½“æ“ä½œæ‰§è¡ŒæˆåŠŸæˆ–è€…å¤±è´¥æ—¶ï¼Œç›‘å¬å°±ä¼šè‡ªåŠ¨è§¦å‘è¿”å›ç»“æœã€‚

```java
ChannelFuture f = b.connect(host, port).addListener(future -> {
  if (future.isSuccess()) {
    System.out.println("è¿æ¥æˆåŠŸ!");
  } else {
    System.err.println("è¿æ¥å¤±è´¥!");
  }
}).sync();
```

å¹¶ä¸”ï¼Œä½ è¿˜å¯ä»¥é€šè¿‡ChannelFuture çš„ channel() æ–¹æ³•è·å–è¿æ¥ç›¸å…³è”çš„Channel ã€‚

```java
Channel channel = f.channel();
```

å¦å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ ChannelFuture æ¥å£çš„ sync()æ–¹æ³•è®©å¼‚æ­¥çš„æ“ä½œç¼–ç¨‹åŒæ­¥çš„ã€‚

```java
//bind()æ˜¯å¼‚æ­¥çš„ï¼Œä½†æ˜¯ï¼Œä½ å¯ä»¥é€šè¿‡ sync()æ–¹æ³•å°†å…¶å˜ä¸ºåŒæ­¥ã€‚
ChannelFuture f = b.bind(port).sync();
```

#### NioEventLoopGroup é»˜è®¤çš„æ„é€ å‡½æ•°ä¼šèµ·å¤šå°‘çº¿ç¨‹ï¼Ÿ

ğŸ‘¨â€ğŸ’»é¢è¯•å®˜ ï¼šçœ‹è¿‡ Netty çš„æºç äº†ä¹ˆï¼ŸNioEventLoopGroup é»˜è®¤çš„æ„é€ å‡½æ•°ä¼šèµ·å¤šå°‘çº¿ç¨‹å‘¢ï¼Ÿ

ğŸ™‹ æˆ‘ ï¼šå—¯å—¯ï¼çœ‹è¿‡éƒ¨åˆ†ã€‚

å›é¡¾æˆ‘ä»¬åœ¨ä¸Šé¢å†™çš„æœåŠ¡å™¨ç«¯çš„ä»£ç ï¼š

```java
// 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
EventLoopGroup bossGroup = new NioEventLoopGroup(1);
EventLoopGroup workerGroup = new NioEventLoopGroup();
```

ä¸ºäº†ææ¸…æ¥š`NioEventLoopGroup `é»˜è®¤çš„æ„é€ å‡½æ•° åˆ°åº•åˆ›å»ºäº†å¤šå°‘ä¸ªçº¿ç¨‹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„æºç ã€‚

```java
    /**
     * æ— å‚æ„é€ å‡½æ•°ã€‚
     * nThreads:0
     */
    public NioEventLoopGroup() {
        //è°ƒç”¨ä¸‹ä¸€ä¸ªæ„é€ æ–¹æ³•
        this(0);
    }

    /**
     * Executorï¼šnull
     */
    public NioEventLoopGroup(int nThreads) {
        //ç»§ç»­è°ƒç”¨ä¸‹ä¸€ä¸ªæ„é€ æ–¹æ³•
        this(nThreads, (Executor) null);
    }

    //ä¸­é—´çœç•¥éƒ¨åˆ†æ„é€ å‡½æ•°

    /**
     * RejectedExecutionHandlerï¼ˆï¼‰ï¼šRejectedExecutionHandlers.reject()
     */
    public NioEventLoopGroup(int nThreads, Executor executor, final SelectorProvider selectorProvider,final SelectStrategyFactory selectStrategyFactory) {
       //å¼€å§‹è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°
        super(nThreads, executor, selectorProvider, selectStrategyFactory, RejectedExecutionHandlers.reject());
    }
```

ä¸€ç›´å‘ä¸‹èµ°ä¸‹å»çš„è¯ï¼Œä½ ä¼šå‘ç°åœ¨ `MultithreadEventLoopGroup` ç±»ä¸­æœ‰ç›¸å…³çš„æŒ‡å®šçº¿ç¨‹æ•°çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š

```java
    // ä»1ï¼Œç³»ç»Ÿå±æ€§ï¼ŒCPUæ ¸å¿ƒæ•°*2 è¿™ä¸‰ä¸ªå€¼ä¸­å–å‡ºä¸€ä¸ªæœ€å¤§çš„
    //å¯ä»¥å¾—å‡º DEFAULT_EVENT_LOOP_THREADS çš„å€¼ä¸ºCPUæ ¸å¿ƒæ•°*2
    private static final int DEFAULT_EVENT_LOOP_THREADS = Math.max(1, SystemPropertyUtil.getInt("io.netty.eventLoopThreads", NettyRuntime.availableProcessors() * 2));

    // è¢«è°ƒç”¨çš„çˆ¶ç±»æ„é€ å‡½æ•°ï¼ŒNioEventLoopGroup é»˜è®¤çš„æ„é€ å‡½æ•°ä¼šèµ·å¤šå°‘çº¿ç¨‹çš„ç§˜å¯†æ‰€åœ¨
    // å½“æŒ‡å®šçš„çº¿ç¨‹æ•°nThreadsä¸º0æ—¶ï¼Œä½¿ç”¨é»˜è®¤çš„çº¿ç¨‹æ•°DEFAULT_EVENT_LOOP_THREADS
    protected MultithreadEventLoopGroup(int nThreads, ThreadFactory threadFactory, Object... args) {
        super(nThreads == 0 ? DEFAULT_EVENT_LOOP_THREADS : nThreads, threadFactory, args);
    }
```

ç»¼ä¸Šï¼Œæˆ‘ä»¬å‘ç° `NioEventLoopGroup` é»˜è®¤çš„æ„é€ å‡½æ•°å®é™…ä¼šèµ·çš„çº¿ç¨‹æ•°ä¸º **CPUæ ¸å¿ƒæ•°*2**ã€‚

å¦å¤–ï¼Œå¦‚æœä½ ç»§ç»­æ·±å…¥ä¸‹å»çœ‹æ„é€ å‡½æ•°çš„è¯ï¼Œä½ ä¼šå‘ç°æ¯ä¸ª`NioEventLoopGroup`å¯¹è±¡å†…éƒ¨éƒ½ä¼šåˆ†é…ä¸€ç»„`NioEventLoop`
ï¼Œå…¶å¤§å°æ˜¯` nThreads`, è¿™æ ·å°±æ„æˆäº†ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œ ä¸€ä¸ª`NIOEventLoop `å’Œä¸€ä¸ªçº¿ç¨‹ç›¸å¯¹åº”ï¼Œè¿™å’Œæˆ‘ä»¬ä¸Šé¢è¯´çš„` EventloopGroup `
å’Œ `EventLoop`å…³ç³»è¿™éƒ¨åˆ†å†…å®¹ç›¸å¯¹åº”ã€‚

#### Reactor çº¿ç¨‹æ¨¡å‹

ğŸ‘¨â€ğŸ’»é¢è¯•å®˜ ï¼šå¤§éƒ¨åˆ†ç½‘ç»œæ¡†æ¶éƒ½æ˜¯åŸºäº Reactor æ¨¡å¼è®¾è®¡å¼€å‘çš„ã€‚ä½ å…ˆèŠèŠ Reactor çº¿ç¨‹æ¨¡å‹å§ï¼

ğŸ™‹ æˆ‘ ï¼šå¥½çš„å‘€ï¼

Reactor æ˜¯ä¸€ç§ç»å…¸çš„çº¿ç¨‹æ¨¡å‹ï¼ŒReactor æ¨¡å¼åŸºäºäº‹ä»¶é©±åŠ¨ï¼Œç‰¹åˆ«é€‚åˆå¤„ç†æµ·é‡çš„ I/O äº‹ä»¶ã€‚

Reactor çº¿ç¨‹æ¨¡å‹åˆ†ä¸ºå•çº¿ç¨‹æ¨¡å‹ã€å¤šçº¿ç¨‹æ¨¡å‹ä»¥åŠä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹ã€‚

> ä»¥ä¸‹å›¾ç‰‡æ¥æºäºç½‘ç»œï¼ŒåŸå‡ºå¤„ä¸æ˜ï¼Œå¦‚æœ‰ä¾µæƒè¯·è”ç³»æˆ‘ã€‚

##### å•çº¿ç¨‹ Reactor

æ‰€æœ‰çš„ IO æ“ä½œéƒ½ç”±åŒä¸€ä¸ª NIO çº¿ç¨‹å¤„ç†ã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/e5493f74f5ed16c462c36654170e16ae.png)

**å•çº¿ç¨‹ Reactor çš„ä¼˜ç‚¹æ˜¯å¯¹ç³»ç»Ÿèµ„æºæ¶ˆè€—ç‰¹åˆ«å°ï¼Œä½†æ˜¯ï¼Œæ²¡åŠæ³•æ”¯æ’‘å¤§é‡è¯·æ±‚çš„åº”ç”¨åœºæ™¯å¹¶ä¸”å¤„ç†è¯·æ±‚çš„æ—¶é—´å¯èƒ½éå¸¸æ…¢ï¼Œæ¯•ç«Ÿåªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œå˜›ï¼æ‰€ä»¥ï¼Œä¸€èˆ¬å®é™…é¡¹ç›®ä¸­ä¸ä¼šä½¿ç”¨å•çº¿ç¨‹
Reactor ã€‚**

ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæ¼”è¿›å‡ºäº† Reactor å¤šçº¿ç¨‹æ¨¡å‹ã€‚

##### å¤šçº¿ç¨‹ Reactor

ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£æ¥å—è¯·æ±‚,ä¸€ç»„ NIO çº¿ç¨‹å¤„ç† IO
æ“ä½œ![img](é¢è¯•æŒ‡åŒ—.assets/0e694ecd1399d78b8983f22fc0e2341e.png)
**å¤§éƒ¨åˆ†åœºæ™¯ä¸‹å¤šçº¿ç¨‹ Reactor æ¨¡å‹æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯åœ¨ä¸€äº›å¹¶å‘è¿æ¥æ•°æ¯”è¾ƒå¤šï¼ˆå¦‚ç™¾ä¸‡å¹¶å‘ï¼‰çš„åœºæ™¯ä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹è´Ÿè´£æ¥å—å®¢æˆ·ç«¯è¯·æ±‚å°±å­˜åœ¨æ€§èƒ½é—®é¢˜äº†ã€‚
**

ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæ¼”è¿›å‡ºäº†ä¸»ä»å¤šçº¿ç¨‹ Reactor æ¨¡å‹ã€‚

##### ä¸»ä»å¤šçº¿ç¨‹ Reactor

ä¸€ç»„ NIO çº¿ç¨‹è´Ÿè´£æ¥å—è¯·æ±‚ï¼Œä¸€ç»„ NIO çº¿ç¨‹å¤„ç† IO æ“ä½œã€‚

![img](é¢è¯•æŒ‡åŒ—.assets/4059d7d2e2d73b876774ce7e55cc819c.png)

#### Netty çº¿ç¨‹æ¨¡å‹äº†è§£ä¹ˆï¼Ÿ

ğŸ‘¨â€ğŸ’»é¢è¯•å®˜ ï¼šè¯´ä¸€ä¸‹ Netty çº¿ç¨‹æ¨¡å‹å§ï¼

ğŸ™‹ æˆ‘ ï¼šå¤§éƒ¨åˆ†ç½‘ç»œæ¡†æ¶éƒ½æ˜¯åŸºäº Reactor æ¨¡å¼è®¾è®¡å¼€å‘çš„ã€‚

> Reactor æ¨¡å¼åŸºäºäº‹ä»¶é©±åŠ¨ï¼Œé‡‡ç”¨å¤šè·¯å¤ç”¨å°†äº‹ä»¶åˆ†å‘ç»™ç›¸åº”çš„ Handler å¤„ç†ï¼Œéå¸¸é€‚åˆå¤„ç†æµ·é‡ IO çš„åœºæ™¯ã€‚

åœ¨ Netty ä¸»è¦é  `NioEventLoopGroup` çº¿ç¨‹æ± æ¥å®ç°å…·ä½“çš„çº¿ç¨‹æ¨¡å‹çš„ ã€‚

æˆ‘ä»¬å®ç°æœåŠ¡ç«¯çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šåˆå§‹åŒ–ä¸¤ä¸ªçº¿ç¨‹ç»„ï¼š

1. **bossGroup :**æ¥æ”¶è¿æ¥ã€‚
2. **workerGroup ï¼š**è´Ÿè´£å…·ä½“çš„å¤„ç†ï¼Œäº¤ç”±å¯¹åº”çš„ Handler å¤„ç†ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸€ä¸‹ Netty ä¸­çš„çº¿ç¨‹æ¨¡å‹å§ï¼

##### å•çº¿ç¨‹æ¨¡å‹

ä¸€ä¸ªçº¿ç¨‹éœ€è¦æ‰§è¡Œå¤„ç†æ‰€æœ‰çš„ `acceptã€readã€decodeã€processã€encodeã€send` äº‹ä»¶ã€‚å¯¹äºé«˜è´Ÿè½½ã€é«˜å¹¶å‘ï¼Œå¹¶ä¸”å¯¹æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜çš„åœºæ™¯ä¸é€‚ç”¨ã€‚

å¯¹åº”åˆ° Netty ä»£ç æ˜¯ä¸‹é¢è¿™æ ·çš„

> ä½¿ç”¨ NioEventLoopGroup ç±»çš„æ— å‚æ„é€ å‡½æ•°è®¾ç½®çº¿ç¨‹æ•°é‡çš„é»˜è®¤å€¼å°±æ˜¯ **CPU æ ¸å¿ƒæ•° *2** ã€‚

```java
  //1.eventGroupæ—¢ç”¨äºå¤„ç†å®¢æˆ·ç«¯è¿æ¥ï¼Œåˆè´Ÿè´£å…·ä½“çš„å¤„ç†ã€‚
  EventLoopGroup eventGroup = new NioEventLoopGroup(1);
  //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
  ServerBootstrap b = new ServerBootstrap();
            boobtstrap.group(eventGroup, eventGroup)
            //......
```

##### å¤šçº¿ç¨‹æ¨¡å‹

ä¸€ä¸ª Acceptor çº¿ç¨‹åªè´Ÿè´£ç›‘å¬å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œä¸€ä¸ª NIO çº¿ç¨‹æ± è´Ÿè´£å…·ä½“å¤„ç†ï¼š acceptã€readã€decodeã€processã€encodeã€send
äº‹ä»¶ã€‚æ»¡è¶³ç»å¤§éƒ¨åˆ†åº”ç”¨åœºæ™¯ï¼Œå¹¶å‘è¿æ¥é‡ä¸å¤§çš„æ—¶å€™æ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯é‡åˆ°å¹¶å‘è¿æ¥å¤§çš„æ—¶å€™å°±å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚

å¯¹åº”åˆ° Netty ä»£ç æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

```java
// 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
EventLoopGroup bossGroup = new NioEventLoopGroup(1);
EventLoopGroup workerGroup = new NioEventLoopGroup();
try {
  //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
  ServerBootstrap b = new ServerBootstrap();
  //3.ç»™å¼•å¯¼ç±»é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„,ç¡®å®šäº†çº¿ç¨‹æ¨¡å‹
  b.group(bossGroup, workerGroup)
    //......
```

![img](é¢è¯•æŒ‡åŒ—.assets/d142a1cd-45b5-446c-96fd-9627c4f7741c.png)

##### ä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹

ä»ä¸€ä¸ª ä¸»çº¿ç¨‹ NIO çº¿ç¨‹æ± ä¸­é€‰æ‹©ä¸€ä¸ªçº¿ç¨‹ä½œä¸º Acceptor çº¿ç¨‹ï¼Œç»‘å®šç›‘å¬ç«¯å£ï¼Œæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥çš„è¿æ¥ï¼Œå…¶ä»–çº¿ç¨‹è´Ÿè´£åç»­çš„æ¥å…¥è®¤è¯ç­‰å·¥ä½œã€‚è¿æ¥å»ºç«‹å®Œæˆåï¼ŒSub
NIO çº¿ç¨‹æ± è´Ÿè´£å…·ä½“å¤„ç† I/O è¯»å†™ã€‚å¦‚æœå¤šçº¿ç¨‹æ¨¡å‹æ— æ³•æ»¡è¶³ä½ çš„éœ€æ±‚çš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹ ã€‚

```java
// 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
EventLoopGroup bossGroup = new NioEventLoopGroup();
EventLoopGroup workerGroup = new NioEventLoopGroup();
try {
  //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
  ServerBootstrap b = new ServerBootstrap();
  //3.ç»™å¼•å¯¼ç±»é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„,ç¡®å®šäº†çº¿ç¨‹æ¨¡å‹
  b.group(bossGroup, workerGroup)
    //......
```

![img](é¢è¯•æŒ‡åŒ—.assets/a1b38b45-dc8b-4af7-9053-92df542f2179.png)

#### Netty æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å¯åŠ¨è¿‡ç¨‹äº†è§£ä¹ˆï¼Ÿ

##### æœåŠ¡ç«¯

```java
        // 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
        EventLoopGroup bossGroup = new NioEventLoopGroup(1);
        EventLoopGroup workerGroup = new NioEventLoopGroup();
        try {
            //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
            ServerBootstrap b = new ServerBootstrap();
            //3.ç»™å¼•å¯¼ç±»é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„,ç¡®å®šäº†çº¿ç¨‹æ¨¡å‹
            b.group(bossGroup, workerGroup)
                    // (éå¿…å¤‡)æ‰“å°æ—¥å¿—
                    .handler(new LoggingHandler(LogLevel.INFO))
                    // 4.æŒ‡å®š IO æ¨¡å‹
                    .channel(NioServerSocketChannel.class)
                    .childHandler(new ChannelInitializer<SocketChannel>() {
                        @Override
                        public void initChannel(SocketChannel ch) {
                            ChannelPipeline p = ch.pipeline();
                            //5.å¯ä»¥è‡ªå®šä¹‰å®¢æˆ·ç«¯æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†é€»è¾‘
                            p.addLast(new HelloServerHandler());
                        }
                    });
            // 6.ç»‘å®šç«¯å£,è°ƒç”¨ sync æ–¹æ³•é˜»å¡çŸ¥é“ç»‘å®šå®Œæˆ
            ChannelFuture f = b.bind(port).sync();
            // 7.é˜»å¡ç­‰å¾…ç›´åˆ°æœåŠ¡å™¨Channelå…³é—­(closeFuture()æ–¹æ³•è·å–Channel çš„CloseFutureå¯¹è±¡,ç„¶åè°ƒç”¨sync()æ–¹æ³•)
            f.channel().closeFuture().sync();
        } finally {
            //8.ä¼˜é›…å…³é—­ç›¸å…³çº¿ç¨‹ç»„èµ„æº
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
```

ç®€å•è§£æä¸€ä¸‹æœåŠ¡ç«¯çš„åˆ›å»ºè¿‡ç¨‹å…·ä½“æ˜¯æ€æ ·çš„ï¼š

1.é¦–å…ˆä½ åˆ›å»ºäº†ä¸¤ä¸ª NioEventLoopGroup å¯¹è±¡å®ä¾‹ï¼šbossGroup å’Œ workerGroupã€‚

- bossGroup : ç”¨äºå¤„ç†å®¢æˆ·ç«¯çš„ TCP è¿æ¥è¯·æ±‚ã€‚
- workerGroup ï¼š è´Ÿè´£æ¯ä¸€æ¡è¿æ¥çš„å…·ä½“è¯»å†™æ•°æ®çš„å¤„ç†é€»è¾‘ï¼ŒçœŸæ­£è´Ÿè´£ I/O è¯»å†™æ“ä½œï¼Œäº¤ç”±å¯¹åº”çš„ Handler å¤„ç†ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬æŠŠå…¬å¸çš„è€æ¿å½“åš bossGroupï¼Œå‘˜å·¥å½“åš workerGroupï¼ŒbossGroup åœ¨å¤–é¢æ¥å®Œæ´»ä¹‹åï¼Œæ‰”ç»™ workerGroup å»å¤„ç†ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šæŒ‡å®š
bossGroup çš„ çº¿ç¨‹æ•°ä¸º 1ï¼ˆå¹¶å‘è¿æ¥é‡ä¸å¤§çš„æ—¶å€™ï¼‰ ï¼ŒworkGroup çš„çº¿ç¨‹æ•°é‡ä¸º **CPU æ ¸å¿ƒæ•° *2** ã€‚å¦å¤–ï¼Œæ ¹æ®æºç æ¥çœ‹ï¼Œä½¿ç”¨
NioEventLoopGroup ç±»çš„æ— å‚æ„é€ å‡½æ•°è®¾ç½®çº¿ç¨‹æ•°é‡çš„é»˜è®¤å€¼å°±æ˜¯ **CPU æ ¸å¿ƒæ•° *2** ã€‚

2.æ¥ä¸‹æ¥ æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼š ServerBootstrapï¼Œè¿™ä¸ªç±»å°†å¼•å¯¼æˆ‘ä»¬è¿›è¡ŒæœåŠ¡ç«¯çš„å¯åŠ¨å·¥ä½œã€‚

3.é€šè¿‡ .group() æ–¹æ³•ç»™å¼•å¯¼ç±» ServerBootstrap é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„ï¼Œç¡®å®šäº†çº¿ç¨‹æ¨¡å‹ã€‚

é€šè¿‡ä¸‹é¢çš„ä»£ç ï¼Œæˆ‘ä»¬å®é™…é…ç½®çš„æ˜¯å¤šçº¿ç¨‹æ¨¡å‹ï¼Œè¿™ä¸ªåœ¨ä¸Šé¢æåˆ°è¿‡ã€‚

```java
    EventLoopGroup bossGroup = new NioEventLoopGroup(1);
    EventLoopGroup workerGroup = new NioEventLoopGroup();
```

4.é€šè¿‡channel()æ–¹æ³•ç»™å¼•å¯¼ç±» ServerBootstrapæŒ‡å®šäº† IO æ¨¡å‹ä¸ºNIO

- NioServerSocketChannel ï¼šæŒ‡å®šæœåŠ¡ç«¯çš„ IO æ¨¡å‹ä¸º NIOï¼Œä¸ BIO ç¼–ç¨‹æ¨¡å‹ä¸­çš„ServerSocketå¯¹åº”
- NioSocketChannel : æŒ‡å®šå®¢æˆ·ç«¯çš„ IO æ¨¡å‹ä¸º NIOï¼Œ ä¸ BIO ç¼–ç¨‹æ¨¡å‹ä¸­çš„Socketå¯¹åº”

5.é€šè¿‡ .childHandler()ç»™å¼•å¯¼ç±»åˆ›å»ºä¸€ä¸ªChannelInitializer ï¼Œç„¶åæŒ‡å®šäº†æœåŠ¡ç«¯æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†é€»è¾‘ HelloServerHandlerå¯¹è±¡

6.è°ƒç”¨ ServerBootstrap ç±»çš„ bind()æ–¹æ³•ç»‘å®šç«¯å£

##### å®¢æˆ·ç«¯

```java
        //1.åˆ›å»ºä¸€ä¸ª NioEventLoopGroup å¯¹è±¡å®ä¾‹
        EventLoopGroup group = new NioEventLoopGroup();
        try {
            //2.åˆ›å»ºå®¢æˆ·ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šBootstrap
            Bootstrap b = new Bootstrap();
            //3.æŒ‡å®šçº¿ç¨‹ç»„
            b.group(group)
                    //4.æŒ‡å®š IO æ¨¡å‹
                    .channel(NioSocketChannel.class)
                    .handler(new ChannelInitializer<SocketChannel>() {
                        @Override
                        public void initChannel(SocketChannel ch) throws Exception {
                            ChannelPipeline p = ch.pipeline();
                            // 5.è¿™é‡Œå¯ä»¥è‡ªå®šä¹‰æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†é€»è¾‘
                            p.addLast(new HelloClientHandler(message));
                        }
                    });
            // 6.å°è¯•å»ºç«‹è¿æ¥
            ChannelFuture f = b.connect(host, port).sync();
            // 7.ç­‰å¾…è¿æ¥å…³é—­ï¼ˆé˜»å¡ï¼Œç›´åˆ°Channelå…³é—­ï¼‰
            f.channel().closeFuture().sync();
        } finally {
            group.shutdownGracefully();
        }
```

ç»§ç»­åˆ†æä¸€ä¸‹å®¢æˆ·ç«¯çš„åˆ›å»ºæµç¨‹ï¼š

1.åˆ›å»ºä¸€ä¸ª NioEventLoopGroup å¯¹è±¡å®ä¾‹

2.åˆ›å»ºå®¢æˆ·ç«¯å¯åŠ¨çš„å¼•å¯¼ç±»æ˜¯ Bootstrap

3.é€šè¿‡ .group() æ–¹æ³•ç»™å¼•å¯¼ç±» Bootstrap é…ç½®ä¸€ä¸ªçº¿ç¨‹ç»„

4.é€šè¿‡channel()æ–¹æ³•ç»™å¼•å¯¼ç±» BootstrapæŒ‡å®šäº† IO æ¨¡å‹ä¸ºNIO

5.é€šè¿‡ .childHandler()ç»™å¼•å¯¼ç±»åˆ›å»ºä¸€ä¸ªChannelInitializer ï¼Œç„¶åæŒ‡å®šäº†å®¢æˆ·ç«¯æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†é€»è¾‘ HelloClientHandler å¯¹è±¡

6.è°ƒç”¨ Bootstrap ç±»çš„ connect()æ–¹æ³•è¿›è¡Œè¿æ¥ï¼Œè¿™ä¸ªæ–¹æ³•éœ€è¦æŒ‡å®šä¸¤ä¸ªå‚æ•°ï¼š

- inetHost : ip åœ°å€
- inetPort : ç«¯å£å·

```java
    public ChannelFuture connect(String inetHost, int inetPort) {
        return this.connect(InetSocketAddress.createUnresolved(inetHost, inetPort));
    }
    public ChannelFuture connect(SocketAddress remoteAddress) {
        ObjectUtil.checkNotNull(remoteAddress, "remoteAddress");
        this.validate();
        return this.doResolveAndConnect(remoteAddress, this.config.localAddress());
    }
```

`connect` æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª `Future` ç±»å‹çš„å¯¹è±¡

```java
public interface ChannelFuture extends Future<Void> {
  ......
}
```

ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ–¹æ˜¯å¼‚æ­¥çš„ï¼Œæˆ‘ä»¬é€šè¿‡ `addListener` æ–¹æ³•å¯ä»¥ç›‘å¬åˆ°è¿æ¥æ˜¯å¦æˆåŠŸï¼Œè¿›è€Œæ‰“å°å‡ºè¿æ¥ä¿¡æ¯ã€‚å…·ä½“åšæ³•å¾ˆç®€å•ï¼Œåªéœ€è¦å¯¹ä»£ç è¿›è¡Œä»¥ä¸‹æ”¹åŠ¨ï¼š

```java
ChannelFuture f = b.connect(host, port).addListener(future -> {
  if (future.isSuccess()) {
    System.out.println("è¿æ¥æˆåŠŸ!");
  } else {
    System.err.println("è¿æ¥å¤±è´¥!");
  }
}).sync();
```

#### ä»€ä¹ˆæ˜¯ TCP ç²˜åŒ…/æ‹†åŒ…?æœ‰ä»€ä¹ˆè§£å†³åŠæ³•å‘¢ï¼Ÿ

ğŸ‘¨â€ğŸ’»é¢è¯•å®˜ ï¼šä»€ä¹ˆæ˜¯ TCP ç²˜åŒ…/æ‹†åŒ…?

ğŸ™‹ æˆ‘ ï¼šTCP ç²˜åŒ…/æ‹†åŒ… å°±æ˜¯ä½ åŸºäº TCP å‘é€æ•°æ®çš„æ—¶å€™ï¼Œå‡ºç°äº†å¤šä¸ªå­—ç¬¦ä¸²â€œç²˜â€åœ¨äº†ä¸€èµ·æˆ–è€…ä¸€ä¸ªå­—ç¬¦ä¸²è¢«â€œæ‹†â€å¼€çš„é—®é¢˜ã€‚æ¯”å¦‚ä½ å¤šæ¬¡å‘é€ï¼šâ€œä½ å¥½,ä½ çœŸå¸…å•Šï¼å“¥å“¥ï¼â€ï¼Œä½†æ˜¯å®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„å¯èƒ½æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

![img](é¢è¯•æŒ‡åŒ—.assets/54e900aa-bf51-41dd-8673-c21eae472f2f.png)

ğŸ‘¨â€ğŸ’»é¢è¯•å®˜ ï¼šé‚£æœ‰ä»€ä¹ˆè§£å†³åŠæ³•å‘¢?

ğŸ™‹ æˆ‘ ï¼š

**1.ä½¿ç”¨ Netty è‡ªå¸¦çš„è§£ç å™¨**

- LineBasedFrameDecoder : å‘é€ç«¯å‘é€æ•°æ®åŒ…çš„æ—¶å€™ï¼Œæ¯ä¸ªæ•°æ®åŒ…ä¹‹é—´ä»¥æ¢è¡Œç¬¦ä½œä¸ºåˆ†éš”ï¼ŒLineBasedFrameDecoder çš„å·¥ä½œåŸç†æ˜¯å®ƒä¾æ¬¡éå†
  ByteBuf ä¸­çš„å¯è¯»å­—èŠ‚ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ¢è¡Œç¬¦ï¼Œç„¶åè¿›è¡Œç›¸åº”çš„æˆªå–ã€‚
- DelimiterBasedFrameDecoder : å¯ä»¥è‡ªå®šä¹‰åˆ†éš”ç¬¦è§£ç å™¨ï¼ŒLineBasedFrameDecoder å®é™…ä¸Šæ˜¯ä¸€ç§ç‰¹æ®Šçš„
  DelimiterBasedFrameDecoder è§£ç å™¨ã€‚
- FixedLengthFrameDecoder: å›ºå®šé•¿åº¦è§£ç å™¨ï¼Œå®ƒèƒ½å¤ŸæŒ‰ç…§æŒ‡å®šçš„é•¿åº¦å¯¹æ¶ˆæ¯è¿›è¡Œç›¸åº”çš„æ‹†åŒ…ã€‚å¦‚æœä¸å¤ŸæŒ‡å®šçš„é•¿åº¦ï¼Œåˆ™ç©ºæ ¼è¡¥å…¨
- LengthFieldBasedFrameDecoderï¼šåŸºäºé•¿åº¦å­—æ®µçš„è§£ç å™¨ï¼Œå‘é€çš„æ•°æ®ä¸­æœ‰æ•°æ®é•¿åº¦ç›¸å…³çš„ä¿¡æ¯ã€‚

**2.è‡ªå®šä¹‰åºåˆ—åŒ–ç¼–è§£ç å™¨**

åœ¨ Java ä¸­è‡ªå¸¦çš„æœ‰å®ç° Serializable æ¥å£æ¥å®ç°åºåˆ—åŒ–ï¼Œä½†ç”±äºå®ƒæ€§èƒ½ã€å®‰å…¨æ€§ç­‰åŸå› ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸ä¼šè¢«ä½¿ç”¨åˆ°çš„ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ Protostuffã€Hessian2ã€json åºåˆ—æ–¹å¼æ¯”è¾ƒå¤šï¼Œå¦å¤–è¿˜æœ‰ä¸€äº›åºåˆ—åŒ–æ€§èƒ½éå¸¸å¥½çš„åºåˆ—åŒ–æ–¹å¼ä¹Ÿæ˜¯å¾ˆå¥½çš„é€‰æ‹©ï¼š

- ä¸“é—¨é’ˆå¯¹ Java è¯­è¨€çš„ï¼šKryoï¼ŒFST ç­‰ç­‰
- è·¨è¯­è¨€çš„ï¼šProtostuffï¼ˆåŸºäº protobuf å‘å±•è€Œæ¥ï¼‰ï¼ŒProtoBufï¼ŒThriftï¼ŒAvroï¼ŒMsgPack ç­‰ç­‰

> ç”±äºç¯‡å¹…é—®é¢˜ï¼Œè¿™éƒ¨åˆ†å†…å®¹ä¼šåœ¨åç»­çš„æ–‡ç« ä¸­è¯¦ç»†åˆ†æä»‹ç»~~~

#### Netty é•¿è¿æ¥ã€å¿ƒè·³æœºåˆ¶äº†è§£ä¹ˆï¼Ÿ

ğŸ‘¨â€ğŸ’»é¢è¯•å®˜ ï¼šTCP é•¿è¿æ¥å’ŒçŸ­è¿æ¥äº†è§£ä¹ˆï¼Ÿ

ğŸ™‹ æˆ‘ ï¼šæˆ‘ä»¬çŸ¥é“ TCP åœ¨è¿›è¡Œè¯»å†™ä¹‹å‰ï¼Œserver ä¸ client
ä¹‹é—´å¿…é¡»æå‰å»ºç«‹ä¸€ä¸ªè¿æ¥ã€‚å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ï¼Œéœ€è¦æˆ‘ä»¬å¸¸è¯´çš„ä¸‰æ¬¡æ¡æ‰‹ï¼Œé‡Šæ”¾/å…³é—­è¿æ¥çš„è¯éœ€è¦å››æ¬¡æŒ¥æ‰‹ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯æ¯”è¾ƒæ¶ˆè€—ç½‘ç»œèµ„æºå¹¶ä¸”æœ‰æ—¶é—´å»¶è¿Ÿçš„ã€‚

æ‰€è°“ï¼ŒçŸ­è¿æ¥è¯´çš„å°±æ˜¯ server ç«¯ ä¸ client
ç«¯å»ºç«‹è¿æ¥ä¹‹åï¼Œè¯»å†™å®Œæˆä¹‹åå°±å…³é—­æ‰è¿æ¥ï¼Œå¦‚æœä¸‹ä¸€æ¬¡å†è¦äº’ç›¸å‘é€æ¶ˆæ¯ï¼Œå°±è¦é‡æ–°è¿æ¥ã€‚çŸ­è¿æ¥çš„ä¼˜ç‚¹å¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯ç®¡ç†å’Œå®ç°éƒ½æ¯”è¾ƒç®€å•ï¼Œç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œæ¯ä¸€æ¬¡çš„è¯»å†™éƒ½è¦å»ºç«‹è¿æ¥å¿…ç„¶ä¼šå¸¦æ¥å¤§é‡ç½‘ç»œèµ„æºçš„æ¶ˆè€—ï¼Œå¹¶ä¸”è¿æ¥çš„å»ºç«‹ä¹Ÿéœ€è¦è€—è´¹æ—¶é—´ã€‚

é•¿è¿æ¥è¯´çš„å°±æ˜¯ client å‘ server åŒæ–¹å»ºç«‹è¿æ¥ä¹‹åï¼Œå³ä½¿ client ä¸ server
å®Œæˆä¸€æ¬¡è¯»å†™ï¼Œå®ƒä»¬ä¹‹é—´çš„è¿æ¥å¹¶ä¸ä¼šä¸»åŠ¨å…³é—­ï¼Œåç»­çš„è¯»å†™æ“ä½œä¼šç»§ç»­ä½¿ç”¨è¿™ä¸ªè¿æ¥ã€‚é•¿è¿æ¥çš„å¯ä»¥çœå»è¾ƒå¤šçš„ TCP
å»ºç«‹å’Œå…³é—­çš„æ“ä½œï¼Œé™ä½å¯¹ç½‘ç»œèµ„æºçš„ä¾èµ–ï¼ŒèŠ‚çº¦æ—¶é—´ã€‚å¯¹äºé¢‘ç¹è¯·æ±‚èµ„æºçš„å®¢æˆ·æ¥è¯´ï¼Œéå¸¸é€‚ç”¨é•¿è¿æ¥ã€‚

ğŸ‘¨â€ğŸ’»é¢è¯•å®˜ ï¼šä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³æœºåˆ¶ï¼ŸNetty ä¸­å¿ƒè·³æœºåˆ¶äº†è§£ä¹ˆï¼Ÿ

ğŸ™‹ æˆ‘ ï¼š

åœ¨ TCP ä¿æŒé•¿è¿æ¥çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°æ–­ç½‘ç­‰ç½‘ç»œå¼‚å¸¸å‡ºç°ï¼Œå¼‚å¸¸å‘ç”Ÿçš„æ—¶å€™ï¼Œ client ä¸ server
ä¹‹é—´å¦‚æœæ²¡æœ‰äº¤äº’çš„è¯ï¼Œå®ƒä»¬æ˜¯æ— æ³•å‘ç°å¯¹æ–¹å·²ç»æ‰çº¿çš„ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜, æˆ‘ä»¬å°±éœ€è¦å¼•å…¥ **å¿ƒè·³æœºåˆ¶** ã€‚

å¿ƒè·³æœºåˆ¶çš„å·¥ä½œåŸç†æ˜¯: åœ¨ client ä¸ server ä¹‹é—´åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ•°æ®äº¤äº’æ—¶, å³å¤„äº idle çŠ¶æ€æ—¶, å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨å°±ä¼šå‘é€ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®åŒ…ç»™å¯¹æ–¹,
å½“æ¥æ”¶æ–¹æ”¶åˆ°è¿™ä¸ªæ•°æ®æŠ¥æ–‡å, ä¹Ÿç«‹å³å‘é€ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®æŠ¥æ–‡, å›åº”å‘é€æ–¹, æ­¤å³ä¸€ä¸ª PING-PONG äº¤äº’ã€‚æ‰€ä»¥, å½“æŸä¸€ç«¯æ”¶åˆ°å¿ƒè·³æ¶ˆæ¯å,
å°±çŸ¥é“äº†å¯¹æ–¹ä»ç„¶åœ¨çº¿, è¿™å°±ç¡®ä¿ TCP è¿æ¥çš„æœ‰æ•ˆæ€§.

TCP å®é™…ä¸Šè‡ªå¸¦çš„å°±æœ‰é•¿è¿æ¥é€‰é¡¹ï¼Œæœ¬èº«æ˜¯ä¹Ÿæœ‰å¿ƒè·³åŒ…æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯ TCP çš„é€‰é¡¹ï¼šSO_KEEPALIVEã€‚ ä½†æ˜¯ï¼ŒTCP
åè®®å±‚é¢çš„é•¿è¿æ¥çµæ´»æ€§ä¸å¤Ÿã€‚æ‰€ä»¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬éƒ½æ˜¯åœ¨åº”ç”¨å±‚åè®®ä¸Šå®ç°è‡ªå®šä¹‰å¿ƒè·³æœºåˆ¶çš„ï¼Œä¹Ÿå°±æ˜¯åœ¨ Netty å±‚é¢é€šè¿‡ç¼–ç å®ç°ã€‚é€šè¿‡
Netty å®ç°å¿ƒè·³æœºåˆ¶çš„è¯ï¼Œæ ¸å¿ƒç±»æ˜¯ IdleStateHandler ã€‚

#### Netty çš„é›¶æ‹·è´äº†è§£ä¹ˆï¼Ÿ

ğŸ‘¨â€ğŸ’»é¢è¯•å®˜ ï¼šè®²è®² Netty çš„é›¶æ‹·è´ï¼Ÿ

ğŸ™‹ æˆ‘ ï¼š

ç»´åŸºç™¾ç§‘æ˜¯è¿™æ ·ä»‹ç»é›¶æ‹·è´çš„ï¼š

> é›¶å¤åˆ¶ï¼ˆè‹±è¯­ï¼šZero-copyï¼›ä¹Ÿè¯‘é›¶æ‹·è´ï¼‰æŠ€æœ¯æ˜¯æŒ‡è®¡ç®—æœºæ‰§è¡Œæ“ä½œæ—¶ï¼ŒCPU ä¸éœ€è¦å…ˆå°†æ•°æ®ä»æŸå¤„å†…å­˜å¤åˆ¶åˆ°å¦ä¸€ä¸ªç‰¹å®šåŒºåŸŸã€‚è¿™ç§æŠ€æœ¯é€šå¸¸ç”¨äºé€šè¿‡ç½‘ç»œä¼ è¾“æ–‡ä»¶æ—¶èŠ‚çœ
> CPU å‘¨æœŸå’Œå†…å­˜å¸¦å®½ã€‚

åœ¨ OS å±‚é¢ä¸Šçš„ Zero-copy é€šå¸¸æŒ‡é¿å…åœ¨ ç”¨æˆ·æ€(User-space) ä¸ å†…æ ¸æ€(Kernel-space) ä¹‹é—´æ¥å›æ‹·è´æ•°æ®ã€‚è€Œåœ¨ Netty å±‚é¢
ï¼Œé›¶æ‹·è´ä¸»è¦ä½“ç°åœ¨å¯¹äºæ•°æ®æ“ä½œçš„ä¼˜åŒ–ã€‚

Netty ä¸­çš„é›¶æ‹·è´ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢

1. ä½¿ç”¨ Netty æä¾›çš„ CompositeByteBuf ç±», å¯ä»¥å°†å¤šä¸ªByteBuf åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ ByteBuf, é¿å…äº†å„ä¸ª ByteBuf ä¹‹é—´çš„æ‹·è´ã€‚
2. ByteBuf æ”¯æŒ slice æ“ä½œ, å› æ­¤å¯ä»¥å°† ByteBuf åˆ†è§£ä¸ºå¤šä¸ªå…±äº«åŒä¸€ä¸ªå­˜å‚¨åŒºåŸŸçš„ ByteBuf, é¿å…äº†å†…å­˜çš„æ‹·è´ã€‚
3. é€šè¿‡ FileRegion åŒ…è£…çš„FileChannel.tranferTo å®ç°æ–‡ä»¶ä¼ è¾“, å¯ä»¥ç›´æ¥å°†æ–‡ä»¶ç¼“å†²åŒºçš„æ•°æ®å‘é€åˆ°ç›®æ ‡ Channel, é¿å…äº†ä¼ ç»Ÿé€šè¿‡å¾ªç¯
   write æ–¹å¼å¯¼è‡´çš„å†…å­˜æ‹·è´é—®é¢˜.

#### å‚è€ƒ

- netty å­¦ä¹ ç³»åˆ—äºŒï¼šNIO Reactor æ¨¡å‹ & Netty çº¿ç¨‹æ¨¡å‹ï¼šhttps://www.jianshu.com/p/38b56531565d
- ã€ŠNetty å®æˆ˜ã€‹
- Netty é¢è¯•é¢˜æ•´ç†(2):https://metatronxl.github.io/2019/10/22/Netty-é¢è¯•é¢˜æ•´ç†-äºŒ/
- Nettyï¼ˆ3ï¼‰â€”æºç  NioEventLoopGroup:https://www.cnblogs.com/qdhxhz/p/10075568.html
- å¯¹äº Netty ByteBuf çš„é›¶æ‹·è´(Zero Copy) çš„ç†è§£: https://www.cnblogs.com/xys1228/p/6088805.html
